/**
 * ============================================================================
 * 509 DASHBOARD - CONSOLIDATED BUILD
 * ============================================================================
 *
 * This file is AUTO-GENERATED by build.js
 * DO NOT EDIT THIS FILE DIRECTLY
 *
 * To make changes:
 * 1. Edit individual module files (e.g., Constants.gs, Code.gs)
 * 2. Run: node build.js
 * 3. This file will be regenerated automatically
 *
 * Build Info:
 * - Version: 2.0.0 (Unknown)
 * - Build ID: unknown
 * - Build Date: 2025-12-28T20:48:52.086Z
 * - Build Type: DEVELOPMENT
 * - Modules: 80 files
 * - Tests Included: Yes
 *
 * ============================================================================
 */


// ================================================================================
// MODULE: Constants.gs
// Source: Constants.gs
// ================================================================================

/**
 * 509 Dashboard - Constants and Configuration
 *
 * Single source of truth for all configuration constants.
 * This file must be loaded first in the build order.
 *
 * @version 1.0.0
 * @license Free for use by non-profit collective bargaining groups and unions
 */

// ============================================================================
// SHEET NAMES
// ============================================================================

/**
 * Sheet name constants - use these instead of hardcoded strings
 * @const {Object}
 */
var SHEETS = {
  CONFIG: 'Config',
  MEMBER_DIR: 'Member Directory',
  GRIEVANCE_LOG: 'Grievance Log',
  // Dashboard sheets
  DASHBOARD: 'ğŸ’¼ Dashboard',
  INTERACTIVE: 'ğŸ¯ Interactive',
  // Hidden calculation sheets (self-healing formulas)
  GRIEVANCE_CALC: '_Grievance_Calc',
  GRIEVANCE_FORMULAS: '_Grievance_Formulas',
  MEMBER_LOOKUP: '_Member_Lookup',
  STEWARD_CONTACT_CALC: '_Steward_Contact_Calc',
  DASHBOARD_CALC: '_Dashboard_Calc',
  // Optional source sheets
  MEETING_ATTENDANCE: 'ğŸ“… Meeting Attendance',
  VOLUNTEER_HOURS: 'ğŸ¤ Volunteer Hours',
  // Test Results
  TEST_RESULTS: 'Test Results'
};

// ============================================================================
// COLOR SCHEME
// ============================================================================

/**
 * Color scheme constants for consistent branding
 * @const {Object}
 */
var COLORS = {
  PRIMARY_PURPLE: '#7C3AED',    // Main brand purple
  UNION_GREEN: '#059669',       // Union/success green
  SOLIDARITY_RED: '#DC2626',    // Alert/urgent red
  PRIMARY_BLUE: '#7EC8E3',      // Light blue
  ACCENT_ORANGE: '#F97316',     // Warnings/attention
  LIGHT_GRAY: '#F3F4F6',        // Backgrounds
  TEXT_DARK: '#1F2937',         // Primary text
  WHITE: '#FFFFFF',             // White
  HEADER_BG: '#7C3AED',         // Header background (same as primary)
  HEADER_TEXT: '#FFFFFF'        // Header text color
};

// ============================================================================
// MEMBER DIRECTORY COLUMNS (31 columns total: A-AE)
// ============================================================================

/**
 * Member Directory column positions (1-indexed)
 * CRITICAL: ALL column references must use these constants
 * @const {Object}
 */
var MEMBER_COLS = {
  // Section 1: Identity & Core Info (A-D)
  MEMBER_ID: 1,                    // A
  FIRST_NAME: 2,                   // B
  LAST_NAME: 3,                    // C
  JOB_TITLE: 4,                    // D

  // Section 2: Location & Work (E-G)
  WORK_LOCATION: 5,                // E
  UNIT: 6,                         // F
  OFFICE_DAYS: 7,                  // G - Multi-select: days member works in office

  // Section 3: Contact Information (H-K)
  EMAIL: 8,                        // H
  PHONE: 9,                        // I
  PREFERRED_COMM: 10,              // J - Multi-select: preferred communication methods
  BEST_TIME: 11,                   // K - Multi-select: best times to reach member

  // Section 4: Organizational Structure (L-P)
  SUPERVISOR: 12,                  // L
  MANAGER: 13,                     // M
  IS_STEWARD: 14,                  // N
  COMMITTEES: 15,                  // O - Multi-select: which committees steward is in
  ASSIGNED_STEWARD: 16,            // P - Multi-select: assigned steward(s)

  // Section 5: Engagement Metrics (Q-T) - Hidden by default
  LAST_VIRTUAL_MTG: 17,            // Q
  LAST_INPERSON_MTG: 18,           // R
  OPEN_RATE: 19,                   // S
  VOLUNTEER_HOURS: 20,             // T

  // Section 6: Member Interests (U-X) - Hidden by default
  INTEREST_LOCAL: 21,              // U
  INTEREST_CHAPTER: 22,            // V
  INTEREST_ALLIED: 23,             // W
  HOME_TOWN: 24,                   // X - Connection building

  // Section 7: Steward Contact Tracking (Y-AA)
  RECENT_CONTACT_DATE: 25,         // Y
  CONTACT_STEWARD: 26,             // Z
  CONTACT_NOTES: 27,               // AA

  // Section 8: Grievance Management (AB-AE)
  HAS_OPEN_GRIEVANCE: 28,          // AB - Script-calculated (static value)
  GRIEVANCE_STATUS: 29,            // AC - Script-calculated (static value)
  NEXT_DEADLINE: 30,               // AD - Script-calculated (static value)
  START_GRIEVANCE: 31,             // AE - Checkbox to start grievance

  // ALIASES - For backward compatibility
  LOCATION: 5,                     // Alias for WORK_LOCATION
  DAYS_TO_DEADLINE: 30             // Alias for NEXT_DEADLINE
};

// ============================================================================
// GRIEVANCE LOG COLUMNS (34 columns total: A-AH)
// ============================================================================

/**
 * Grievance Log column positions (1-indexed)
 * CRITICAL: ALL column references must use these constants
 * @const {Object}
 */
var GRIEVANCE_COLS = {
  // Section 1: Identity (A-D)
  GRIEVANCE_ID: 1,        // A - Grievance ID
  MEMBER_ID: 2,           // B - Member ID
  FIRST_NAME: 3,          // C - First Name
  LAST_NAME: 4,           // D - Last Name

  // Section 2: Status & Assignment (E-F)
  STATUS: 5,              // E - Status
  CURRENT_STEP: 6,        // F - Current Step

  // Section 3: Timeline - Filing (G-I)
  INCIDENT_DATE: 7,       // G - Incident Date
  FILING_DEADLINE: 8,     // H - Filing Deadline (21d) (auto-calc)
  DATE_FILED: 9,          // I - Date Filed (Step I)

  // Section 4: Timeline - Step I (J-K)
  STEP1_DUE: 10,          // J - Step I Decision Due (30d) (auto-calc)
  STEP1_RCVD: 11,         // K - Step I Decision Rcvd

  // Section 5: Timeline - Step II (L-O)
  STEP2_APPEAL_DUE: 12,   // L - Step II Appeal Due (10d) (auto-calc)
  STEP2_APPEAL_FILED: 13, // M - Step II Appeal Filed
  STEP2_DUE: 14,          // N - Step II Decision Due (30d) (auto-calc)
  STEP2_RCVD: 15,         // O - Step II Decision Rcvd

  // Section 6: Timeline - Step III (P-R)
  STEP3_APPEAL_DUE: 16,   // P - Step III Appeal Due (30d) (auto-calc)
  STEP3_APPEAL_FILED: 17, // Q - Step III Appeal Filed
  DATE_CLOSED: 18,        // R - Date Closed

  // Section 7: Calculated Metrics (S-U)
  DAYS_OPEN: 19,          // S - Days Open (auto-calc)
  NEXT_ACTION_DUE: 20,    // T - Next Action Due (auto-calc)
  DAYS_TO_DEADLINE: 21,   // U - Days to Deadline (auto-calc)

  // Section 8: Case Details (V-W)
  ARTICLES: 22,           // V - Articles Violated
  ISSUE_CATEGORY: 23,     // W - Issue Category

  // Section 9: Contact & Location (X-AA)
  MEMBER_EMAIL: 24,       // X - Member Email
  UNIT: 25,               // Y - Unit
  LOCATION: 26,           // Z - Work Location (Site)
  STEWARD: 27,            // AA - Assigned Steward (Name)

  // Section 10: Resolution (AB)
  RESOLUTION: 28,         // AB - Resolution Summary

  // Section 11: Coordinator Notifications (AC-AF)
  MESSAGE_ALERT: 29,      // AC - Message Alert checkbox
  COORDINATOR_MESSAGE: 30,// AD - Coordinator's message text
  ACKNOWLEDGED_BY: 31,    // AE - Steward who acknowledged
  ACKNOWLEDGED_DATE: 32,  // AF - When steward acknowledged

  // Section 12: Drive Integration (AG-AH)
  DRIVE_FOLDER_ID: 33,    // AG - Google Drive folder ID
  DRIVE_FOLDER_URL: 34    // AH - Google Drive folder URL
};

// ============================================================================
// CONFIG COLUMN MAPPING
// ============================================================================

/**
 * Config sheet column positions for dropdown sources
 * @const {Object}
 */
var CONFIG_COLS = {
  // â”€â”€ EMPLOYMENT INFO â”€â”€ (A-E)
  JOB_TITLES: 1,              // A
  OFFICE_LOCATIONS: 2,        // B
  UNITS: 3,                   // C
  OFFICE_DAYS: 4,             // D
  YES_NO: 5,                  // E

  // â”€â”€ SUPERVISION â”€â”€ (F-G)
  SUPERVISORS: 6,             // F
  MANAGERS: 7,                // G

  // â”€â”€ STEWARD INFO â”€â”€ (H-I)
  STEWARDS: 8,                // H
  STEWARD_COMMITTEES: 9,      // I

  // â”€â”€ GRIEVANCE SETTINGS â”€â”€ (J-M)
  GRIEVANCE_STATUS: 10,       // J
  GRIEVANCE_STEP: 11,         // K
  ISSUE_CATEGORY: 12,         // L
  ARTICLES: 13,               // M

  // â”€â”€ LINKS & COORDINATORS â”€â”€ (N-Q)
  COMM_METHODS: 14,           // N
  GRIEVANCE_COORDINATORS: 15, // O
  GRIEVANCE_FORM_URL: 16,     // P
  CONTACT_FORM_URL: 17,       // Q

  // â”€â”€ NOTIFICATIONS â”€â”€ (R-S)
  ADMIN_EMAILS: 18,           // R
  ALERT_DAYS: 19,             // S
  NOTIFICATION_RECIPIENTS: 20, // T

  // â”€â”€ ORGANIZATION â”€â”€ (U-X)
  ORG_NAME: 21,               // U
  LOCAL_NUMBER: 22,           // V
  MAIN_ADDRESS: 23,           // W
  MAIN_PHONE: 24,             // X

  // â”€â”€ INTEGRATION â”€â”€ (Y-Z)
  DRIVE_FOLDER_ID: 25,        // Y
  CALENDAR_ID: 26,            // Z

  // â”€â”€ DEADLINES â”€â”€ (AA-AD)
  FILING_DEADLINE_DAYS: 27,   // AA
  STEP1_RESPONSE_DAYS: 28,    // AB
  STEP2_APPEAL_DAYS: 29,      // AC
  STEP2_RESPONSE_DAYS: 30,    // AD

  // â”€â”€ MULTI-SELECT OPTIONS â”€â”€ (AE-AF)
  BEST_TIMES: 31,             // AE
  HOME_TOWNS: 32,             // AF

  // â”€â”€ CONTRACT & LEGAL â”€â”€ (AG-AJ)
  CONTRACT_GRIEVANCE: 33,     // AG
  CONTRACT_DISCIPLINE: 34,    // AH
  CONTRACT_WORKLOAD: 35,      // AI
  CONTRACT_NAME: 36,          // AJ

  // â”€â”€ ORG IDENTITY â”€â”€ (AK-AM)
  UNION_PARENT: 37,           // AK
  STATE_REGION: 38,           // AL
  ORG_WEBSITE: 39,            // AM

  // â”€â”€ EXTENDED CONTACT â”€â”€ (AN-AQ)
  OFFICE_ADDRESSES: 40,       // AN
  MAIN_FAX: 41,               // AO
  MAIN_CONTACT_NAME: 42,      // AP
  MAIN_CONTACT_EMAIL: 43      // AQ
};

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Convert column number to letter notation (e.g., 1 -> A, 27 -> AA)
 * @param {number} columnNumber - Column number (1-indexed)
 * @returns {string} Column letter(s)
 */
function getColumnLetter(columnNumber) {
  var letter = '';
  while (columnNumber > 0) {
    var remainder = (columnNumber - 1) % 26;
    letter = String.fromCharCode(65 + remainder) + letter;
    columnNumber = Math.floor((columnNumber - 1) / 26);
  }
  return letter;
}

/**
 * Convert column letter to number (e.g., A -> 1, AA -> 27)
 * @param {string} columnLetter - Column letter(s)
 * @returns {number} Column number (1-indexed)
 */
function getColumnNumber(columnLetter) {
  var result = 0;
  for (var i = 0; i < columnLetter.length; i++) {
    result = result * 26 + (columnLetter.charCodeAt(i) - 64);
  }
  return result;
}

/**
 * Map a Member Directory row array to a structured object
 * @param {Array} row - Row data array from Member Directory
 * @returns {Object} Structured member object
 */
function mapMemberRow(row) {
  return {
    memberId: row[MEMBER_COLS.MEMBER_ID - 1] || '',
    firstName: row[MEMBER_COLS.FIRST_NAME - 1] || '',
    lastName: row[MEMBER_COLS.LAST_NAME - 1] || '',
    fullName: (row[MEMBER_COLS.FIRST_NAME - 1] || '') + ' ' + (row[MEMBER_COLS.LAST_NAME - 1] || ''),
    jobTitle: row[MEMBER_COLS.JOB_TITLE - 1] || '',
    workLocation: row[MEMBER_COLS.WORK_LOCATION - 1] || '',
    unit: row[MEMBER_COLS.UNIT - 1] || '',
    officeDays: row[MEMBER_COLS.OFFICE_DAYS - 1] || '',
    email: row[MEMBER_COLS.EMAIL - 1] || '',
    phone: row[MEMBER_COLS.PHONE - 1] || '',
    preferredComm: row[MEMBER_COLS.PREFERRED_COMM - 1] || '',
    bestTime: row[MEMBER_COLS.BEST_TIME - 1] || '',
    supervisor: row[MEMBER_COLS.SUPERVISOR - 1] || '',
    manager: row[MEMBER_COLS.MANAGER - 1] || '',
    isSteward: row[MEMBER_COLS.IS_STEWARD - 1] || '',
    committees: row[MEMBER_COLS.COMMITTEES - 1] || '',
    assignedSteward: row[MEMBER_COLS.ASSIGNED_STEWARD - 1] || '',
    lastVirtualMtg: row[MEMBER_COLS.LAST_VIRTUAL_MTG - 1] || '',
    lastInPersonMtg: row[MEMBER_COLS.LAST_INPERSON_MTG - 1] || '',
    openRate: row[MEMBER_COLS.OPEN_RATE - 1] || '',
    volunteerHours: row[MEMBER_COLS.VOLUNTEER_HOURS - 1] || '',
    interestLocal: row[MEMBER_COLS.INTEREST_LOCAL - 1] || '',
    interestChapter: row[MEMBER_COLS.INTEREST_CHAPTER - 1] || '',
    interestAllied: row[MEMBER_COLS.INTEREST_ALLIED - 1] || '',
    homeTown: row[MEMBER_COLS.HOME_TOWN - 1] || '',
    recentContactDate: row[MEMBER_COLS.RECENT_CONTACT_DATE - 1] || '',
    contactSteward: row[MEMBER_COLS.CONTACT_STEWARD - 1] || '',
    contactNotes: row[MEMBER_COLS.CONTACT_NOTES - 1] || '',
    hasOpenGrievance: row[MEMBER_COLS.HAS_OPEN_GRIEVANCE - 1] || '',
    grievanceStatus: row[MEMBER_COLS.GRIEVANCE_STATUS - 1] || '',
    nextDeadline: row[MEMBER_COLS.NEXT_DEADLINE - 1] || '',
    startGrievance: row[MEMBER_COLS.START_GRIEVANCE - 1] || false
  };
}

/**
 * Map a Grievance Log row array to a structured object
 * @param {Array} row - Row data array from Grievance Log
 * @returns {Object} Structured grievance object
 */
function mapGrievanceRow(row) {
  return {
    grievanceId: row[GRIEVANCE_COLS.GRIEVANCE_ID - 1] || '',
    memberId: row[GRIEVANCE_COLS.MEMBER_ID - 1] || '',
    firstName: row[GRIEVANCE_COLS.FIRST_NAME - 1] || '',
    lastName: row[GRIEVANCE_COLS.LAST_NAME - 1] || '',
    fullName: (row[GRIEVANCE_COLS.FIRST_NAME - 1] || '') + ' ' + (row[GRIEVANCE_COLS.LAST_NAME - 1] || ''),
    status: row[GRIEVANCE_COLS.STATUS - 1] || '',
    currentStep: row[GRIEVANCE_COLS.CURRENT_STEP - 1] || '',
    incidentDate: row[GRIEVANCE_COLS.INCIDENT_DATE - 1] || '',
    filingDeadline: row[GRIEVANCE_COLS.FILING_DEADLINE - 1] || '',
    dateFiled: row[GRIEVANCE_COLS.DATE_FILED - 1] || '',
    step1Due: row[GRIEVANCE_COLS.STEP1_DUE - 1] || '',
    step1Rcvd: row[GRIEVANCE_COLS.STEP1_RCVD - 1] || '',
    step2AppealDue: row[GRIEVANCE_COLS.STEP2_APPEAL_DUE - 1] || '',
    step2AppealFiled: row[GRIEVANCE_COLS.STEP2_APPEAL_FILED - 1] || '',
    step2Due: row[GRIEVANCE_COLS.STEP2_DUE - 1] || '',
    step2Rcvd: row[GRIEVANCE_COLS.STEP2_RCVD - 1] || '',
    step3AppealDue: row[GRIEVANCE_COLS.STEP3_APPEAL_DUE - 1] || '',
    step3AppealFiled: row[GRIEVANCE_COLS.STEP3_APPEAL_FILED - 1] || '',
    dateClosed: row[GRIEVANCE_COLS.DATE_CLOSED - 1] || '',
    daysOpen: row[GRIEVANCE_COLS.DAYS_OPEN - 1] || '',
    nextActionDue: row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1] || '',
    daysToDeadline: row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1] || '',
    articles: row[GRIEVANCE_COLS.ARTICLES - 1] || '',
    issueCategory: row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '',
    memberEmail: row[GRIEVANCE_COLS.MEMBER_EMAIL - 1] || '',
    unit: row[GRIEVANCE_COLS.UNIT - 1] || '',
    location: row[GRIEVANCE_COLS.LOCATION - 1] || '',
    steward: row[GRIEVANCE_COLS.STEWARD - 1] || '',
    resolution: row[GRIEVANCE_COLS.RESOLUTION - 1] || '',
    messageAlert: row[GRIEVANCE_COLS.MESSAGE_ALERT - 1] || false,
    coordinatorMessage: row[GRIEVANCE_COLS.COORDINATOR_MESSAGE - 1] || '',
    acknowledgedBy: row[GRIEVANCE_COLS.ACKNOWLEDGED_BY - 1] || '',
    acknowledgedDate: row[GRIEVANCE_COLS.ACKNOWLEDGED_DATE - 1] || '',
    driveFolderId: row[GRIEVANCE_COLS.DRIVE_FOLDER_ID - 1] || '',
    driveFolderUrl: row[GRIEVANCE_COLS.DRIVE_FOLDER_URL - 1] || ''
  };
}

/**
 * Get all member header labels in order
 * @returns {Array} Array of header labels for Member Directory
 */
function getMemberHeaders() {
  return [
    'Member ID', 'First Name', 'Last Name', 'Job Title',
    'Work Location', 'Unit', 'Office Days',
    'Email', 'Phone', 'Preferred Communication', 'Best Time to Contact',
    'Supervisor', 'Manager', 'Is Steward', 'Committees', 'Assigned Steward',
    'Last Virtual Mtg', 'Last In-Person Mtg', 'Open Rate %', 'Volunteer Hours',
    'Interest: Local', 'Interest: Chapter', 'Interest: Allied', 'Home Town',
    'Recent Contact Date', 'Contact Steward', 'Contact Notes',
    'Has Open Grievance?', 'Grievance Status', 'Days to Deadline', 'Start Grievance'
  ];
}

/**
 * Get all grievance header labels in order
 * @returns {Array} Array of header labels for Grievance Log
 */
function getGrievanceHeaders() {
  return [
    'Grievance ID', 'Member ID', 'First Name', 'Last Name',
    'Status', 'Current Step',
    'Incident Date', 'Filing Deadline', 'Date Filed',
    'Step I Due', 'Step I Rcvd',
    'Step II Appeal Due', 'Step II Appeal Filed', 'Step II Due', 'Step II Rcvd',
    'Step III Appeal Due', 'Step III Appeal Filed', 'Date Closed',
    'Days Open', 'Next Action Due', 'Days to Deadline',
    'Articles Violated', 'Issue Category',
    'Member Email', 'Unit', 'Work Location', 'Assigned Steward',
    'Resolution',
    'Message Alert', 'Coordinator Message', 'Acknowledged By', 'Acknowledged Date',
    'Drive Folder ID', 'Drive Folder URL'
  ];
}

// ============================================================================
// VALIDATION VALUES
// ============================================================================

/**
 * Default values for Config sheet dropdowns
 */
var DEFAULT_CONFIG = {
  OFFICE_DAYS: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
  YES_NO: ['Yes', 'No'],
  // Status = workflow state (where is the case in the process)
  GRIEVANCE_STATUS: ['Open', 'Pending Info', 'In Arbitration', 'Appealed', 'Closed'],
  // Resolution = outcome (how did the case end, only when Status = Closed)
  GRIEVANCE_RESOLUTION: ['Won - Full', 'Won - Partial', 'Settled - Favorable', 'Settled - Neutral', 'Denied - Appealing', 'Denied - Final', 'Withdrawn'],
  GRIEVANCE_STEP: ['Informal', 'Step I', 'Step II', 'Step III', 'Mediation', 'Arbitration'],
  ISSUE_CATEGORY: ['Discipline', 'Workload', 'Scheduling', 'Pay', 'Benefits', 'Safety', 'Harassment', 'Discrimination', 'Contract Violation', 'Other'],
  ARTICLES: [
    'Art. 1 - Recognition',
    'Art. 2 - Management Rights',
    'Art. 3 - Union Rights',
    'Art. 4 - Dues Deduction',
    'Art. 5 - Non-Discrimination',
    'Art. 6 - Hours of Work',
    'Art. 7 - Overtime',
    'Art. 8 - Compensation',
    'Art. 9 - Benefits',
    'Art. 10 - Leave',
    'Art. 11 - Holidays',
    'Art. 12 - Seniority',
    'Art. 13 - Discipline',
    'Art. 14 - Safety',
    'Art. 15 - Training',
    'Art. 16 - Evaluations',
    'Art. 17 - Layoff',
    'Art. 18 - Vacancies',
    'Art. 19 - Transfers',
    'Art. 20 - Subcontracting',
    'Art. 21 - Personnel Files',
    'Art. 22 - Uniforms',
    'Art. 23 - Grievance Procedure',
    'Art. 24 - Arbitration',
    'Art. 25 - No Strike',
    'Art. 26 - Duration'
  ],
  COMM_METHODS: ['Email', 'Phone', 'Text', 'In Person']
};

/**
 * Grievance STATUS priority for auto-sorting
 * Status = workflow state only (where the case is in the process)
 * Lower number = higher priority (appears first)
 */
var GRIEVANCE_STATUS_PRIORITY = {
  'Open': 1,
  'Pending Info': 2,
  'In Arbitration': 3,
  'Appealed': 4,
  'Closed': 5
};

/**
 * Grievance RESOLUTION priority for auto-sorting closed cases
 * Resolution = outcome (how the case ended, only when Status = Closed)
 * Lower number = higher priority (appears first)
 */
var GRIEVANCE_RESOLUTION_PRIORITY = {
  'Won - Full': 1,
  'Won - Partial': 2,
  'Won': 3,
  'Settled - Favorable': 4,
  'Settled - Neutral': 5,
  'Settled': 6,
  'Denied - Appealing': 7,
  'Denied - Final': 8,
  'Denied': 9,
  'Withdrawn': 10,
  'Pending': 50,
  '': 99
};

// ============================================================================
// MULTI-SELECT COLUMN CONFIGURATION
// ============================================================================

/**
 * Columns that support multiple selections (comma-separated values)
 * Maps column number to config source column for options
 */
var MULTI_SELECT_COLS = {
  // Member Directory multi-select columns
  MEMBER_DIR: [
    { col: MEMBER_COLS.OFFICE_DAYS, configCol: CONFIG_COLS.OFFICE_DAYS, label: 'Office Days' },
    { col: MEMBER_COLS.PREFERRED_COMM, configCol: CONFIG_COLS.COMM_METHODS, label: 'Preferred Communication' },
    { col: MEMBER_COLS.BEST_TIME, configCol: CONFIG_COLS.BEST_TIMES, label: 'Best Time to Contact' },
    { col: MEMBER_COLS.COMMITTEES, configCol: CONFIG_COLS.STEWARD_COMMITTEES, label: 'Committees' },
    { col: MEMBER_COLS.ASSIGNED_STEWARD, configCol: CONFIG_COLS.STEWARDS, label: 'Assigned Steward(s)' }
  ]
};

/**
 * Check if a column in Member Directory is a multi-select column
 * @param {number} col - Column number (1-indexed)
 * @returns {Object|null} Multi-select config if found, null otherwise
 */
function getMultiSelectConfig(col) {
  for (var i = 0; i < MULTI_SELECT_COLS.MEMBER_DIR.length; i++) {
    if (MULTI_SELECT_COLS.MEMBER_DIR[i].col === col) {
      return MULTI_SELECT_COLS.MEMBER_DIR[i];
    }
  }
  return null;
}

// ============================================================================
// ID GENERATION
// ============================================================================

/**
 * Generate a name-based ID with prefix and 3 random digits
 * Format: Prefix + First 2 chars of firstName + First 2 chars of lastName + 3 random digits
 * Example: M + John Smith â†’ MJOSM123, G + John Smith â†’ GJOSM456
 * @param {string} prefix - ID prefix ('M' for members, 'G' for grievances)
 * @param {string} firstName - First name
 * @param {string} lastName - Last name
 * @param {Object} existingIds - Object with existing IDs as keys (for collision detection)
 * @returns {string} Generated ID (uppercase)
 */
function generateNameBasedId(prefix, firstName, lastName, existingIds) {
  var firstPart = (firstName || 'XX').substring(0, 2).toUpperCase();
  var lastPart = (lastName || 'XX').substring(0, 2).toUpperCase();
  var namePrefix = (prefix || '') + firstPart + lastPart;

  var maxAttempts = 100;
  for (var attempt = 0; attempt < maxAttempts; attempt++) {
    var randomDigits = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
    var newId = namePrefix + randomDigits;

    if (!existingIds || !existingIds[newId]) {
      return newId;
    }
  }

  // Fallback: add timestamp component if too many collisions
  var timestamp = String(Date.now()).slice(-3);
  return namePrefix + timestamp;
}



// ================================================================================
// MODULE: Code.gs
// Source: Code.gs
// ================================================================================

/**
 * 509 Dashboard - Main Entry Point
 *
 * Core setup functions, menu system, and sheet creation.
 *
 * @version 1.0.0
 * @license Free for use by non-profit collective bargaining groups and unions
 */

// ============================================================================
// MENU SYSTEM
// ============================================================================

/**
 * Creates the menu system when the spreadsheet opens
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();

  // Main Dashboard Menu
  ui.createMenu('ğŸ‘¤ Dashboard')
    .addItem('ğŸ“Š Smart Dashboard (Auto-Detect)', 'showSmartDashboard')
    .addItem('ğŸ¯ Interactive Dashboard', 'showInteractiveDashboardTab')
    .addSeparator()
    .addItem('ğŸ“‹ View Active Grievances', 'viewActiveGrievances')
    .addItem('ğŸ“± Mobile Dashboard', 'showMobileDashboard')
    .addItem('ğŸ“± Get Mobile App URL', 'showWebAppUrl')
    .addItem('âš¡ Quick Actions', 'showQuickActionsMenu')
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ“‹ Grievance Tools')
      .addItem('â• Start New Grievance', 'startNewGrievance')
      .addItem('ğŸ”„ Refresh Grievance Formulas', 'recalcAllGrievancesBatched')
      .addItem('ğŸ”„ Refresh Member Directory Data', 'refreshMemberDirectoryFormulas')
      .addSeparator()
      .addItem('ğŸ”— Setup Live Grievance Links', 'setupLiveGrievanceFormulas')
      .addItem('ğŸ‘¤ Setup Member ID Dropdown', 'setupGrievanceMemberDropdown')
      .addItem('ğŸ”§ Fix Overdue Text Data', 'fixOverdueTextToNumbers'))
    .addToUi();

  // Member Search Menu (standalone for quick access)
  ui.createMenu('ğŸ” Search')
    .addItem('ğŸ” Search Members', 'searchMembers')
    .addToUi();

  // Sheet Manager Menu
  ui.createMenu('ğŸ“Š Sheet Manager')
    .addItem('ğŸ“Š Rebuild Dashboard', 'rebuildDashboard')
    .addItem('ğŸ“ˆ Refresh Interactive Charts', 'refreshInteractiveCharts')
    .addItem('ğŸ”„ Refresh All Formulas', 'refreshAllFormulas')
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ“ Google Drive')
      .addItem('ğŸ“ Setup Folder for Grievance', 'setupDriveFolderForGrievance')
      .addItem('ğŸ“ View Grievance Files', 'showGrievanceFiles')
      .addItem('ğŸ“ Batch Create Folders', 'batchCreateGrievanceFolders'))
    .addSubMenu(ui.createMenu('ğŸ“… Calendar')
      .addItem('ğŸ“… Sync Deadlines to Calendar', 'syncDeadlinesToCalendar')
      .addItem('ğŸ“… View Upcoming Deadlines', 'showUpcomingDeadlinesFromCalendar')
      .addItem('ğŸ—‘ï¸ Clear Calendar Events', 'clearAllCalendarEvents'))
    .addSubMenu(ui.createMenu('ğŸ“¬ Notifications')
      .addItem('âš™ï¸ Notification Settings', 'showNotificationSettings')
      .addItem('ğŸ§ª Test Notifications', 'testDeadlineNotifications'))
    .addToUi();

  // Tools Menu (NEW)
  ui.createMenu('ğŸ”§ Tools')
    .addSubMenu(ui.createMenu('â™¿ ADHD & Accessibility')
      .addItem('â™¿ ADHD Control Panel', 'showADHDControlPanel')
      .addItem('ğŸ¯ Focus Mode', 'activateFocusMode')
      .addItem('ğŸ”² Toggle Zebra Stripes', 'toggleZebraStripes')
      .addItem('ğŸ“ Quick Capture', 'showQuickCaptureNotepad')
      .addItem('ğŸ… Pomodoro Timer', 'startPomodoroTimer'))
    .addSubMenu(ui.createMenu('ğŸ¨ Theming')
      .addItem('ğŸ¨ Theme Manager', 'showThemeManager')
      .addItem('ğŸŒ™ Toggle Dark Mode', 'quickToggleDarkMode')
      .addItem('ğŸ”„ Reset Theme', 'resetToDefaultTheme'))
    .addSeparator()
    .addSubMenu(ui.createMenu('â˜‘ï¸ Multi-Select')
      .addItem('ğŸ“ Open Editor', 'showMultiSelectDialog')
      .addSeparator()
      .addItem('âš¡ Enable Auto-Open', 'installMultiSelectTrigger')
      .addItem('ğŸš« Disable Auto-Open', 'removeMultiSelectTrigger'))
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ—„ï¸ Cache & Performance')
      .addItem('ğŸ—„ï¸ Cache Status', 'showCacheStatusDashboard')
      .addItem('ğŸ”¥ Warm Up Caches', 'warmUpCaches')
      .addItem('ğŸ—‘ï¸ Clear All Caches', 'invalidateAllCaches'))
    .addSeparator()
    .addSubMenu(ui.createMenu('âœ… Validation')
      .addItem('ğŸ” Run Bulk Validation', 'runBulkValidation')
      .addItem('âš™ï¸ Validation Settings', 'showValidationSettings')
      .addItem('ğŸ§¹ Clear Indicators', 'clearValidationIndicators')
      .addItem('âš¡ Install Validation Trigger', 'installValidationTrigger'))
    .addToUi();

  // Setup Menu
  ui.createMenu('ğŸ—ï¸ Setup')
    .addItem('ğŸ”§ REPAIR DASHBOARD', 'REPAIR_DASHBOARD')
    .addSeparator()
    .addItem('âš™ï¸ Setup Data Validations', 'setupDataValidations')
    .addItem('ğŸ¨ Setup ADHD Defaults', 'setupADHDDefaults')
    .addToUi();

  // Demo Menu - only show if demo mode is not disabled
  if (!isDemoModeDisabled()) {
    ui.createMenu('ğŸ­ Demo')
      .addItem('ğŸš€ Seed All Sample Data', 'SEED_SAMPLE_DATA')
      .addSeparator()
      .addSubMenu(ui.createMenu('ğŸŒ± Seed Data')
        .addItem('âš™ï¸ Seed Config Dropdowns Only', 'seedConfigData')
        .addSeparator()
        .addItem('ğŸ‘¥ Seed Members (Custom Count)', 'SEED_MEMBERS_DIALOG')
        .addItem('ğŸ“‹ Seed Grievances (Custom Count)', 'SEED_GRIEVANCES_DIALOG')
        .addSeparator()
        .addItem('ğŸ‘¥ Seed 50 Members', 'seed50Members')
        .addItem('ğŸ“‹ Seed 25 Grievances', 'seed25Grievances'))
      .addSeparator()
      .addSubMenu(ui.createMenu('ğŸ—‘ï¸ Nuke Data')
        .addItem('â˜¢ï¸ NUKE SEEDED DATA', 'NUKE_SEEDED_DATA')
        .addItem('ğŸ§¹ Clear Config Dropdowns Only', 'NUKE_CONFIG_DROPDOWNS')
        .addSeparator()
        .addItem('ğŸ”„ Restore Config & Dropdowns', 'restoreConfigAndDropdowns'))
      .addToUi();
  }

  // Testing Menu (NEW)
  ui.createMenu('ğŸ§ª Testing')
    .addItem('ğŸ§ª Run All Tests', 'runAllTests')
    .addItem('âš¡ Run Quick Tests', 'runQuickTests')
    .addSeparator()
    .addItem('ğŸ“Š View Test Results', 'viewTestResults')
    .addToUi();

  // Administrator Menu
  ui.createMenu('âš™ï¸ Administrator')
    .addItem('ğŸ” DIAGNOSE SETUP', 'DIAGNOSE_SETUP')
    .addItem('ğŸ” Verify Hidden Sheets', 'verifyHiddenSheets')
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ”§ Setup & Triggers')
      .addItem('ğŸ”§ Setup All Hidden Sheets', 'setupAllHiddenSheets')
      .addItem('ğŸ”§ Repair All Hidden Sheets', 'repairAllHiddenSheets')
      .addItem('âš¡ Install Auto-Sync Trigger', 'installAutoSyncTrigger')
      .addItem('ğŸš« Remove Auto-Sync Trigger', 'removeAutoSyncTrigger'))
    .addSeparator()
    .addSubMenu(ui.createMenu('ğŸ”„ Manual Sync')
      .addItem('ğŸ”„ Sync All Data Now', 'syncAllData')
      .addItem('ğŸ”„ Sync Grievance â†’ Members', 'syncGrievanceToMemberDirectory')
      .addItem('ğŸ”„ Sync Members â†’ Grievances', 'syncMemberToGrievanceLog'))
    .addToUi();
}

// ============================================================================
// MAIN SETUP FUNCTION
// ============================================================================

/**
 * Main setup function - creates the complete 509 Dashboard
 * Creates the core sheets with proper structure and formatting
 */
function CREATE_509_DASHBOARD() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();

  // Confirm with user
  var response = ui.alert(
    'ğŸ—ï¸ Create 509 Dashboard',
    'This will create the 509 Dashboard with:\n\n' +
    'â€¢ Config (dropdown sources)\n' +
    'â€¢ Member Directory\n' +
    'â€¢ Grievance Log\n' +
    'â€¢ ğŸ’¼ Dashboard (Executive metrics)\n' +
    'â€¢ ğŸ¯ Interactive (Customizable view)\n\n' +
    'Plus 5 hidden calculation sheets for self-healing formulas.\n\n' +
    'Existing sheets with matching names will be recreated.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    ui.alert('Setup cancelled.');
    return;
  }

  ss.toast('Starting dashboard creation...', 'ğŸ—ï¸ Setup', 5);

  try {
    // Create core data sheets
    createConfigSheet(ss);
    ss.toast('Created Config sheet', 'ğŸ—ï¸ Progress', 2);

    createMemberDirectory(ss);
    ss.toast('Created Member Directory', 'ğŸ—ï¸ Progress', 2);

    createGrievanceLog(ss);
    ss.toast('Created Grievance Log', 'ğŸ—ï¸ Progress', 2);

    // Setup hidden calculation sheets (needed before dashboards for formula references)
    ss.toast('Setting up hidden sheets...', 'ğŸ—ï¸ Progress', 3);
    setupHiddenSheets(ss);

    // Create dashboard sheets (after hidden sheets so formulas can reference them)
    createDashboard(ss);
    ss.toast('Created Dashboard', 'ğŸ—ï¸ Progress', 2);

    createInteractiveDashboard(ss);
    ss.toast('Created Interactive Dashboard', 'ğŸ—ï¸ Progress', 2);

    // Setup data validations
    ss.toast('Setting up validations...', 'ğŸ—ï¸ Progress', 3);
    setupDataValidations();

    // Setup live grievance links and member dropdown
    ss.toast('Setting up live data links...', 'ğŸ—ï¸ Progress', 3);
    setupLiveGrievanceFormulas();
    setupGrievanceMemberDropdown();

    // Move Config to first position
    var configSheet = ss.getSheetByName(SHEETS.CONFIG);
    if (configSheet) {
      ss.setActiveSheet(configSheet);
      ss.moveActiveSheet(1);
    }

    ss.toast('Dashboard creation complete!', 'âœ… Success', 5);
    ui.alert('âœ… Success', '509 Dashboard has been created successfully!\n\n' +
      '5 sheets created:\n' +
      'â€¢ Config, Member Directory, Grievance Log (data)\n' +
      'â€¢ ğŸ’¼ Dashboard, ğŸ¯ Interactive (views)\n\n' +
      'Plus 5 hidden calculation sheets with self-healing formulas.\n\n' +
      'âš¡ Auto-sync trigger installed - dates and deadlines will\n' +
      'update automatically when you edit the sheets.\n\n' +
      'Use the Demo menu to seed sample data.', ui.ButtonSet.OK);

  } catch (error) {
    Logger.log('Error in CREATE_509_DASHBOARD: ' + error.message);
    ui.alert('âŒ Error', 'An error occurred: ' + error.message, ui.ButtonSet.OK);
  }
}

// ============================================================================
// SHEET CREATION FUNCTIONS
// ============================================================================

/**
 * Create or recreate the Config sheet with dropdown values
 * Comprehensive configuration with section groupings and organization settings
 */
function createConfigSheet(ss) {
  var sheet = getOrCreateSheet(ss, SHEETS.CONFIG);
  sheet.clear();

  // Row 1: Section Headers (grouped categories)
  var sectionHeaders = [
    'â”€â”€ EMPLOYMENT INFO â”€â”€', '', '', '', '',           // A-E (5 cols)
    'â”€â”€ SUPERVISION â”€â”€', '',                            // F-G (2 cols)
    'â”€â”€ STEWARD INFO â”€â”€', '',                           // H-I (2 cols)
    'â”€â”€ GRIEVANCE SETTINGS â”€â”€', '', '', '',             // J-M (4 cols)
    'â”€â”€ LINKS & COORDINATORS â”€â”€', '', '', '',           // N-Q (4 cols)
    'â”€â”€ NOTIFICATIONS â”€â”€', '', '',                      // R-T (3 cols)
    'â”€â”€ ORGANIZATION â”€â”€', '', '', '',                   // U-X (4 cols)
    'â”€â”€ INTEGRATION â”€â”€', '',                            // Y-Z (2 cols)
    'â”€â”€ DEADLINES â”€â”€', '', '', '',                      // AA-AD (4 cols)
    'â”€â”€ MULTI-SELECT OPTIONS â”€â”€', '',                   // AE-AF (2 cols)
    'â”€â”€ CONTRACT & LEGAL â”€â”€', '', '', '',               // AG-AJ (4 cols)
    'â”€â”€ ORG IDENTITY â”€â”€', '', '',                       // AK-AM (3 cols)
    'â”€â”€ EXTENDED CONTACT â”€â”€', '', '', ''                // AN-AQ (4 cols)
  ];

  // Row 2: Column Headers
  var columnHeaders = [
    'Job Titles', 'Office Locations', 'Units', 'Office Days', 'Yes/No (Dropdowns)',
    'Supervisors', 'Managers',
    'Stewards', 'Steward Committees',
    'Grievance Status', 'Grievance Step', 'Issue Category', 'Articles Violated',
    'Communication Methods', 'Grievance Coordinators', 'Grievance Form URL', 'Contact Form URL',
    'Admin Emails', 'Alert Days Before Deadline', 'Notification Recipients',
    'Organization Name', 'Local Number', 'Main Office Address', 'Main Phone',
    'Google Drive Folder ID', 'Google Calendar ID',
    'Filing Deadline Days', 'Step I Response Days', 'Step II Appeal Days', 'Step II Response Days',
    'Best Times to Contact', 'Home Towns',
    'Contract Article (Grievance)', 'Contract Article (Discipline)', 'Contract Article (Workload)', 'Contract Name',
    'Union Parent', 'State/Region', 'Organization Website',
    'Office Addresses', 'Main Fax', 'Main Contact Name', 'Main Contact Email'
  ];

  // Apply section headers (Row 1)
  sheet.getRange(1, 1, 1, sectionHeaders.length).setValues([sectionHeaders])
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_DARK)
    .setFontWeight('bold')
    .setFontStyle('italic')
    .setHorizontalAlignment('center');

  // Apply column headers (Row 2)
  sheet.getRange(2, 1, 1, columnHeaders.length).setValues([columnHeaders])
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor(COLORS.WHITE)
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Add default dropdown values (Row 3+)
  // Office Days (D)
  sheet.getRange(3, CONFIG_COLS.OFFICE_DAYS, DEFAULT_CONFIG.OFFICE_DAYS.length, 1)
    .setValues(DEFAULT_CONFIG.OFFICE_DAYS.map(function(v) { return [v]; }));

  // Yes/No (E)
  sheet.getRange(3, CONFIG_COLS.YES_NO, DEFAULT_CONFIG.YES_NO.length, 1)
    .setValues(DEFAULT_CONFIG.YES_NO.map(function(v) { return [v]; }));

  // Steward Committees (I)
  var committees = ['Grievance Committee', 'Bargaining Committee', 'Health & Safety Committee',
                    'Political Action Committee', 'Membership Committee', 'Executive Board'];
  sheet.getRange(3, CONFIG_COLS.STEWARD_COMMITTEES, committees.length, 1)
    .setValues(committees.map(function(v) { return [v]; }));

  // Grievance Status (J)
  sheet.getRange(3, CONFIG_COLS.GRIEVANCE_STATUS, DEFAULT_CONFIG.GRIEVANCE_STATUS.length, 1)
    .setValues(DEFAULT_CONFIG.GRIEVANCE_STATUS.map(function(v) { return [v]; }));

  // Grievance Step (K)
  sheet.getRange(3, CONFIG_COLS.GRIEVANCE_STEP, DEFAULT_CONFIG.GRIEVANCE_STEP.length, 1)
    .setValues(DEFAULT_CONFIG.GRIEVANCE_STEP.map(function(v) { return [v]; }));

  // Issue Category (L)
  sheet.getRange(3, CONFIG_COLS.ISSUE_CATEGORY, DEFAULT_CONFIG.ISSUE_CATEGORY.length, 1)
    .setValues(DEFAULT_CONFIG.ISSUE_CATEGORY.map(function(v) { return [v]; }));

  // Articles (M)
  sheet.getRange(3, CONFIG_COLS.ARTICLES, DEFAULT_CONFIG.ARTICLES.length, 1)
    .setValues(DEFAULT_CONFIG.ARTICLES.map(function(v) { return [v]; }));

  // Communication Methods (N)
  sheet.getRange(3, CONFIG_COLS.COMM_METHODS, DEFAULT_CONFIG.COMM_METHODS.length, 1)
    .setValues(DEFAULT_CONFIG.COMM_METHODS.map(function(v) { return [v]; }));

  // Alert Days (S) - default notification intervals
  sheet.getRange(3, CONFIG_COLS.ALERT_DAYS, 1, 1).setValue('3, 7, 14');

  // Organization defaults (SEIU Local 509)
  sheet.getRange(3, CONFIG_COLS.ORG_NAME, 1, 1).setValue('SEIU Local 509');
  sheet.getRange(3, CONFIG_COLS.LOCAL_NUMBER, 1, 1).setValue('509');
  sheet.getRange(3, CONFIG_COLS.MAIN_ADDRESS, 1, 1).setValue('293 Boston Post Road West, 4th Floor, Marlborough, MA 01752');
  sheet.getRange(3, CONFIG_COLS.MAIN_PHONE, 1, 1).setValue('774-843-7509');

  // Deadline defaults (in days)
  sheet.getRange(3, CONFIG_COLS.FILING_DEADLINE_DAYS, 1, 1).setValue(21);
  sheet.getRange(3, CONFIG_COLS.STEP1_RESPONSE_DAYS, 1, 1).setValue(30);
  sheet.getRange(3, CONFIG_COLS.STEP2_APPEAL_DAYS, 1, 1).setValue(10);
  sheet.getRange(3, CONFIG_COLS.STEP2_RESPONSE_DAYS, 1, 1).setValue(30);

  // Best Times to Contact (AE)
  var bestTimes = ['Morning (8am-12pm)', 'Afternoon (12pm-5pm)', 'Evening (5pm-8pm)', 'Weekends', 'Flexible'];
  sheet.getRange(3, CONFIG_COLS.BEST_TIMES, bestTimes.length, 1)
    .setValues(bestTimes.map(function(v) { return [v]; }));

  // Contract articles
  sheet.getRange(3, CONFIG_COLS.CONTRACT_GRIEVANCE, 1, 1).setValue('Article 23A');
  sheet.getRange(3, CONFIG_COLS.CONTRACT_DISCIPLINE, 1, 1).setValue('Article 12');
  sheet.getRange(3, CONFIG_COLS.CONTRACT_WORKLOAD, 1, 1).setValue('Article 15');
  sheet.getRange(3, CONFIG_COLS.CONTRACT_NAME, 1, 1).setValue('2023-2026 CBA');

  // Org identity
  sheet.getRange(3, CONFIG_COLS.UNION_PARENT, 1, 1).setValue('SEIU');
  sheet.getRange(3, CONFIG_COLS.STATE_REGION, 1, 1).setValue('Massachusetts');
  sheet.getRange(3, CONFIG_COLS.ORG_WEBSITE, 1, 1).setValue('https://www.seiu509.org/');

  // Extended contact
  sheet.getRange(3, CONFIG_COLS.MAIN_FAX, 1, 1).setValue('508-485-8529');
  sheet.getRange(3, CONFIG_COLS.MAIN_CONTACT_NAME, 1, 1).setValue('Marc');
  sheet.getRange(3, CONFIG_COLS.MAIN_CONTACT_EMAIL, 1, 1).setValue('marc@seiu509.org');

  // Freeze header rows (1 and 2)
  sheet.setFrozenRows(2);

  // Auto-resize all columns
  sheet.autoResizeColumns(1, columnHeaders.length);

  // Set minimum column widths for readability
  for (var i = 1; i <= columnHeaders.length; i++) {
    if (sheet.getColumnWidth(i) < 100) {
      sheet.setColumnWidth(i, 100);
    }
  }
}

/**
 * Create or recreate the Member Directory sheet
 */
function createMemberDirectory(ss) {
  var sheet = getOrCreateSheet(ss, SHEETS.MEMBER_DIR);
  sheet.clear();

  var headers = getMemberHeaders();
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor(COLORS.WHITE)
    .setFontWeight('bold');

  // Freeze header row
  sheet.setFrozenRows(1);

  // Set column widths
  sheet.setColumnWidth(MEMBER_COLS.MEMBER_ID, 100);
  sheet.setColumnWidth(MEMBER_COLS.FIRST_NAME, 120);
  sheet.setColumnWidth(MEMBER_COLS.LAST_NAME, 120);
  sheet.setColumnWidth(MEMBER_COLS.EMAIL, 200);
  sheet.setColumnWidth(MEMBER_COLS.CONTACT_NOTES, 250);

  // Add checkbox for Start Grievance column (pre-allocate for future rows)
  sheet.getRange(2, MEMBER_COLS.START_GRIEVANCE, 4999, 1).insertCheckboxes();

  // Format date columns (MM/dd/yyyy)
  var dateColumns = [
    MEMBER_COLS.LAST_VIRTUAL_MTG,
    MEMBER_COLS.LAST_INPERSON_MTG,
    MEMBER_COLS.RECENT_CONTACT_DATE
  ];
  dateColumns.forEach(function(col) {
    sheet.getRange(2, col, 998, 1).setNumberFormat('MM/dd/yyyy');
  });

  // Columns AB-AD (Has Open Grievance?, Grievance Status, Days to Deadline)
  // are populated by syncGrievanceToMemberDirectory() with STATIC values
  // No formulas in visible sheets - all calculations done by script

  // Auto-resize other columns
  sheet.autoResizeColumns(1, headers.length);
}

/**
 * Create or recreate the Grievance Log sheet
 * NOTE: Calculated columns (First Name, Last Name, Email, Deadlines, Days Open, etc.)
 * are managed by the hidden _Grievance_Formulas sheet for self-healing capability.
 * Users can't accidentally erase formulas because they're in the hidden sheet.
 */
function createGrievanceLog(ss) {
  var sheet = getOrCreateSheet(ss, SHEETS.GRIEVANCE_LOG);
  sheet.clear();

  var headers = getGrievanceHeaders();
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor(COLORS.WHITE)
    .setFontWeight('bold');

  // Freeze header row
  sheet.setFrozenRows(1);

  // Set column widths
  sheet.setColumnWidth(GRIEVANCE_COLS.GRIEVANCE_ID, 100);
  sheet.setColumnWidth(GRIEVANCE_COLS.RESOLUTION, 250);
  sheet.setColumnWidth(GRIEVANCE_COLS.COORDINATOR_MESSAGE, 250);

  // Add checkbox for Message Alert column (pre-allocate for future rows)
  sheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ALERT, 4999, 1).insertCheckboxes();

  // Format date columns
  var dateColumns = [
    GRIEVANCE_COLS.INCIDENT_DATE,
    GRIEVANCE_COLS.FILING_DEADLINE,
    GRIEVANCE_COLS.DATE_FILED,
    GRIEVANCE_COLS.STEP1_DUE,
    GRIEVANCE_COLS.STEP1_RCVD,
    GRIEVANCE_COLS.STEP2_APPEAL_DUE,
    GRIEVANCE_COLS.STEP2_APPEAL_FILED,
    GRIEVANCE_COLS.STEP2_DUE,
    GRIEVANCE_COLS.STEP2_RCVD,
    GRIEVANCE_COLS.STEP3_APPEAL_DUE,
    GRIEVANCE_COLS.STEP3_APPEAL_FILED,
    GRIEVANCE_COLS.DATE_CLOSED,
    GRIEVANCE_COLS.NEXT_ACTION_DUE
  ];

  dateColumns.forEach(function(col) {
    sheet.getRange(2, col, 998, 1).setNumberFormat('MM/dd/yyyy');
  });

  // Format Days Open (S) and Days to Deadline (U) as whole numbers
  sheet.getRange(2, GRIEVANCE_COLS.DAYS_OPEN, 998, 1).setNumberFormat('0');
  sheet.getRange(2, GRIEVANCE_COLS.DAYS_TO_DEADLINE, 998, 1).setNumberFormat('0');

  // Auto-resize other columns
  sheet.autoResizeColumns(1, headers.length);
}


/**
 * Create or recreate the unified Dashboard sheet (Executive Dashboard theme)
 * Combines member metrics, grievance metrics, and key performance indicators
 * Uses Executive Dashboard's green QUICK STATS theme
 */
function createDashboard(ss) {
  var sheet = getOrCreateSheet(ss, SHEETS.DASHBOARD);
  sheet.clear();

  // Title - Executive Dashboard style
  sheet.getRange('A1').setValue('ğŸ’¼ Executive Dashboard')
    .setFontSize(24)
    .setFontWeight('bold')
    .setFontColor(COLORS.PRIMARY_PURPLE);
  sheet.getRange('A1:F1').merge();

  // Subtitle with last refresh
  sheet.getRange('A2').setValue('Real-time metrics from Member Directory & Grievance Log')
    .setFontSize(10)
    .setFontStyle('italic')
    .setFontColor(COLORS.TEXT_DARK);
  sheet.getRange('A2:F2').merge();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 1: QUICK STATS (Executive Dashboard green theme)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A4').setValue('QUICK STATS')
    .setFontWeight('bold')
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A4:F4').merge();

  // Quick stats row - pulls from hidden _Dashboard_Calc sheet
  var quickStatsLabels = [
    ['Total Members', 'Active Stewards', 'Active Grievances', 'Win Rate', 'Overdue Cases', 'Due This Week']
  ];
  sheet.getRange('A5:F5').setValues(quickStatsLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  // Quick stats formulas - reference hidden calculation sheet
  var quickStatsFormulas = [
    [
      '=IFERROR(\'' + SHEETS.DASHBOARD_CALC + '\'!B2,0)',
      '=IFERROR(\'' + SHEETS.DASHBOARD_CALC + '\'!B3,0)',
      '=IFERROR(\'' + SHEETS.DASHBOARD_CALC + '\'!B5+\'' + SHEETS.DASHBOARD_CALC + '\'!B6,0)',
      '=IFERROR(TEXT(\'' + SHEETS.DASHBOARD_CALC + '\'!B11/100,"0%"),"-")',
      '=IFERROR(\'' + SHEETS.DASHBOARD_CALC + '\'!B13,0)',
      '=IFERROR(\'' + SHEETS.DASHBOARD_CALC + '\'!B14,0)'
    ]
  ];
  sheet.getRange('A6:F6').setFormulas(quickStatsFormulas)
    .setFontSize(20)
    .setHorizontalAlignment('center')
    .setFontWeight('bold');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 2: MEMBER METRICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A8').setValue('MEMBER METRICS')
    .setFontWeight('bold')
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor(COLORS.TEXT_DARK);
  sheet.getRange('A8:D8').merge();

  var memberMetricLabels = [['Total Members', 'Active Stewards', 'Avg Open Rate', 'YTD Vol. Hours']];
  sheet.getRange('A9:D9').setValues(memberMetricLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var mOpenRateCol = getColumnLetter(MEMBER_COLS.OPEN_RATE);
  var mVolHoursCol = getColumnLetter(MEMBER_COLS.VOLUNTEER_HOURS);

  var memberMetricFormulas = [
    [
      '=COUNTA(\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mIdCol + ')-1',
      '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")',
      '=IFERROR(ROUND(AVERAGE(\'' + SHEETS.MEMBER_DIR + '\'!' + mOpenRateCol + ':' + mOpenRateCol + '),1)&"%","-")',
      '=SUM(\'' + SHEETS.MEMBER_DIR + '\'!' + mVolHoursCol + ':' + mVolHoursCol + ')'
    ]
  ];
  sheet.getRange('A10:D10').setFormulas(memberMetricFormulas)
    .setFontSize(18)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 3: GRIEVANCE METRICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A12').setValue('GRIEVANCE METRICS')
    .setFontWeight('bold')
    .setBackground(COLORS.ACCENT_ORANGE)
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A12:F12').merge();

  var grievanceLabels = [['Open', 'Pending Info', 'Settled', 'Won', 'Denied', 'Withdrawn']];
  sheet.getRange('A13:F13').setValues(grievanceLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);

  var grievanceFormulas = [
    [
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")',
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")',
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Settled*")',
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")',
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Denied*")',
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"Withdrawn")'
    ]
  ];
  sheet.getRange('A14:F14').setFormulas(grievanceFormulas)
    .setFontSize(18)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 4: TIMELINE METRICS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A16').setValue('TIMELINE & PERFORMANCE')
    .setFontWeight('bold')
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A16:D16').merge();

  var timelineLabels = [['Avg Days Open', 'Filed This Month', 'Closed This Month', 'Avg Resolution Days']];
  sheet.getRange('A17:D17').setValues(timelineLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);

  var timelineFormulas = [
    [
      '=IFERROR(ROUND(AVERAGE(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<="&TODAY())',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&TODAY())',
      '=IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<>",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)'
    ]
  ];
  sheet.getRange('A18:D18').setFormulas(timelineFormulas)
    .setFontSize(18)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 5: TYPE ANALYSIS (by Issue Category)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A20').setValue('ğŸ“Š TYPE ANALYSIS (by Issue Category)')
    .setFontWeight('bold')
    .setBackground('#6366F1')  // Indigo
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A20:F20').merge();

  var typeLabels = [['Issue Category', 'Total Cases', 'Open', 'Resolved', 'Win Rate', 'Avg Days']];
  sheet.getRange('A21:F21').setValues(typeLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var gIssueCatCol = getColumnLetter(GRIEVANCE_COLS.ISSUE_CATEGORY);
  var gIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);

  // Top 5 issue categories with metrics - using QUERY formulas
  var categoryFormulas = [];
  var defaultCategories = ['Contract Violation', 'Discipline', 'Workload', 'Safety', 'Discrimination'];
  for (var c = 0; c < 5; c++) {
    var cat = defaultCategories[c];
    categoryFormulas.push([
      '="' + cat + '"',  // Wrap text as formula for setFormulas()
      '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '")',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Open")-COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")',
      '=IFERROR(TEXT(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '"),"0%"),"-")',
      '=IFERROR(ROUND(AVERAGEIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIssueCatCol + ':' + gIssueCatCol + ',"' + cat + '"),1),"-")'
    ]);
  }
  sheet.getRange('A22:F26').setFormulas(categoryFormulas)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 6: LOCATION BREAKDOWN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A28').setValue('ğŸ—ºï¸ LOCATION BREAKDOWN')
    .setFontWeight('bold')
    .setBackground('#0891B2')  // Cyan
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A28:F28').merge();

  var locationLabels = [['Location', 'Members', 'Grievances', 'Open Cases', 'Win Rate', 'Avg Satisfaction']];
  sheet.getRange('A29:F29').setValues(locationLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var mLocationCol = getColumnLetter(MEMBER_COLS.WORK_LOCATION);
  var gLocationCol = getColumnLetter(GRIEVANCE_COLS.LOCATION);  // GRIEVANCE_COLS uses LOCATION not WORK_LOCATION
  var configLocCol = getColumnLetter(CONFIG_COLS.OFFICE_LOCATIONS);

  // Location formulas - pulls top 5 locations from Config and calculates metrics
  var locationFormulas = [];
  for (var loc = 0; loc < 5; loc++) {
    var configRow = 3 + loc;  // Config data starts at row 3
    var locRef = '\'' + SHEETS.CONFIG + '\'!' + configLocCol + configRow;
    locationFormulas.push([
      '=IFERROR(' + locRef + ',"")',
      '=IF(' + locRef + '<>"",COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',' + locRef + '),"")',
      '=IF(' + locRef + '<>"",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' + locRef + '),"")',
      '=IF(' + locRef + '<>"",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' + locRef + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open"),"")',
      '=IF(AND(' + locRef + '<>"",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' + locRef + ')>0),TEXT(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' + locRef + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' + locRef + '),"0%"),"-")',
      '="-"'  // Satisfaction requires separate tracking
    ]);
  }
  sheet.getRange('A30:F34').setFormulas(locationFormulas)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 7: STEWARD PERFORMANCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A36').setValue('ğŸ‘¨â€âš–ï¸ STEWARD PERFORMANCE')
    .setFontWeight('bold')
    .setBackground('#7C3AED')  // Purple
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A36:F36').merge();

  var stewardLabels = [['Total Stewards', 'Active (w/ Cases)', 'Avg Cases/Steward', 'Best Win Rate', 'Total Vol Hours', 'Contacts This Month']];
  sheet.getRange('A37:F37').setValues(stewardLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var gAssignedStewardCol = getColumnLetter(GRIEVANCE_COLS.STEWARD);  // GRIEVANCE_COLS uses STEWARD not ASSIGNED_STEWARD
  var mContactDateCol = getColumnLetter(MEMBER_COLS.RECENT_CONTACT_DATE);

  var stewardFormulas = [
    [
      '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")',
      '=IFERROR(ROWS(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gAssignedStewardCol + ':' + gAssignedStewardCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gAssignedStewardCol + ':' + gAssignedStewardCol + '<>"",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + '="Open"))),0)',
      '=IFERROR(ROUND((COUNTA(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ')-1)/COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes"),1),"-")',
      '="-"',  // Best win rate requires complex calculation
      '=SUM(\'' + SHEETS.MEMBER_DIR + '\'!' + mVolHoursCol + ':' + mVolHoursCol + ')',
      '=COUNTIFS(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactDateCol + ':' + mContactDateCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.MEMBER_DIR + '\'!' + mContactDateCol + ':' + mContactDateCol + ',"<="&TODAY())'
    ]
  ];
  sheet.getRange('A38:F38').setFormulas(stewardFormulas)
    .setFontSize(16)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 8: MONTH-OVER-MONTH TRENDS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A40').setValue('ğŸ“ˆ MONTH-OVER-MONTH TRENDS')
    .setFontWeight('bold')
    .setBackground('#DC2626')  // Red
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A40:F40').merge();

  var trendLabels = [['Metric', 'This Month', 'Last Month', 'Change', '% Change', 'Trend']];
  sheet.getRange('A41:F41').setValues(trendLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment('center');

  // Trend rows: Filed, Closed, Won
  var trendData = [
    [
      '="Grievances Filed"',  // Wrap text as formula for setFormulas()
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<="&TODAY())',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY())-1,1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<"&DATE(YEAR(TODAY()),MONTH(TODAY()),1))',
      '=B42-C42',
      '=IFERROR(TEXT((B42-C42)/C42,"0%"),"-")',
      '=IF(B42>C42,"ğŸ“ˆ",IF(B42<C42,"ğŸ“‰","â¡ï¸"))'
    ],
    [
      '="Grievances Closed"',  // Wrap text as formula for setFormulas()
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&TODAY())',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY())-1,1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<"&DATE(YEAR(TODAY()),MONTH(TODAY()),1))',
      '=B43-C43',
      '=IFERROR(TEXT((B43-C43)/C43,"0%"),"-")',
      '=IF(B43>C43,"ğŸ“ˆ",IF(B43<C43,"ğŸ“‰","â¡ï¸"))'
    ],
    [
      '="Cases Won"',  // Wrap text as formula for setFormulas()
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")',
      '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY())-1,1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<"&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")',
      '=B44-C44',
      '=IFERROR(TEXT((B44-C44)/C44,"0%"),"-")',
      '=IF(B44>C44,"ğŸ“ˆ",IF(B44<C44,"ğŸ“‰","â¡ï¸"))'
    ]
  ];
  sheet.getRange('A42:F44').setFormulas(trendData)
    .setHorizontalAlignment('center');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SECTION 9: STATUS LEGEND
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A46').setValue('STATUS LEGEND')
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);
  sheet.getRange('A46:F46').merge();

  var legend = [
    ['ğŸŸ¢ On Track', 'ğŸŸ¡ Due in 7 days', 'ğŸŸ  Due in 3 days', 'ğŸ”´ Overdue', 'âœ… Won', 'âŒ Denied']
  ];
  sheet.getRange('A47:F47').setValues(legend)
    .setHorizontalAlignment('center')
    .setFontSize(10);

  // Auto-resize and format
  sheet.autoResizeColumns(1, 6);
  sheet.setFrozenRows(3);

  // Set minimum column widths
  for (var i = 1; i <= 6; i++) {
    if (sheet.getColumnWidth(i) < 120) {
      sheet.setColumnWidth(i, 120);
    }
  }

  // Hide unused columns (G onwards) - A-F used for data
  var maxCols = sheet.getMaxColumns();
  if (maxCols > 6) {
    sheet.hideColumns(7, maxCols - 6);  // Hide columns G onwards
  }
}

/**
 * Create or recreate the Interactive Dashboard sheet
 * Allows users to select metrics and visualization preferences
 */
function createInteractiveDashboard(ss) {
  var sheet = getOrCreateSheet(ss, SHEETS.INTERACTIVE);
  sheet.clear();

  // Title
  sheet.getRange('A1').setValue('ğŸ¯ Interactive Dashboard')
    .setFontSize(20)
    .setFontWeight('bold')
    .setFontColor(COLORS.PRIMARY_PURPLE);
  sheet.getRange('A1:H1').merge();

  // Instructions
  sheet.getRange('A3').setValue('Select metrics, chart types, and time range. Charts auto-update from live data.')
    .setFontStyle('italic');
  sheet.getRange('A3:H3').merge();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTROL PANEL - ROW 5-6
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var controlLabels = [['Metric 1', 'Chart Type 1', 'Metric 2', 'Chart Type 2', 'Time Range', 'Theme']];
  sheet.getRange('A5:F5').setValues(controlLabels)
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Default selections
  var defaultSelections = [['Total Members', 'Bar Chart', 'Open Grievances', 'Pie Chart', 'All Time', 'Default']];
  sheet.getRange('A6:F6').setValues(defaultSelections)
    .setBackground('#FFF9C4')  // Light yellow highlight for dropdown cells
    .setBorder(true, true, true, true, true, true, '#F59E0B', SpreadsheetApp.BorderStyle.SOLID_MEDIUM);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // METRIC LOOKUP TABLE (Hidden reference data) - Rows 8-16
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A8').setValue('METRIC DATA')
    .setFontWeight('bold')
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A8:C8').merge();

  // Time Range Helper - Calculate filter start date based on E6 selection
  sheet.getRange('E8').setValue('Filter Start:')
    .setFontWeight('bold')
    .setFontSize(10);
  sheet.getRange('F8').setFormula('=SWITCH($E$6,"All Time",DATE(1900,1,1),"This Month",EOMONTH(TODAY(),-1)+1,"This Quarter",DATE(YEAR(TODAY()),FLOOR((MONTH(TODAY())-1)/3)*3+1,1),"This Year",DATE(YEAR(TODAY()),1,1),"Last 30 Days",TODAY()-30,"Last 90 Days",TODAY()-90,DATE(1900,1,1))')
    .setNumberFormat('MM/dd/yyyy')
    .setFontSize(10);

  sheet.getRange('A9:C9').setValues([['Metric Name', 'Value', 'Description']])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Dynamic metric formulas
  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var mLocationCol = getColumnLetter(MEMBER_COLS.WORK_LOCATION);
  var mUnitCol = getColumnLetter(MEMBER_COLS.UNIT);
  var gIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gCategoryCol = getColumnLetter(GRIEVANCE_COLS.ISSUE_CATEGORY);
  var gFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);

  // Date-filtered grievance formulas (uses $F$8 as filter start date)
  var gDateRange = '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gFiledCol + ':' + gFiledCol;
  var dateFilter = ',">="&$F$8';

  var metricData = [
    ['Total Members', '=COUNTA(\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mIdCol + ')-1', 'Total union members'],
    ['Active Stewards', '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")', 'Members marked as stewards'],
    ['Total Grievances', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ',"<>",' + gDateRange + dateFilter + ')', 'Grievances in time range'],
    ['Open Grievances', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open",' + gDateRange + dateFilter + ')', 'Currently open cases'],
    ['Pending Info', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info",' + gDateRange + dateFilter + ')', 'Awaiting information'],
    ['Settled', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled",' + gDateRange + dateFilter + ')', 'Cases settled'],
    ['Won', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*",' + gDateRange + dateFilter + ')', 'Cases won'],
    ['Win Rate', '=IFERROR(ROUND(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*",' + gDateRange + dateFilter + ')/COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ',"<>",' + gDateRange + dateFilter + ')*100,1)&"%","0%")', 'Win percentage']
  ];

  for (var i = 0; i < metricData.length; i++) {
    sheet.getRange(10 + i, 1).setValue(metricData[i][0]);
    sheet.getRange(10 + i, 2).setFormula(metricData[i][1]);
    sheet.getRange(10 + i, 3).setValue(metricData[i][2]);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHART 1 DISPLAY AREA - Rows 19-30
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A19').setFormula('="ğŸ“Š CHART 1: "&$A$6&" ("&$B$6&")"')
    .setFontWeight('bold')
    .setFontSize(12);
  sheet.getRange('A19:D19').merge();

  // Chart 1 data header
  sheet.getRange('A20:D20').setValues([['Category', 'Count', 'Percentage', 'Visual']])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Visual formula that changes based on Chart Type 1 selection (B6)
  // Chart types: Bar Chart, Horizontal Bar, Pie Chart, Line Graph, Area Chart, Sparkline, Progress Bar, Gauge, Sankey Diagram
  var visual1Formula = function(row) {
    return '=IFERROR(SWITCH($B$6,' +
      '"Bar Chart",REPT("â–ˆ",ROUND(B' + row + '/MAX($B$21:$B$25)*10)),' +
      '"Horizontal Bar",REPT("â–“",ROUND(B' + row + '/MAX($B$21:$B$25)*10)),' +
      '"Pie Chart",REPT("â—",ROUND(B' + row + '/SUM($B$21:$B$25)*10))&REPT("â—‹",10-ROUND(B' + row + '/SUM($B$21:$B$25)*10)),' +
      '"Line Graph",SPARKLINE(B' + row + ',{"charttype","line";"color","#7C3AED"}),' +
      '"Area Chart",SPARKLINE({0,B' + row + ',B' + row + '*0.8,B' + row + '*0.3,0},{"charttype","area";"color","#7C3AED"}),' +
      '"Sparkline",SPARKLINE(B' + row + ',{"charttype","bar";"max",MAX($B$21:$B$25);"color1","#7C3AED"}),' +
      '"Progress Bar","["&REPT("â–ˆ",ROUND(B' + row + '/MAX($B$21:$B$25)*10))&REPT("â–‘",10-ROUND(B' + row + '/MAX($B$21:$B$25)*10))&"]",' +
      '"Gauge",IF(B' + row + '/MAX($B$21:$B$25)<0.25,"â—”",IF(B' + row + '/MAX($B$21:$B$25)<0.5,"â—‘",IF(B' + row + '/MAX($B$21:$B$25)<0.75,"â—•","â—")))&" "&C' + row + ',' +
      '"Sankey Diagram","â–"&REPT("â•",ROUND(B' + row + '/MAX($B$21:$B$25)*8))&"â–¶ "&C' + row + ',' +
      'REPT("â–ˆ",ROUND(B' + row + '/MAX($B$21:$B$25)*10))),"")';
  };

  // Chart 1 dynamic data - Status breakdown for grievances (with date filter) or location for members
  // Labels show actual status names or actual location names from data
  var chart1Data = [
    ['=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),"Open",IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),1,1),"Location 1"))',
     '=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open",' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),1,1)))',
     '=IFERROR(ROUND(B21/SUM($B$21:$B$25)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),"Pending Info",IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),2,1),""))',
     '=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info",' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),2,1),"")))',
     '=IFERROR(ROUND(B22/SUM($B$21:$B$25)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),"Settled",IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),3,1),""))',
     '=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled",' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),3,1),"")))',
     '=IFERROR(ROUND(B23/SUM($B$21:$B$25)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),"Closed",IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),4,1),""))',
     '=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Closed",' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),4,1),"")))',
     '=IFERROR(ROUND(B24/SUM($B$21:$B$25)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),"Withdrawn",IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),5,1),""))',
     '=IF(REGEXMATCH($A$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Withdrawn",' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mLocationCol + ':' + mLocationCol + '<>"")),5,1),"")))',
     '=IFERROR(ROUND(B25/SUM($B$21:$B$25)*100,1)&"%","0%")']
  ];

  for (var r = 0; r < chart1Data.length; r++) {
    var rowNum = 21 + r;
    sheet.getRange(rowNum, 1).setFormula(chart1Data[r][0]);
    sheet.getRange(rowNum, 2).setFormula(chart1Data[r][1]);
    sheet.getRange(rowNum, 3).setFormula(chart1Data[r][2]);
    sheet.getRange(rowNum, 4).setFormula(visual1Formula(rowNum)).setFontColor(COLORS.PRIMARY_PURPLE);
  }

  // Chart 1 Total
  sheet.getRange('A26:D26').setValues([['TOTAL', '=SUM(B21:B25)', '100%', '']])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHART 2 DISPLAY AREA - Rows 28-38
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A28').setFormula('="ğŸ“ˆ CHART 2: "&$C$6&" ("&$D$6&")"')
    .setFontWeight('bold')
    .setFontSize(12);
  sheet.getRange('A28:D28').merge();

  // Chart 2 data header
  sheet.getRange('A29:D29').setValues([['Category', 'Count', 'Percentage', 'Visual']])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Visual formula that changes based on Chart Type 2 selection (D6)
  var visual2Formula = function(row) {
    return '=IFERROR(SWITCH($D$6,' +
      '"Bar Chart",REPT("â–ˆ",ROUND(B' + row + '/MAX($B$30:$B$34)*10)),' +
      '"Horizontal Bar",REPT("â–“",ROUND(B' + row + '/MAX($B$30:$B$34)*10)),' +
      '"Pie Chart",REPT("â—",ROUND(B' + row + '/SUM($B$30:$B$34)*10))&REPT("â—‹",10-ROUND(B' + row + '/SUM($B$30:$B$34)*10)),' +
      '"Line Graph",SPARKLINE(B' + row + ',{"charttype","line";"color","#059669"}),' +
      '"Area Chart",SPARKLINE({0,B' + row + ',B' + row + '*0.8,B' + row + '*0.3,0},{"charttype","area";"color","#059669"}),' +
      '"Sparkline",SPARKLINE(B' + row + ',{"charttype","bar";"max",MAX($B$30:$B$34);"color1","#059669"}),' +
      '"Progress Bar","["&REPT("â–ˆ",ROUND(B' + row + '/MAX($B$30:$B$34)*10))&REPT("â–‘",10-ROUND(B' + row + '/MAX($B$30:$B$34)*10))&"]",' +
      '"Gauge",IF(B' + row + '/MAX($B$30:$B$34)<0.25,"â—”",IF(B' + row + '/MAX($B$30:$B$34)<0.5,"â—‘",IF(B' + row + '/MAX($B$30:$B$34)<0.75,"â—•","â—")))&" "&C' + row + ',' +
      '"Sankey Diagram","â–"&REPT("â•",ROUND(B' + row + '/MAX($B$30:$B$34)*8))&"â–¶ "&C' + row + ',' +
      'REPT("â–ˆ",ROUND(B' + row + '/MAX($B$30:$B$34)*10))),"")';
  };

  // Chart 2 dynamic data - Issue categories (with date filter) or units for members
  // Labels show actual category names or actual unit names from data
  var chart2Data = [
    ['=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),1,1),""),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),1,1),""))',
     '=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),1,1),""),' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),1,1),"")))',
     '=IFERROR(ROUND(B30/SUM($B$30:$B$34)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),2,1),""),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),2,1),""))',
     '=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),2,1),""),' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),2,1),"")))',
     '=IFERROR(ROUND(B31/SUM($B$30:$B$34)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),3,1),""),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),3,1),""))',
     '=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),3,1),""),' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),3,1),"")))',
     '=IFERROR(ROUND(B32/SUM($B$30:$B$34)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),4,1),""),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),4,1),""))',
     '=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),4,1),""),' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),4,1),"")))',
     '=IFERROR(ROUND(B33/SUM($B$30:$B$34)*100,1)&"%","0%")'],
    ['=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),5,1),""),IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),5,1),""))',
     '=IF(REGEXMATCH($C$6,"Grievance|Open|Pending|Settled|Won"),COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),5,1),""),' + gDateRange + ',">="&$F$8),COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',IFERROR(INDEX(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mUnitCol + ':' + mUnitCol + '<>"")),5,1),"")))',
     '=IFERROR(ROUND(B34/SUM($B$30:$B$34)*100,1)&"%","0%")']
  ];

  for (var r = 0; r < chart2Data.length; r++) {
    var rowNum = 30 + r;
    sheet.getRange(rowNum, 1).setFormula(chart2Data[r][0]);
    sheet.getRange(rowNum, 2).setFormula(chart2Data[r][1]);
    sheet.getRange(rowNum, 3).setFormula(chart2Data[r][2]);
    sheet.getRange(rowNum, 4).setFormula(visual2Formula(rowNum)).setFontColor(COLORS.UNION_GREEN);
  }

  // Chart 2 Total
  sheet.getRange('A35:D35').setValues([['TOTAL', '=SUM(B30:B34)', '100%', '']])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SUMMARY STATS - Row 37-38
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.getRange('A37').setValue('ğŸ“‹ QUICK STATS')
    .setFontWeight('bold')
    .setFontSize(12)
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor(COLORS.WHITE);
  sheet.getRange('A37:D37').merge();

  sheet.getRange('A38:D38').setValues([['Selected Metric 1', '=VLOOKUP(A6,A10:B17,2,FALSE)', 'Selected Metric 2', '=VLOOKUP(C6,A10:B17,2,FALSE)']])
    .setFontWeight('bold');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DROPDOWN VALIDATIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Metric dropdown options
  var metricOptions = ['Total Members', 'Active Stewards', 'Total Grievances', 'Open Grievances', 'Pending Info', 'Settled', 'Won', 'Win Rate'];
  var metricRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(metricOptions, true)
    .setAllowInvalid(false)
    .build();
  sheet.getRange('A6').setDataValidation(metricRule);  // Metric 1
  sheet.getRange('C6').setDataValidation(metricRule);  // Metric 2

  // Chart type options
  var chartOptions = ['Bar Chart', 'Horizontal Bar', 'Pie Chart', 'Line Graph', 'Area Chart', 'Sparkline', 'Progress Bar', 'Gauge', 'Sankey Diagram'];
  var chartRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(chartOptions, true)
    .setAllowInvalid(false)
    .build();
  sheet.getRange('B6').setDataValidation(chartRule);  // Chart Type 1
  sheet.getRange('D6').setDataValidation(chartRule);  // Chart Type 2

  // Time range options
  var timeOptions = ['All Time', 'This Month', 'This Quarter', 'This Year', 'Last 30 Days', 'Last 90 Days'];
  var timeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(timeOptions, true)
    .setAllowInvalid(false)
    .build();
  sheet.getRange('E6').setDataValidation(timeRule);

  // Theme options
  var themeOptions = ['Default', 'Dark', 'High Contrast', 'Print Friendly'];
  var themeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(themeOptions, true)
    .setAllowInvalid(false)
    .build();
  sheet.getRange('F6').setDataValidation(themeRule);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FORMATTING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sheet.autoResizeColumns(1, 6);
  sheet.setColumnWidth(3, 200);
  sheet.setColumnWidth(4, 150);

  // Add borders to chart areas
  sheet.getRange('A20:D26').setBorder(true, true, true, true, false, false, COLORS.LIGHT_GRAY, SpreadsheetApp.BorderStyle.SOLID);
  sheet.getRange('A29:D35').setBorder(true, true, true, true, false, false, COLORS.LIGHT_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // Hide unused columns (I onwards) - A-H used for data + charts
  var maxCols = sheet.getMaxColumns();
  if (maxCols > 8) {
    sheet.hideColumns(9, maxCols - 8);  // Hide columns I onwards
  }

  // Create initial charts
  refreshInteractiveCharts();
}

/**
 * Refresh/Update embedded charts based on dropdown selections
 * Call this function when dropdowns change or manually via menu
 */
function refreshInteractiveCharts() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.INTERACTIVE);
  if (!sheet) {
    SpreadsheetApp.getUi().alert('Interactive Dashboard not found. Please run CREATE 509 DASHBOARD first.');
    return;
  }

  // Read dropdown selections
  var metric1 = sheet.getRange('A6').getValue();
  var chartType1 = sheet.getRange('B6').getValue();
  var metric2 = sheet.getRange('C6').getValue();
  var chartType2 = sheet.getRange('D6').getValue();

  // Remove existing charts
  var charts = sheet.getCharts();
  charts.forEach(function(chart) {
    sheet.removeChart(chart);
  });

  // Chart type mapping
  var chartTypeMap = {
    'Bar Chart': Charts.ChartType.BAR,
    'Horizontal Bar': Charts.ChartType.BAR,
    'Pie Chart': Charts.ChartType.PIE,
    'Line Graph': Charts.ChartType.LINE,
    'Area Chart': Charts.ChartType.AREA,
    'Sparkline': Charts.ChartType.BAR,
    'Progress Bar': Charts.ChartType.BAR,
    'Gauge': Charts.ChartType.PIE,
    'Sankey Diagram': Charts.ChartType.BAR  // Use stacked bar as Sankey approximation
  };

  // Get chart type or default to COLUMN
  var type1 = chartTypeMap[chartType1] || Charts.ChartType.COLUMN;
  var type2 = chartTypeMap[chartType2] || Charts.ChartType.COLUMN;

  // For "Bar Chart" use COLUMN (vertical), for "Horizontal Bar" use BAR
  if (chartType1 === 'Bar Chart') type1 = Charts.ChartType.COLUMN;
  if (chartType2 === 'Bar Chart') type2 = Charts.ChartType.COLUMN;

  // Create Chart 1 - positioned at column E, rows 19-26
  var chart1Builder = sheet.newChart()
    .setChartType(type1)
    .addRange(sheet.getRange('A21:B25'))  // Category and Count columns
    .setPosition(19, 5, 0, 0)  // Row 19, Column E
    .setOption('title', metric1)
    .setOption('legend', { position: 'bottom' })
    .setOption('width', 350)
    .setOption('height', 250);

  // Apply chart-specific options
  if (type1 === Charts.ChartType.PIE) {
    chart1Builder.setOption('pieHole', 0);
    chart1Builder.setOption('is3D', false);
  } else if (chartType1 === 'Sankey Diagram') {
    // Sankey-style stacked bar with flow colors
    chart1Builder.setOption('colors', ['#7C3AED', '#A78BFA', '#C4B5FD', '#DDD6FE', '#EDE9FE']);
    chart1Builder.setOption('isStacked', true);
    chart1Builder.setOption('bar', { groupWidth: '80%' });
  } else if (type1 === Charts.ChartType.BAR || type1 === Charts.ChartType.COLUMN) {
    chart1Builder.setOption('colors', ['#7C3AED']);
  } else if (type1 === Charts.ChartType.LINE || type1 === Charts.ChartType.AREA) {
    chart1Builder.setOption('colors', ['#7C3AED']);
    chart1Builder.setOption('curveType', 'function');
  }

  var chart1 = chart1Builder.build();
  sheet.insertChart(chart1);

  // Create Chart 2 - positioned at column E, rows 28-35
  var chart2Builder = sheet.newChart()
    .setChartType(type2)
    .addRange(sheet.getRange('A30:B34'))  // Category and Count columns
    .setPosition(28, 5, 0, 0)  // Row 28, Column E
    .setOption('title', metric2)
    .setOption('legend', { position: 'bottom' })
    .setOption('width', 350)
    .setOption('height', 250);

  // Apply chart-specific options
  if (type2 === Charts.ChartType.PIE) {
    chart2Builder.setOption('pieHole', 0);
    chart2Builder.setOption('is3D', false);
  } else if (chartType2 === 'Sankey Diagram') {
    // Sankey-style stacked bar with flow colors
    chart2Builder.setOption('colors', ['#059669', '#34D399', '#6EE7B7', '#A7F3D0', '#D1FAE5']);
    chart2Builder.setOption('isStacked', true);
    chart2Builder.setOption('bar', { groupWidth: '80%' });
  } else if (type2 === Charts.ChartType.BAR || type2 === Charts.ChartType.COLUMN) {
    chart2Builder.setOption('colors', ['#059669']);
  } else if (type2 === Charts.ChartType.LINE || type2 === Charts.ChartType.AREA) {
    chart2Builder.setOption('colors', ['#059669']);
    chart2Builder.setOption('curveType', 'function');
  }

  var chart2 = chart2Builder.build();
  sheet.insertChart(chart2);

  ss.toast('Charts updated!', 'ğŸ“Š Interactive Dashboard', 3);
}

/**
 * Main onEdit trigger - handles all edit events
 * Auto-refreshes Interactive Dashboard charts when dropdowns change
 */
function onEdit(e) {
  // Safety check
  if (!e || !e.range) return;

  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();

  // Handle Interactive Dashboard dropdown changes
  if (sheetName === SHEETS.INTERACTIVE) {
    var row = e.range.getRow();
    var col = e.range.getColumn();

    // Check if edit is in the control panel row (row 6, columns A-F)
    if (row === 6 && col >= 1 && col <= 6) {
      // Small delay to let formulas recalculate
      Utilities.sleep(300);
      refreshInteractiveCharts();
    }
  }

  // Call other onEdit handlers
  if (typeof onEditMultiSelect === 'function') {
    onEditMultiSelect(e);
  }
  if (typeof onEditAutoSync === 'function') {
    onEditAutoSync(e);
  }
}

/**
 * onSelectionChange trigger - highlights entire row when cell selected
 * Works on Member Directory and Grievance Log sheets
 */
function onSelectionChange(e) {
  // Safety check
  if (!e || !e.range) return;

  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();

  // Only apply to Member Directory and Grievance Log
  if (sheetName !== SHEETS.MEMBER_DIR && sheetName !== SHEETS.GRIEVANCE_LOG) return;

  var row = e.range.getRow();

  // Don't highlight header row
  if (row === 1) return;

  // Get the previous highlighted row from properties
  var props = PropertiesService.getDocumentProperties();
  var propKey = 'highlightedRow_' + sheetName;
  var previousRow = props.getProperty(propKey);

  // Clear previous highlight
  if (previousRow && previousRow !== String(row)) {
    var prevRowNum = parseInt(previousRow);
    var lastCol = sheet.getLastColumn();
    if (lastCol > 0) {
      sheet.getRange(prevRowNum, 1, 1, lastCol).setBackground(null);
    }
  }

  // Highlight current row (soft yellow)
  var lastCol = sheet.getLastColumn();
  if (lastCol > 0 && row > 1) {
    sheet.getRange(row, 1, 1, lastCol).setBackground('#FFF9C4');
    props.setProperty(propKey, String(row));
  }
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Get existing sheet or create new one
 * @param {Spreadsheet} ss - Spreadsheet object
 * @param {string} name - Sheet name
 * @returns {Sheet} Sheet object
 */
function getOrCreateSheet(ss, name) {
  var sheet = ss.getSheetByName(name);
  if (sheet) {
    ss.deleteSheet(sheet);
  }
  return ss.insertSheet(name);
}

/**
 * Setup hidden calculation sheets for cross-sheet data sync
 * Calls the full implementation in HiddenSheets.gs
 */
function setupHiddenSheets(ss) {
  // Call the full hidden sheet setup from HiddenSheets.gs
  setupAllHiddenSheets();

  // Install the auto-sync trigger
  installAutoSyncTrigger();
}

// ============================================================================
// DATA VALIDATION
// ============================================================================

/**
 * Setup all data validations for Member Directory and Grievance Log
 */
function setupDataValidations() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var configSheet = ss.getSheetByName(SHEETS.CONFIG);
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!configSheet || !memberSheet || !grievanceSheet) {
    SpreadsheetApp.getUi().alert('Error: Required sheets not found. Please run CREATE_509_DASHBOARD first.');
    return;
  }

  // Member Directory Validations
  // Single-select dropdowns (strict validation)
  setDropdownValidation(memberSheet, MEMBER_COLS.JOB_TITLE, configSheet, CONFIG_COLS.JOB_TITLES);
  setDropdownValidation(memberSheet, MEMBER_COLS.WORK_LOCATION, configSheet, CONFIG_COLS.OFFICE_LOCATIONS);
  setDropdownValidation(memberSheet, MEMBER_COLS.UNIT, configSheet, CONFIG_COLS.UNITS);
  setDropdownValidation(memberSheet, MEMBER_COLS.IS_STEWARD, configSheet, CONFIG_COLS.YES_NO);
  setDropdownValidation(memberSheet, MEMBER_COLS.SUPERVISOR, configSheet, CONFIG_COLS.SUPERVISORS);
  setDropdownValidation(memberSheet, MEMBER_COLS.MANAGER, configSheet, CONFIG_COLS.MANAGERS);
  setDropdownValidation(memberSheet, MEMBER_COLS.INTEREST_LOCAL, configSheet, CONFIG_COLS.YES_NO);
  setDropdownValidation(memberSheet, MEMBER_COLS.INTEREST_CHAPTER, configSheet, CONFIG_COLS.YES_NO);
  setDropdownValidation(memberSheet, MEMBER_COLS.INTEREST_ALLIED, configSheet, CONFIG_COLS.YES_NO);
  setDropdownValidation(memberSheet, MEMBER_COLS.HOME_TOWN, configSheet, CONFIG_COLS.HOME_TOWNS);
  setDropdownValidation(memberSheet, MEMBER_COLS.CONTACT_STEWARD, configSheet, CONFIG_COLS.STEWARDS);

  // Multi-select dropdowns (allow comma-separated values)
  setMultiSelectValidation(memberSheet, MEMBER_COLS.OFFICE_DAYS, configSheet, CONFIG_COLS.OFFICE_DAYS);
  setMultiSelectValidation(memberSheet, MEMBER_COLS.PREFERRED_COMM, configSheet, CONFIG_COLS.COMM_METHODS);
  setMultiSelectValidation(memberSheet, MEMBER_COLS.BEST_TIME, configSheet, CONFIG_COLS.BEST_TIMES);
  setMultiSelectValidation(memberSheet, MEMBER_COLS.COMMITTEES, configSheet, CONFIG_COLS.STEWARD_COMMITTEES);
  setMultiSelectValidation(memberSheet, MEMBER_COLS.ASSIGNED_STEWARD, configSheet, CONFIG_COLS.STEWARDS);

  // Grievance Log Validations
  // Member ID dropdown - links to valid Member IDs from Member Directory
  setMemberIdValidation(grievanceSheet, memberSheet);

  setDropdownValidation(grievanceSheet, GRIEVANCE_COLS.STATUS, configSheet, CONFIG_COLS.GRIEVANCE_STATUS);
  setDropdownValidation(grievanceSheet, GRIEVANCE_COLS.CURRENT_STEP, configSheet, CONFIG_COLS.GRIEVANCE_STEP);
  setDropdownValidation(grievanceSheet, GRIEVANCE_COLS.ISSUE_CATEGORY, configSheet, CONFIG_COLS.ISSUE_CATEGORY);
  setDropdownValidation(grievanceSheet, GRIEVANCE_COLS.ARTICLES, configSheet, CONFIG_COLS.ARTICLES);

  // Note: Unit, Location, Steward columns now use formulas for auto-lookup
  // No need for manual dropdown validation on those columns

  SpreadsheetApp.getActiveSpreadsheet().toast('Data validations applied successfully!', 'âœ… Success', 3);
}

/**
 * Set Member ID validation dropdown from Member Directory
 * @param {Sheet} grievanceSheet - Grievance Log sheet
 * @param {Sheet} memberSheet - Member Directory sheet
 */
function setMemberIdValidation(grievanceSheet, memberSheet) {
  // Get the Member ID column from Member Directory
  var memberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var sourceRange = memberSheet.getRange(memberIdCol + '2:' + memberIdCol + '1000');

  var rule = SpreadsheetApp.newDataValidation()
    .requireValueInRange(sourceRange, true)
    .setAllowInvalid(false)
    .build();

  var targetRange = grievanceSheet.getRange(2, GRIEVANCE_COLS.MEMBER_ID, 998, 1);
  targetRange.setDataValidation(rule);
}

/**
 * Set dropdown validation from Config sheet
 * @param {Sheet} targetSheet - Sheet to apply validation
 * @param {number} targetCol - Column number in target sheet
 * @param {Sheet} configSheet - Config sheet with source values
 * @param {number} sourceCol - Column number in Config sheet
 */
function setDropdownValidation(targetSheet, targetCol, configSheet, sourceCol) {
  // Config data starts at row 3 (row 1 = section headers, row 2 = column headers)
  var sourceRange = configSheet.getRange(3, sourceCol, 100, 1);
  var rule = SpreadsheetApp.newDataValidation()
    .requireValueInRange(sourceRange, true)
    .setAllowInvalid(false)
    .build();

  var targetRange = targetSheet.getRange(2, targetCol, 998, 1);
  targetRange.setDataValidation(rule);
}

/**
 * Set multi-select validation (allows comma-separated values)
 * Shows dropdown for convenience but accepts any text
 * @param {Sheet} targetSheet - Sheet to apply validation
 * @param {number} targetCol - Column number in target sheet
 * @param {Sheet} configSheet - Config sheet with source values
 * @param {number} sourceCol - Column number in Config sheet
 */
function setMultiSelectValidation(targetSheet, targetCol, configSheet, sourceCol) {
  // Config data starts at row 3
  var sourceRange = configSheet.getRange(3, sourceCol, 100, 1);
  var rule = SpreadsheetApp.newDataValidation()
    .requireValueInRange(sourceRange, true)
    .setAllowInvalid(true)  // Allow comma-separated values
    .build();

  var targetRange = targetSheet.getRange(2, targetCol, 998, 1);
  targetRange.setDataValidation(rule);
}

// ============================================================================
// MULTI-SELECT FUNCTIONALITY
// ============================================================================

// Store the target cell for multi-select dialog
var multiSelectTarget_ = null;

/**
 * Show multi-select dialog for the current cell
 * Called from menu or double-click on multi-select column
 */
function showMultiSelectDialog() {
  var sheet = SpreadsheetApp.getActiveSheet();
  var cell = sheet.getActiveCell();
  var sheetName = sheet.getName();

  // Only works on Member Directory
  if (sheetName !== SHEETS.MEMBER_DIR) {
    SpreadsheetApp.getUi().alert('Multi-select is only available in Member Directory.');
    return;
  }

  var col = cell.getColumn();
  var row = cell.getRow();

  // Must be in data row (not header)
  if (row < 2) {
    SpreadsheetApp.getUi().alert('Please select a data cell (row 2 or below).');
    return;
  }

  var config = getMultiSelectConfig(col);
  if (!config) {
    SpreadsheetApp.getUi().alert('This column does not support multi-select.\n\nMulti-select columns: Office Days, Preferred Communication, Best Time, Committees, Assigned Steward(s)');
    return;
  }

  // Store target cell info in PropertiesService for the callback
  var props = PropertiesService.getDocumentProperties();
  props.setProperty('multiSelectRow', row.toString());
  props.setProperty('multiSelectCol', col.toString());

  // Get options from Config sheet
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var configSheet = ss.getSheetByName(SHEETS.CONFIG);
  var options = getConfigValues(configSheet, config.configCol);

  // Get current value and parse into array
  var currentValue = cell.getValue() || '';
  var currentValues = currentValue ? currentValue.split(/,\s*/) : [];

  // Dialog data
  var dialogData = {
    label: config.label,
    options: options,
    currentValues: currentValues
  };

  // Create inline HTML for multi-select dialog
  var htmlContent = '<!DOCTYPE html><html><head><base target="_top"><style>' +
    '*{box-sizing:border-box;font-family:"Google Sans",Arial,sans-serif}' +
    'body{margin:0;padding:16px;background:#fff}' +
    'h3{margin:0 0 12px 0;color:#7C3AED;font-size:16px}' +
    '.options-container{max-height:250px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:8px;padding:8px;margin-bottom:16px}' +
    '.option-item{display:flex;align-items:center;padding:8px 12px;margin:2px 0;border-radius:6px;cursor:pointer;transition:background 0.15s}' +
    '.option-item:hover{background:#f3f4f6}.option-item.selected{background:#ede9fe}' +
    '.option-item input[type="checkbox"]{margin-right:10px;width:18px;height:18px;accent-color:#7C3AED}' +
    '.option-item label{flex:1;cursor:pointer;font-size:14px;color:#1f2937}' +
    '.button-row{display:flex;gap:8px;justify-content:flex-end}' +
    'button{padding:10px 20px;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.15s}' +
    '.btn-primary{background:#7C3AED;color:white}.btn-primary:hover{background:#6d28d9}' +
    '.btn-secondary{background:#f3f4f6;color:#374151}.btn-secondary:hover{background:#e5e7eb}' +
    '.btn-clear{background:#fef2f2;color:#dc2626}.btn-clear:hover{background:#fee2e2}' +
    '.selected-count{font-size:12px;color:#6b7280;margin-bottom:8px}' +
    '.quick-actions{display:flex;gap:8px;margin-bottom:12px}.quick-actions button{padding:6px 12px;font-size:12px}' +
    '</style></head><body>' +
    '<h3 id="dialogTitle">Select Options</h3>' +
    '<div class="quick-actions"><button class="btn-secondary" onclick="selectAll()">Select All</button>' +
    '<button class="btn-clear" onclick="clearAll()">Clear All</button></div>' +
    '<div class="selected-count" id="selectedCount">0 selected</div>' +
    '<div class="options-container" id="optionsContainer"></div>' +
    '<div class="button-row"><button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>' +
    '<button class="btn-primary" onclick="saveSelection()">Save</button></div>' +
    '<script>' +
    'var options=[];var currentSelection=[];' +
    'function initDialog(data){document.getElementById("dialogTitle").textContent="Select "+data.label;options=data.options;currentSelection=data.currentValues||[];renderOptions();updateCount()}' +
    'function renderOptions(){var c=document.getElementById("optionsContainer");c.innerHTML="";options.forEach(function(o,i){var s=currentSelection.indexOf(o)!==-1;var d=document.createElement("div");d.className="option-item"+(s?" selected":"");d.onclick=function(){toggleOption(i)};var cb=document.createElement("input");cb.type="checkbox";cb.id="opt_"+i;cb.checked=s;var l=document.createElement("label");l.htmlFor="opt_"+i;l.textContent=o;d.appendChild(cb);d.appendChild(l);c.appendChild(d)})}' +
    'function toggleOption(i){var o=options[i];var p=currentSelection.indexOf(o);if(p===-1){currentSelection.push(o)}else{currentSelection.splice(p,1)}renderOptions();updateCount()}' +
    'function selectAll(){currentSelection=options.slice();renderOptions();updateCount()}' +
    'function clearAll(){currentSelection=[];renderOptions();updateCount()}' +
    'function updateCount(){document.getElementById("selectedCount").textContent=currentSelection.length+" selected"}' +
    'function saveSelection(){var v=currentSelection.join(", ");google.script.run.withSuccessHandler(function(){google.script.host.close()}).withFailureHandler(function(e){alert("Error: "+e.message)}).applyMultiSelectValue(v)}' +
    '</script>' +
    '<script>initDialog(' + JSON.stringify(dialogData) + ');</script>' +
    '</body></html>';

  var html = HtmlService.createHtmlOutput(htmlContent)
    .setWidth(350)
    .setHeight(420);

  SpreadsheetApp.getUi().showModalDialog(html, 'Multi-Select: ' + config.label);
}

/**
 * Get values from a Config sheet column
 * Note: Row 1 = section headers, Row 2 = column headers, Row 3+ = data
 * @param {Sheet} configSheet - The Config sheet
 * @param {number} col - Column number
 * @returns {Array} Array of non-empty values
 */
function getConfigValues(configSheet, col) {
  var lastRow = configSheet.getLastRow();
  if (lastRow < 3) return [];

  var data = configSheet.getRange(3, col, lastRow - 2, 1).getValues();
  var values = [];
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] && data[i][0].toString().trim() !== '') {
      values.push(data[i][0].toString());
    }
  }
  return values;
}

/**
 * Apply the multi-select value to the stored cell
 * Called from the dialog
 * @param {string} value - Comma-separated selected values
 */
function applyMultiSelectValue(value) {
  var props = PropertiesService.getDocumentProperties();
  var row = parseInt(props.getProperty('multiSelectRow'), 10);
  var col = parseInt(props.getProperty('multiSelectCol'), 10);

  if (!row || !col) {
    throw new Error('Target cell not found. Please try again.');
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  sheet.getRange(row, col).setValue(value);

  // Clear stored properties
  props.deleteProperty('multiSelectRow');
  props.deleteProperty('multiSelectCol');
}

/**
 * Handle edit events to trigger multi-select dialog
 * This is installed as an onEdit trigger
 */
function onEditMultiSelect(e) {
  // Only process single cell edits
  if (!e || !e.range) return;

  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();

  // Only Member Directory
  if (sheetName !== SHEETS.MEMBER_DIR) return;

  var col = e.range.getColumn();
  var row = e.range.getRow();

  // Skip header row
  if (row < 2) return;

  // Check if this is a multi-select column
  var config = getMultiSelectConfig(col);
  if (!config) return;

  // If user typed something, show the dialog to help them select properly
  // Only trigger if the new value isn't already comma-separated (user might be pasting)
  var newValue = e.value || '';
  var oldValue = e.oldValue || '';

  // If user cleared the cell or pasted valid data, don't interrupt
  if (newValue === '' || newValue.indexOf(',') !== -1) return;

  // Show helpful toast
  SpreadsheetApp.getActiveSpreadsheet().toast(
    'Tip: Use Dashboard menu > "Multi-Select Editor" for easier selection of multiple values.',
    config.label,
    5
  );
}

/**
 * Handle selection change to auto-open multi-select dialog
 * This is installed as an onSelectionChange trigger
 */
function onSelectionChangeMultiSelect(e) {
  // Only process if we have a valid range
  if (!e || !e.range) return;

  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();

  // Only Member Directory
  if (sheetName !== SHEETS.MEMBER_DIR) return;

  var col = e.range.getColumn();
  var row = e.range.getRow();

  // Skip header row and multi-cell selections
  if (row < 2) return;
  if (e.range.getNumRows() > 1 || e.range.getNumColumns() > 1) return;

  // Check if this is a multi-select column
  var config = getMultiSelectConfig(col);
  if (!config) return;

  // Check if we already showed dialog for this cell (avoid repeated opens)
  var props = PropertiesService.getDocumentProperties();
  var lastCell = props.getProperty('lastMultiSelectCell');
  var currentCell = row + ',' + col;

  if (lastCell === currentCell) return;

  // Store current cell
  props.setProperty('lastMultiSelectCell', currentCell);

  // Auto-open the multi-select dialog
  showMultiSelectDialog();
}

/**
 * Install the multi-select auto-open trigger
 * Run this once to enable auto-open on cell selection
 */
function installMultiSelectTrigger() {
  var ui = SpreadsheetApp.getUi();

  // Note: onSelectionChange triggers cannot be created programmatically
  // User must set this up manually in Apps Script editor
  ui.alert('â˜‘ï¸ Multi-Select Auto-Open Setup',
    'To enable auto-open for multi-select cells:\n\n' +
    '1. Go to Extensions â†’ Apps Script\n' +
    '2. Click the clock icon (Triggers) in the left sidebar\n' +
    '3. Click "+ Add Trigger"\n' +
    '4. Choose function: onSelectionChangeMultiSelect\n' +
    '5. Select event type: "On change" or "On edit"\n' +
    '6. Click Save\n\n' +
    'Alternatively, use the manual method:\n' +
    'â€¢ Select a multi-select cell\n' +
    'â€¢ Go to Tools â†’ Multi-Select â†’ Open Editor',
    ui.ButtonSet.OK);
}

/**
 * Remove the multi-select auto-open trigger
 */
function removeMultiSelectTrigger() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var triggers = ScriptApp.getUserTriggers(ss);
  var removed = false;

  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'onSelectionChangeMultiSelect') {
      ScriptApp.deleteTrigger(trigger);
      removed = true;
    }
  });

  if (removed) {
    SpreadsheetApp.getUi().alert('Multi-Select auto-open has been disabled.');
  } else {
    SpreadsheetApp.getUi().alert('No multi-select trigger was found.');
  }
}

// ============================================================================
// DIAGNOSE FUNCTION
// ============================================================================

/**
 * System health check - validates sheets and column counts
 */
function DIAGNOSE_SETUP() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();
  var report = [];

  report.push('ğŸ” 509 DASHBOARD DIAGNOSTIC REPORT');
  report.push('================================');
  report.push('');

  // Check all required sheets (core + dashboard sheets)
  var requiredSheets = [
    SHEETS.CONFIG,
    SHEETS.MEMBER_DIR,
    SHEETS.GRIEVANCE_LOG,
    SHEETS.DASHBOARD,
    SHEETS.INTERACTIVE
  ];

  report.push('ğŸ“‹ SHEET CHECK:');
  var allSheetsPresent = true;
  requiredSheets.forEach(function(sheetName) {
    var sheet = ss.getSheetByName(sheetName);
    if (sheet) {
      report.push('  âœ… ' + sheetName);
    } else {
      report.push('  âŒ ' + sheetName + ' - MISSING');
      allSheetsPresent = false;
    }
  });

  report.push('');

  // Check column counts
  report.push('ğŸ“Š COLUMN CHECK:');

  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (memberSheet) {
    var memberCols = memberSheet.getLastColumn();
    var expectedMemberCols = 31;
    if (memberCols >= expectedMemberCols) {
      report.push('  âœ… Member Directory: ' + memberCols + ' columns (expected ' + expectedMemberCols + ')');
    } else {
      report.push('  âš ï¸ Member Directory: ' + memberCols + ' columns (expected ' + expectedMemberCols + ')');
    }
  }

  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (grievanceSheet) {
    var grievanceCols = grievanceSheet.getLastColumn();
    var expectedGrievanceCols = 34;
    if (grievanceCols >= expectedGrievanceCols) {
      report.push('  âœ… Grievance Log: ' + grievanceCols + ' columns (expected ' + expectedGrievanceCols + ')');
    } else {
      report.push('  âš ï¸ Grievance Log: ' + grievanceCols + ' columns (expected ' + expectedGrievanceCols + ')');
    }
  }

  report.push('');

  // Check hidden sheets (5 hidden calculation sheets)
  report.push('ğŸ”’ HIDDEN SHEETS:');
  var hiddenSheets = [
    SHEETS.GRIEVANCE_CALC,
    SHEETS.GRIEVANCE_FORMULAS,
    SHEETS.MEMBER_LOOKUP,
    SHEETS.STEWARD_CONTACT_CALC,
    SHEETS.DASHBOARD_CALC
  ];

  hiddenSheets.forEach(function(sheetName) {
    var sheet = ss.getSheetByName(sheetName);
    if (sheet) {
      report.push('  âœ… ' + sheetName + (sheet.isSheetHidden() ? ' (hidden)' : ' (visible)'));
    } else {
      report.push('  âš ï¸ ' + sheetName + ' - not created');
    }
  });

  report.push('');
  report.push('================================');
  report.push(allSheetsPresent ? 'âœ… Core sheets OK' : 'âŒ Some sheets missing');

  // Display report
  ui.alert('Diagnostic Report', report.join('\n'), ui.ButtonSet.OK);

  // Also log it
  Logger.log(report.join('\n'));
}

// ============================================================================
// REPAIR FUNCTION
// ============================================================================

/**
 * Repair dashboard - recreates hidden sheets, triggers, and syncs data
 */
function REPAIR_DASHBOARD() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();

  var response = ui.alert(
    'ğŸ”§ Repair Dashboard',
    'This will:\n\n' +
    'â€¢ Recreate all 5 hidden calculation sheets with formulas\n' +
    'â€¢ Install auto-sync trigger\n' +
    'â€¢ Sync all cross-sheet data\n' +
    'â€¢ Reapply data validations\n\n' +
    'Your data will NOT be affected.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  ss.toast('Repairing dashboard...', 'ğŸ”§ Repair', 3);

  try {
    // Use the full repair function from HiddenSheets.gs
    repairAllHiddenSheets();

    // Also reapply data validations
    setupDataValidations();

    // Create Menu Checklist sheet
    createMenuChecklistSheet_();

    // Final message handled by repairAllHiddenSheets
  } catch (error) {
    Logger.log('Error in REPAIR_DASHBOARD: ' + error.message);
    ui.alert('âŒ Error', 'Repair failed: ' + error.message, ui.ButtonSet.OK);
  }
}

/**
 * Creates the Menu Checklist sheet with all menu items
 * Called automatically during dashboard repair/creation
 * @private
 */
function createMenuChecklistSheet_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetName = SHEETS.MENU_CHECKLIST || 'Menu Checklist';

  var sheet = ss.getSheetByName(sheetName);
  if (sheet) {
    sheet.clear();
  } else {
    sheet = ss.insertSheet(sheetName);
  }

  // Menu items organized by optimal testing order
  var menuItems = [
    // â•â•â• PHASE 1: Foundation & Setup (Test these first!) â•â•â•
    ['1ï¸âƒ£ Foundation', 'ğŸ—ï¸ Setup', 'ğŸ”§ REPAIR DASHBOARD', 'REPAIR_DASHBOARD'],
    ['1ï¸âƒ£ Foundation', 'âš™ï¸ Administrator', 'ğŸ” DIAGNOSE SETUP', 'DIAGNOSE_SETUP'],
    ['1ï¸âƒ£ Foundation', 'âš™ï¸ Administrator', 'ğŸ” Verify Hidden Sheets', 'verifyHiddenSheets'],
    ['1ï¸âƒ£ Foundation', 'âš™ï¸ Admin > Setup', 'ğŸ”§ Setup All Hidden Sheets', 'setupAllHiddenSheets'],
    ['1ï¸âƒ£ Foundation', 'âš™ï¸ Admin > Setup', 'ğŸ”§ Repair All Hidden Sheets', 'repairAllHiddenSheets'],
    ['1ï¸âƒ£ Foundation', 'ğŸ—ï¸ Setup', 'âš™ï¸ Setup Data Validations', 'setupDataValidations'],
    ['1ï¸âƒ£ Foundation', 'ğŸ—ï¸ Setup', 'ğŸ¨ Setup ADHD Defaults', 'setupADHDDefaults'],

    // â•â•â• PHASE 2: Triggers & Data Sync â•â•â•
    ['2ï¸âƒ£ Sync', 'âš™ï¸ Admin > Setup', 'âš¡ Install Auto-Sync Trigger', 'installAutoSyncTrigger'],
    ['2ï¸âƒ£ Sync', 'âš™ï¸ Admin > Sync', 'ğŸ”„ Sync All Data Now', 'syncAllData'],
    ['2ï¸âƒ£ Sync', 'âš™ï¸ Admin > Sync', 'ğŸ”„ Sync Grievance â†’ Members', 'syncGrievanceToMemberDirectory'],
    ['2ï¸âƒ£ Sync', 'âš™ï¸ Admin > Sync', 'ğŸ”„ Sync Members â†’ Grievances', 'syncMemberToGrievanceLog'],
    ['2ï¸âƒ£ Sync', 'âš™ï¸ Admin > Setup', 'ğŸš« Remove Auto-Sync Trigger', 'removeAutoSyncTrigger'],

    // â•â•â• PHASE 3: Core Dashboards â•â•â•
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'ğŸ“Š Smart Dashboard (Auto-Detect)', 'showSmartDashboard'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'ğŸ¯ Interactive Dashboard', 'showInteractiveDashboardTab'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'ğŸ“‹ View Active Grievances', 'viewActiveGrievances'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'ğŸ“± Mobile Dashboard', 'showMobileDashboard'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'ğŸ“± Get Mobile App URL', 'showWebAppUrl'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ‘¤ Dashboard', 'âš¡ Quick Actions', 'showQuickActionsMenu'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ“Š Sheet Manager', 'ğŸ“Š Rebuild Dashboard', 'rebuildDashboard'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ“Š Sheet Manager', 'ğŸ“ˆ Refresh Interactive Charts', 'refreshInteractiveCharts'],
    ['3ï¸âƒ£ Dashboards', 'ğŸ“Š Sheet Manager', 'ğŸ”„ Refresh All Formulas', 'refreshAllFormulas'],

    // â•â•â• PHASE 4: Search â•â•â•
    ['4ï¸âƒ£ Search', 'ğŸ” Search', 'ğŸ” Search Members', 'searchMembers'],

    // â•â•â• PHASE 5: Grievance Management â•â•â•
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'â• Start New Grievance', 'startNewGrievance'],
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'ğŸ”„ Refresh Grievance Formulas', 'recalcAllGrievancesBatched'],
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'ğŸ”„ Refresh Member Directory Data', 'refreshMemberDirectoryFormulas'],
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'ğŸ”— Setup Live Grievance Links', 'setupLiveGrievanceFormulas'],
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'ğŸ‘¤ Setup Member ID Dropdown', 'setupGrievanceMemberDropdown'],
    ['5ï¸âƒ£ Grievances', 'ğŸ‘¤ Grievance Tools', 'ğŸ”§ Fix Overdue Text Data', 'fixOverdueTextToNumbers'],

    // â•â•â• PHASE 6: Google Drive â•â•â•
    ['6ï¸âƒ£ Drive', 'ğŸ“Š Google Drive', 'ğŸ“ Setup Folder for Grievance', 'setupDriveFolderForGrievance'],
    ['6ï¸âƒ£ Drive', 'ğŸ“Š Google Drive', 'ğŸ“ View Grievance Files', 'showGrievanceFiles'],
    ['6ï¸âƒ£ Drive', 'ğŸ“Š Google Drive', 'ğŸ“ Batch Create Folders', 'batchCreateGrievanceFolders'],

    // â•â•â• PHASE 7: Calendar â•â•â•
    ['7ï¸âƒ£ Calendar', 'ğŸ“Š Calendar', 'ğŸ“… Sync Deadlines to Calendar', 'syncDeadlinesToCalendar'],
    ['7ï¸âƒ£ Calendar', 'ğŸ“Š Calendar', 'ğŸ“… View Upcoming Deadlines', 'showUpcomingDeadlinesFromCalendar'],
    ['7ï¸âƒ£ Calendar', 'ğŸ“Š Calendar', 'ğŸ—‘ï¸ Clear Calendar Events', 'clearAllCalendarEvents'],

    // â•â•â• PHASE 8: Notifications â•â•â•
    ['8ï¸âƒ£ Notify', 'ğŸ“Š Notifications', 'âš™ï¸ Notification Settings', 'showNotificationSettings'],
    ['8ï¸âƒ£ Notify', 'ğŸ“Š Notifications', 'ğŸ§ª Test Notifications', 'testDeadlineNotifications'],

    // â•â•â• PHASE 9: Accessibility & Theming â•â•â•
    ['9ï¸âƒ£ Access', 'ğŸ”§ ADHD', 'â™¿ ADHD Control Panel', 'showADHDControlPanel'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ ADHD', 'ğŸ¯ Focus Mode', 'activateFocusMode'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ ADHD', 'ğŸ”² Toggle Zebra Stripes', 'toggleZebraStripes'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ ADHD', 'ğŸ“ Quick Capture', 'showQuickCaptureNotepad'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ ADHD', 'ğŸ… Pomodoro Timer', 'startPomodoroTimer'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ Theming', 'ğŸ¨ Theme Manager', 'showThemeManager'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ Theming', 'ğŸŒ™ Toggle Dark Mode', 'quickToggleDarkMode'],
    ['9ï¸âƒ£ Access', 'ğŸ”§ Theming', 'ğŸ”„ Reset Theme', 'resetToDefaultTheme'],

    // â•â•â• PHASE 10: Productivity Tools â•â•â•
    ['ğŸ”Ÿ Tools', 'ğŸ”§ Multi-Select', 'ğŸ“ Open Editor', 'showMultiSelectDialog'],
    ['ğŸ”Ÿ Tools', 'ğŸ”§ Multi-Select', 'âš¡ Enable Auto-Open', 'installMultiSelectTrigger'],
    ['ğŸ”Ÿ Tools', 'ğŸ”§ Multi-Select', 'ğŸš« Disable Auto-Open', 'removeMultiSelectTrigger'],

    // â•â•â• PHASE 11: Performance & Cache â•â•â•
    ['1ï¸âƒ£1ï¸âƒ£ Perf', 'ğŸ”§ Cache', 'ğŸ—„ï¸ Cache Status', 'showCacheStatusDashboard'],
    ['1ï¸âƒ£1ï¸âƒ£ Perf', 'ğŸ”§ Cache', 'ğŸ”¥ Warm Up Caches', 'warmUpCaches'],
    ['1ï¸âƒ£1ï¸âƒ£ Perf', 'ğŸ”§ Cache', 'ğŸ—‘ï¸ Clear All Caches', 'invalidateAllCaches'],

    // â•â•â• PHASE 12: Validation â•â•â•
    ['1ï¸âƒ£2ï¸âƒ£ Valid', 'ğŸ”§ Validation', 'ğŸ” Run Bulk Validation', 'runBulkValidation'],
    ['1ï¸âƒ£2ï¸âƒ£ Valid', 'ğŸ”§ Validation', 'âš™ï¸ Validation Settings', 'showValidationSettings'],
    ['1ï¸âƒ£2ï¸âƒ£ Valid', 'ğŸ”§ Validation', 'ğŸ§¹ Clear Indicators', 'clearValidationIndicators'],
    ['1ï¸âƒ£2ï¸âƒ£ Valid', 'ğŸ”§ Validation', 'âš¡ Install Validation Trigger', 'installValidationTrigger'],

    // â•â•â• PHASE 13: Testing (Run last to verify everything) â•â•â•
    ['1ï¸âƒ£3ï¸âƒ£ Test', 'ğŸ§ª Testing', 'ğŸ§ª Run All Tests', 'runAllTests'],
    ['1ï¸âƒ£3ï¸âƒ£ Test', 'ğŸ§ª Testing', 'âš¡ Run Quick Tests', 'runQuickTests'],
    ['1ï¸âƒ£3ï¸âƒ£ Test', 'ğŸ§ª Testing', 'ğŸ“Š View Test Results', 'viewTestResults']
  ];

  // Build rows with header
  var rows = [['âœ“', 'Phase', 'Menu', 'Item', 'Function', 'Notes']];
  for (var i = 0; i < menuItems.length; i++) {
    rows.push([false, menuItems[i][0], menuItems[i][1], menuItems[i][2], menuItems[i][3], '']);
  }

  // Write all data
  sheet.getRange(1, 1, rows.length, 6).setValues(rows);

  // Format header
  sheet.getRange(1, 1, 1, 6)
    .setFontWeight('bold')
    .setBackground(COLORS.PRIMARY_PURPLE || '#7C3AED')
    .setFontColor(COLORS.WHITE || '#FFFFFF')
    .setHorizontalAlignment('center');

  // Add checkboxes
  if (rows.length > 1) {
    sheet.getRange(2, 1, rows.length - 1, 1).insertCheckboxes();
  }

  // Set column widths
  sheet.setColumnWidth(1, 40);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 150);
  sheet.setColumnWidth(4, 250);
  sheet.setColumnWidth(5, 250);
  sheet.setColumnWidth(6, 200);

  // Freeze header
  sheet.setFrozenRows(1);

  // Alternating colors
  for (var r = 2; r <= rows.length; r++) {
    if (r % 2 === 0) {
      sheet.getRange(r, 1, 1, 6).setBackground('#F9FAFB');
    }
  }

  // Conditional formatting for checked items
  var rule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied('=$A2=TRUE')
    .setBackground('#E8F5E9')
    .setRanges([sheet.getRange(2, 1, rows.length - 1, 6)])
    .build();
  sheet.setConditionalFormatRules([rule]);

  return sheet;
}

// ============================================================================
// MENU HANDLER FUNCTIONS
// ============================================================================

function searchMembers() {
  showDesktopSearch();
}

/**
 * Show desktop search dialog
 */
function showDesktopSearch() {
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top">' +
    '<style>' +
    '*{box-sizing:border-box;margin:0;padding:0}' +
    'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f8fafc;color:#1e293b}' +
    '.header{background:linear-gradient(135deg,#7C3AED 0%,#5B21B6 100%);color:white;padding:24px 30px}' +
    '.header h1{font-size:24px;font-weight:600;margin-bottom:8px}' +
    '.header p{opacity:0.9;font-size:14px}' +
    '.search-section{padding:20px 30px;background:white;border-bottom:1px solid #e2e8f0}' +
    '.search-input{width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px}' +
    '.search-input:focus{outline:none;border-color:#7C3AED}' +
    '.results{padding:20px 30px;max-height:400px;overflow-y:auto}' +
    '.result-card{background:white;border-radius:12px;padding:16px;border:1px solid #e2e8f0;margin-bottom:12px;cursor:pointer}' +
    '.result-card:hover{border-color:#7C3AED;box-shadow:0 4px 12px rgba(124,58,237,0.15)}' +
    '.result-name{font-size:16px;font-weight:600;color:#1e293b}' +
    '.result-details{font-size:13px;color:#64748b;margin-top:4px}' +
    '.result-id{font-size:11px;color:#94a3b8;font-family:monospace}' +
    '.empty{text-align:center;padding:40px;color:#94a3b8}' +
    '.footer{padding:16px 30px;background:white;border-top:1px solid #e2e8f0;text-align:right}' +
    '.close-btn{padding:10px 24px;background:#64748b;color:white;border:none;border-radius:8px;cursor:pointer}' +
    '</style></head><body>' +
    '<div class="header"><h1>ğŸ” Search Members</h1><p>Search by name, ID, email, or location</p></div>' +
    '<div class="search-section"><input type="text" class="search-input" id="q" placeholder="Type to search..." autofocus></div>' +
    '<div class="results" id="results"><div class="empty">Type at least 2 characters to search</div></div>' +
    '<div class="footer"><button class="close-btn" onclick="google.script.host.close()">Close</button></div>' +
    '<script>' +
    'var timer;' +
    'document.getElementById("q").addEventListener("input",function(){' +
    '  clearTimeout(timer);' +
    '  timer=setTimeout(doSearch,300);' +
    '});' +
    'function doSearch(){' +
    '  var q=document.getElementById("q").value;' +
    '  if(q.length<2){document.getElementById("results").innerHTML="<div class=\\"empty\\">Type at least 2 characters</div>";return;}' +
    '  document.getElementById("results").innerHTML="<div class=\\"empty\\">Searching...</div>";' +
    '  google.script.run.withSuccessHandler(showResults).searchMembersData(q);' +
    '}' +
    'function showResults(data){' +
    '  if(!data||data.length===0){document.getElementById("results").innerHTML="<div class=\\"empty\\">No results found</div>";return;}' +
    '  var html="";' +
    '  data.forEach(function(r,i){' +
    '    html+="<div class=\\"result-card\\" onclick=\\"goTo("+i+")\\">";' +
    '    html+="<div class=\\"result-name\\">"+r.name+"</div>";' +
    '    html+="<div class=\\"result-details\\">"+r.location+" â€¢ "+r.jobTitle+"</div>";' +
    '    html+="<div class=\\"result-id\\">"+r.id+" â€¢ "+r.email+"</div></div>";' +
    '  });' +
    '  document.getElementById("results").innerHTML=html;' +
    '  window.searchResults=data;' +
    '}' +
    'function goTo(i){' +
    '  var r=window.searchResults[i];' +
    '  google.script.run.withSuccessHandler(function(){google.script.host.close();}).navigateToMemberRow(r.row);' +
    '}' +
    '</script></body></html>'
  ).setWidth(600).setHeight(550);
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ” Search Members');
}

/**
 * Search members data for the search dialog
 */
function searchMembersData(query) {
  var results = [];
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (!sheet || sheet.getLastRow() < 2) return results;

  var q = (query || '').toLowerCase();
  var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, Math.max(MEMBER_COLS.EMAIL, MEMBER_COLS.WORK_LOCATION, MEMBER_COLS.JOB_TITLE)).getValues();

  data.forEach(function(row, index) {
    var id = row[MEMBER_COLS.MEMBER_ID - 1] || '';
    var firstName = row[MEMBER_COLS.FIRST_NAME - 1] || '';
    var lastName = row[MEMBER_COLS.LAST_NAME - 1] || '';
    var email = row[MEMBER_COLS.EMAIL - 1] || '';
    var location = row[MEMBER_COLS.WORK_LOCATION - 1] || '';
    var jobTitle = row[MEMBER_COLS.JOB_TITLE - 1] || '';

    var searchable = (id + ' ' + firstName + ' ' + lastName + ' ' + email + ' ' + location + ' ' + jobTitle).toLowerCase();
    if (searchable.indexOf(q) !== -1) {
      results.push({
        id: id,
        name: (firstName + ' ' + lastName).trim() || 'Unknown',
        email: email || 'No email',
        location: location || 'Unknown location',
        jobTitle: jobTitle || 'Unknown title',
        row: index + 2
      });
    }
  });

  return results.slice(0, 50); // Limit to 50 results
}

/**
 * Navigate to a member row
 */
function navigateToMemberRow(row) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (sheet) {
    ss.setActiveSheet(sheet);
    sheet.setActiveRange(sheet.getRange(row, 1));
  }
}

/**
 * Show smart dashboard (auto-detect device)
 */
function showSmartDashboard() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  var totalMembers = memberSheet ? Math.max(0, memberSheet.getLastRow() - 1) : 0;
  var totalGrievances = grievanceSheet ? Math.max(0, grievanceSheet.getLastRow() - 1) : 0;
  var openGrievances = 0;

  if (grievanceSheet && totalGrievances > 0) {
    var statusData = grievanceSheet.getRange(2, GRIEVANCE_COLS.STATUS, totalGrievances, 1).getValues();
    statusData.forEach(function(row) {
      if (row[0] === 'Open' || row[0] === 'Pending Info') openGrievances++;
    });
  }

  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top">' +
    '<style>' +
    '*{box-sizing:border-box;margin:0;padding:0}' +
    'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5}' +
    '.header{background:linear-gradient(135deg,#1a73e8,#1557b0);color:white;padding:24px;text-align:center}' +
    '.header h1{font-size:24px;margin-bottom:8px}' +
    '.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:20px}' +
    '.stat{background:white;padding:24px;border-radius:12px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.08)}' +
    '.stat-value{font-size:36px;font-weight:bold;color:#1a73e8}' +
    '.stat-label{font-size:13px;color:#666;margin-top:8px}' +
    '.actions{padding:0 20px 20px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}' +
    '.action-btn{background:white;border:none;padding:16px;border-radius:12px;text-align:left;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.08)}' +
    '.action-btn:hover{background:#e8f0fe}' +
    '.action-icon{font-size:24px;margin-bottom:8px}' +
    '.action-label{font-weight:500}' +
    '</style></head><body>' +
    '<div class="header"><h1>ğŸ“Š 509 Dashboard</h1></div>' +
    '<div class="stats">' +
    '<div class="stat"><div class="stat-value">' + totalMembers + '</div><div class="stat-label">Total Members</div></div>' +
    '<div class="stat"><div class="stat-value">' + totalGrievances + '</div><div class="stat-label">Total Grievances</div></div>' +
    '<div class="stat"><div class="stat-value">' + openGrievances + '</div><div class="stat-label">Open Cases</div></div>' +
    '</div>' +
    '<div class="actions">' +
    '<button class="action-btn" onclick="google.script.run.searchMembers();google.script.host.close()"><div class="action-icon">ğŸ”</div><div class="action-label">Search Members</div></button>' +
    '<button class="action-btn" onclick="google.script.run.viewActiveGrievances();google.script.host.close()"><div class="action-icon">ğŸ“‹</div><div class="action-label">View Grievances</div></button>' +
    '</div>' +
    '</body></html>'
  ).setWidth(500).setHeight(400);
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“Š Dashboard');
}

/**
 * Show cache status dashboard
 */
function showCacheStatusDashboard() {
  var cache = CacheService.getScriptCache();
  var cacheKeys = ['memberMeta', 'grievanceMeta', 'configData'];
  var status = [];

  cacheKeys.forEach(function(key) {
    var data = cache.get(key);
    status.push({
      key: key,
      cached: data ? 'Yes' : 'No',
      size: data ? Math.round(data.length / 1024) + ' KB' : '0 KB'
    });
  });

  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top">' +
    '<style>' +
    'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;padding:20px;background:#f5f5f5}' +
    'h2{margin-bottom:16px;color:#333}' +
    'table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}' +
    'th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #eee}' +
    'th{background:#f8f9fa;font-weight:600}' +
    '.yes{color:#059669;font-weight:500}' +
    '.no{color:#dc2626}' +
    '.btn{margin-top:16px;padding:10px 20px;background:#1a73e8;color:white;border:none;border-radius:6px;cursor:pointer}' +
    '.btn:hover{background:#1557b0}' +
    '</style></head><body>' +
    '<h2>ğŸ—„ï¸ Cache Status</h2>' +
    '<table><tr><th>Cache Key</th><th>Cached</th><th>Size</th></tr>' +
    status.map(function(s) {
      return '<tr><td>' + s.key + '</td><td class="' + (s.cached === 'Yes' ? 'yes' : 'no') + '">' + s.cached + '</td><td>' + s.size + '</td></tr>';
    }).join('') +
    '</table>' +
    '<button class="btn" onclick="google.script.run.clearAllCaches();google.script.host.close()">Clear All Caches</button>' +
    '</body></html>'
  ).setWidth(400).setHeight(300);
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ—„ï¸ Cache Status');
}

/**
 * Clear all caches
 */
function clearAllCaches() {
  var cache = CacheService.getScriptCache();
  cache.removeAll(['memberMeta', 'grievanceMeta', 'configData']);
  SpreadsheetApp.getActiveSpreadsheet().toast('All caches cleared!', 'âœ… Success', 3);
}

function viewActiveGrievances() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (sheet) {
    ss.setActiveSheet(sheet);
  }
}

function startNewGrievance() {
  SpreadsheetApp.getUi().alert('Start New Grievance feature - Coming soon!\n\nFor now, add grievances directly to the Grievance Log sheet.');
}

/**
 * Show mobile-friendly dashboard
 */
function showMobileDashboard() {
  var stats = getMobileDashboardStats_();
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><style>*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;padding:0;margin:0;background:#f5f5f5}.header{background:linear-gradient(135deg,#1a73e8,#1557b0);color:white;padding:20px}.header h1{margin:0;font-size:24px}.container{padding:15px}.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}.stat-card{background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);text-align:center}.stat-value{font-size:32px;font-weight:bold;color:#1a73e8}.stat-label{font-size:13px;color:#666;text-transform:uppercase}.section-title{font-size:16px;font-weight:600;color:#333;margin:20px 0 12px;padding-left:5px}.action-btn{background:white;border:none;padding:16px;margin-bottom:10px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);width:100%;text-align:left;display:flex;align-items:center;gap:15px;font-size:15px;cursor:pointer;min-height:60px}.action-btn:active{transform:scale(0.98)}.action-icon{font-size:24px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#e8f0fe;border-radius:10px}.action-label{font-weight:500}.action-desc{font-size:12px;color:#666}.fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;background:#1a73e8;color:white;border:none;border-radius:50%;font-size:24px;box-shadow:0 4px 12px rgba(0,0,0,0.3);cursor:pointer}</style></head><body><div class="header"><h1>509 Dashboard</h1><div style="font-size:14px;opacity:0.9">Mobile View</div></div><div class="container"><div class="stats"><div class="stat-card"><div class="stat-value">' + stats.totalGrievances + '</div><div class="stat-label">Total</div></div><div class="stat-card"><div class="stat-value">' + stats.activeGrievances + '</div><div class="stat-label">Active</div></div><div class="stat-card"><div class="stat-value">' + stats.pendingGrievances + '</div><div class="stat-label">Pending</div></div><div class="stat-card"><div class="stat-value">' + stats.overdueGrievances + '</div><div class="stat-label">Overdue</div></div></div><div class="section-title">Quick Actions</div><button class="action-btn" onclick="google.script.run.viewActiveGrievances();google.script.host.close()"><div class="action-icon">List</div><div><div class="action-label">View Grievances</div><div class="action-desc">Browse all grievances</div></div></button><button class="action-btn" onclick="google.script.run.showDesktopSearch();google.script.host.close()"><div class="action-icon">Find</div><div><div class="action-label">Search</div><div class="action-desc">Find grievances or members</div></div></button></div><button class="fab" onclick="location.reload()">Refresh</button></body></html>'
  ).setWidth(400).setHeight(700);
  SpreadsheetApp.getUi().showModalDialog(html, 'Mobile Dashboard');
}

/**
 * Get dashboard stats for mobile view
 */
function getMobileDashboardStats_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!sheet || sheet.getLastRow() <= 1) return { totalGrievances: 0, activeGrievances: 0, pendingGrievances: 0, overdueGrievances: 0 };
  var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, GRIEVANCE_COLS.DAYS_TO_DEADLINE).getValues();
  var stats = { totalGrievances: data.length, activeGrievances: 0, pendingGrievances: 0, overdueGrievances: 0 };
  data.forEach(function(row) {
    var status = row[GRIEVANCE_COLS.STATUS - 1];
    var daysTo = row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];
    if (status && status !== 'Resolved' && status !== 'Withdrawn' && status !== 'Closed') stats.activeGrievances++;
    if (status === 'Pending Info') stats.pendingGrievances++;
    if (daysTo !== null && daysTo !== '' && daysTo < 0 && status === 'Open') stats.overdueGrievances++;
  });
  return stats;
}

/**
 * Show quick actions menu based on current selection
 */
function showQuickActionsMenu() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var name = sheet.getName();
  var selection = sheet.getActiveRange();
  if (!selection) { SpreadsheetApp.getUi().alert('Please select a row first.'); return; }
  var row = selection.getRow();
  if (row < 2) { SpreadsheetApp.getUi().alert('Please select a data row, not header.'); return; }
  if (name === SHEETS.MEMBER_DIR) showMemberQuickActions_(row);
  else if (name === SHEETS.GRIEVANCE_LOG) showGrievanceQuickActions_(row);
  else SpreadsheetApp.getUi().alert('Quick Actions', 'Available for Member Directory and Grievance Log.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Show quick actions for a member row
 */
function showMemberQuickActions_(row) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var data = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
  var memberId = data[MEMBER_COLS.MEMBER_ID - 1];
  var name = data[MEMBER_COLS.FIRST_NAME - 1] + ' ' + data[MEMBER_COLS.LAST_NAME - 1];
  var email = data[MEMBER_COLS.EMAIL - 1];
  var hasOpen = data[MEMBER_COLS.HAS_OPEN_GRIEVANCE - 1];
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px;background:#f5f5f5}.container{background:white;padding:25px;border-radius:8px}h2{color:#1a73e8;display:flex;align-items:center;gap:10px}.info{background:#e8f4fd;padding:15px;border-radius:8px;margin-bottom:20px}.name{font-size:18px;font-weight:bold}.id{color:#666;font-size:14px}.status{margin-top:10px}.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:bold}.open{background:#ffebee;color:#c62828}.none{background:#e8f5e9;color:#2e7d32}.actions{display:flex;flex-direction:column;gap:10px}.action-btn{display:flex;align-items:center;gap:12px;padding:15px;border:none;border-radius:8px;cursor:pointer;font-size:14px;text-align:left;background:#f8f9fa}.action-btn:hover{background:#e8f4fd}.icon{font-size:24px}.title{font-weight:bold}.desc{font-size:12px;color:#666;margin-top:2px}.close{width:100%;margin-top:15px;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer}</style></head><body><div class="container"><h2>Quick Actions</h2><div class="info"><div class="name">' + name + '</div><div class="id">' + memberId + ' | ' + (email || 'No email') + '</div><div class="status">' + (hasOpen === 'Yes' ? '<span class="badge open">Has Open Grievance</span>' : '<span class="badge none">No Open Grievances</span>') + '</div></div><div class="actions"><button class="action-btn" onclick="navigator.clipboard.writeText(\'' + memberId + '\');alert(\'Member ID copied!\')"><span class="icon">Copy</span><span><div class="title">Copy Member ID</div><div class="desc">' + memberId + '</div></span></button></div><button class="close" onclick="google.script.host.close()">Close</button></div></body></html>'
  ).setWidth(400).setHeight(400);
  SpreadsheetApp.getUi().showModalDialog(html, 'Member Quick Actions');
}

/**
 * Show quick actions for a grievance row
 */
function showGrievanceQuickActions_(row) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  var data = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
  var grievanceId = data[GRIEVANCE_COLS.GRIEVANCE_ID - 1];
  var memberId = data[GRIEVANCE_COLS.MEMBER_ID - 1];
  var name = data[GRIEVANCE_COLS.FIRST_NAME - 1] + ' ' + data[GRIEVANCE_COLS.LAST_NAME - 1];
  var status = data[GRIEVANCE_COLS.STATUS - 1];
  var step = data[GRIEVANCE_COLS.CURRENT_STEP - 1];
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px;background:#f5f5f5}.container{background:white;padding:25px;border-radius:8px}h2{color:#1a73e8}.info{background:#e8f4fd;padding:15px;border-radius:8px;margin-bottom:20px}.name{font-size:18px;font-weight:bold}.id{color:#666;font-size:14px}.status{margin-top:10px}.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:bold;margin-right:8px}.open{background:#fff3e0;color:#e65100}.closed{background:#e8f5e9;color:#2e7d32}.actions{display:flex;flex-direction:column;gap:10px}.action-btn{display:flex;align-items:center;gap:12px;padding:15px;border:none;border-radius:8px;cursor:pointer;font-size:14px;text-align:left;background:#f8f9fa}.action-btn:hover{background:#e8f4fd}.close{width:100%;margin-top:15px;padding:12px;background:#6c757d;color:white;border:none;border-radius:8px;cursor:pointer}</style></head><body><div class="container"><h2>Quick Actions</h2><div class="info"><div class="name">' + name + '</div><div class="id">' + grievanceId + ' | Member: ' + memberId + '</div><div class="status"><span class="badge ' + (status === 'Open' ? 'open' : 'closed') + '">' + status + '</span><span class="badge">' + step + '</span></div></div><div class="actions"><button class="action-btn" onclick="navigator.clipboard.writeText(\'' + grievanceId + '\');alert(\'Grievance ID copied!\')"><span>Copy Grievance ID: ' + grievanceId + '</span></button></div><button class="close" onclick="google.script.host.close()">Close</button></div></body></html>'
  ).setWidth(400).setHeight(350);
  SpreadsheetApp.getUi().showModalDialog(html, 'Grievance Quick Actions');
}

/**
 * Recalculate all grievance deadlines and sync to Member Directory
 * Uses hidden sheet formulas for self-healing calculations
 */
function recalcAllGrievancesBatched() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Recalculating grievances...', 'ğŸ”„ Refresh', 3);

  // Step 1: Sync calculated formulas from hidden sheet to Grievance Log
  // This updates: Filing Deadline, Step Due dates, Days Open, Next Action Due, Days to Deadline
  // Also updates: First Name, Last Name, Email, Unit, Location, Steward from Member Directory
  syncGrievanceFormulasToLog();

  // Step 2: Repair checkboxes (in case they were overwritten)
  repairGrievanceCheckboxes();

  // Step 3: Sync grievance data to member directory (updates AB-AD columns)
  syncGrievanceToMemberDirectory();

  ss.toast('Grievance data refreshed!', 'âœ… Success', 3);
}

/**
 * Refresh Member Directory calculated columns (AB-AD: Has Open Grievance, Status, Next Deadline)
 */
function refreshMemberDirectoryFormulas() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Refreshing Member Directory...', 'ğŸ”„ Refresh', 3);

  // Step 1: Refresh grievance formulas first (to get latest Next Action Due dates)
  syncGrievanceFormulasToLog();

  // Step 2: Sync grievance data to member directory (updates AB-AD columns)
  syncGrievanceToMemberDirectory();

  // Step 3: Repair member checkboxes
  repairMemberCheckboxes();

  ss.toast('Member Directory refreshed!', 'âœ… Success', 3);
}

/**
 * Sync grievance data to Member Directory (AB-AD columns)
 * Uses STATIC VALUES - no formulas in visible sheets
 * Calls syncGrievanceToMemberDirectory() to populate data
 */
function setupLiveGrievanceFormulas() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Error: Member Directory not found.');
    return;
  }

  ss.toast('Syncing grievance data to Member Directory...', 'ğŸ”„ Sync', 3);

  // Use sync function to populate with static values (no formulas)
  syncGrievanceToMemberDirectory();

  ss.toast('Grievance data synced! Columns AB-AD updated with static values.', 'âœ… Success', 3);
}

/**
 * Reset theme to default (light theme)
 */
function resetToDefaultTheme() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();

  // Default light theme colors
  var defaultTheme = {
    headerBackground: '#1a73e8',
    headerText: '#ffffff',
    evenRow: '#f8f9fa',
    oddRow: '#ffffff'
  };

  sheets.forEach(function(sheet) {
    var lastRow = Math.max(sheet.getLastRow(), 1);
    var lastCol = Math.max(sheet.getLastColumn(), 1);

    // Reset header row
    if (lastCol > 0) {
      sheet.getRange(1, 1, 1, lastCol)
        .setBackground(defaultTheme.headerBackground)
        .setFontColor(defaultTheme.headerText);
    }

    // Reset data rows with alternating colors
    for (var row = 2; row <= lastRow; row++) {
      var bgColor = (row % 2 === 0) ? defaultTheme.evenRow : defaultTheme.oddRow;
      sheet.getRange(row, 1, 1, lastCol).setBackground(bgColor).setFontColor('#202124');
    }
  });

  ss.toast('Theme reset to default!', 'âœ… Success', 3);
}

// ==================== ADHD FEATURES ====================

/**
 * Show ADHD Control Panel
 */
function showADHDControlPanel() {
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px;background:#f5f5f5}.container{background:white;padding:25px;border-radius:8px}h2{color:#1a73e8;border-bottom:3px solid #1a73e8;padding-bottom:10px}.section{background:#f8f9fa;padding:15px;margin:15px 0;border-radius:8px;border-left:4px solid #1a73e8}.row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #e0e0e0}button{background:#1a73e8;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin:5px}button:hover{background:#1557b0}button.sec{background:#6c757d}</style></head><body><div class="container"><h2>ADHD Control Panel</h2><div class="section"><div class="row"><span>Zebra Stripes</span><button onclick="google.script.run.toggleZebraStripes();google.script.host.close()">Toggle</button></div><div class="row"><span>Focus Mode</span><button onclick="google.script.run.activateFocusMode();google.script.host.close()">Activate</button></div></div><div class="section"><div class="row"><span>Quick Capture</span><button onclick="google.script.run.showQuickCaptureNotepad();google.script.host.close()">Open</button></div><div class="row"><span>Pomodoro Timer</span><button onclick="google.script.run.startPomodoroTimer();google.script.host.close()">Start</button></div></div><button class="sec" onclick="google.script.host.close()">Close</button></div></body></html>'
  ).setWidth(450).setHeight(400);
  SpreadsheetApp.getUi().showModalDialog(html, 'ADHD Control Panel');
}

// Alias for showADHDControlPanel (handles typo without 'l')
function showADHDControlPane() {
  showADHDControlPanel();
}

/**
 * Hide gridlines on dashboard sheets for cleaner ADHD-friendly view
 */
function hideAllGridlines() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.getSheets().forEach(function(sheet) {
    var name = sheet.getName();
    // Keep gridlines on data entry sheets, hide on dashboards
    if (name !== SHEETS.CONFIG && name !== SHEETS.MEMBER_DIR && name !== SHEETS.GRIEVANCE_LOG) {
      sheet.setHiddenGridlines(true);
    }
  });
  ss.toast('Gridlines hidden on dashboards!', 'ADHD Setup', 3);
}

/**
 * Setup ADHD-friendly defaults for the spreadsheet
 */
function setupADHDDefaults() {
  var ui = SpreadsheetApp.getUi();
  ui.alert('ğŸ¨ Setting up ADHD-friendly defaults...');
  try {
    hideAllGridlines();
    ui.alert('ğŸ‰ ADHD-friendly setup complete!\n\nâœ… Gridlines hidden on dashboards\nâœ… Ready for focus!');
  } catch (e) {
    ui.alert('âš ï¸ Error: ' + e.message);
  }
}

/**
 * Activate focus mode - highlights current row
 */
function activateFocusMode() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var selection = sheet.getActiveRange();
  if (selection) {
    var row = selection.getRow();
    var lastCol = Math.max(sheet.getLastColumn(), 1);
    sheet.getRange(row, 1, 1, lastCol).setBackground('#fff3cd');
  }
  ss.toast('Focus mode activated on current row!', 'Focus Mode', 3);
}

/**
 * Toggle zebra stripes on current sheet
 */
function toggleZebraStripes() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var lastRow = sheet.getLastRow();
  var lastCol = Math.max(sheet.getLastColumn(), 1);

  for (var row = 2; row <= lastRow; row++) {
    var bgColor = (row % 2 === 0) ? '#f8f9fa' : '#ffffff';
    sheet.getRange(row, 1, 1, lastCol).setBackground(bgColor);
  }
  ss.toast('Zebra stripes applied!', 'Zebra Stripes', 3);
}

/**
 * Show quick capture notepad
 */
function showQuickCaptureNotepad() {
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px}textarea{width:100%;height:200px;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:14px}button{background:#1a73e8;color:white;border:none;padding:12px 24px;border-radius:4px;cursor:pointer;margin-top:10px}button:hover{background:#1557b0}</style></head><body><h3>Quick Capture</h3><textarea id="note" placeholder="Type your notes here..."></textarea><br><button onclick="var n=document.getElementById(\'note\').value;if(n)google.script.run.withSuccessHandler(function(){alert(\'Saved!\');google.script.host.close()}).saveQuickNote(n)">Save Note</button><button style="background:#6c757d" onclick="google.script.host.close()">Close</button></body></html>'
  ).setWidth(400).setHeight(350);
  SpreadsheetApp.getUi().showModalDialog(html, 'Quick Capture');
}

/**
 * Save quick note to script properties
 */
function saveQuickNote(note) {
  var props = PropertiesService.getUserProperties();
  var notes = JSON.parse(props.getProperty('quickNotes') || '[]');
  notes.push({ text: note, date: new Date().toISOString() });
  props.setProperty('quickNotes', JSON.stringify(notes));
}

/**
 * Start Pomodoro timer
 */
function startPomodoroTimer() {
  SpreadsheetApp.getUi().alert('Pomodoro Timer', '25-minute work session started!\n\nTake a 5-minute break when the timer ends.', SpreadsheetApp.getUi().ButtonSet.OK);
  SpreadsheetApp.getActiveSpreadsheet().toast('Pomodoro started! 25 minutes of focused work.', 'Pomodoro', 10);
}

/**
 * Show theme manager
 */
function showThemeManager() {
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px}.theme-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}.theme-card{padding:20px;border-radius:8px;cursor:pointer;text-align:center;border:2px solid #ddd}.theme-card:hover{border-color:#1a73e8}.light{background:#fff}.dark{background:#202124;color:#e8eaed}.purple{background:#E8E3F3}.green{background:#D1FAE5}button{background:#1a73e8;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin-top:15px}</style></head><body><h3>Theme Manager</h3><div class="theme-grid"><div class="theme-card light" onclick="google.script.run.resetToDefaultTheme();google.script.host.close()"><strong>Light</strong><br>Default theme</div><div class="theme-card dark" onclick="google.script.run.quickToggleDarkMode();google.script.host.close()"><strong>Dark</strong><br>Dark mode</div><div class="theme-card purple" onclick="google.script.run.applyPurpleTheme();google.script.host.close()"><strong>509 Purple</strong><br>Union purple</div><div class="theme-card green" onclick="google.script.run.applyGreenTheme();google.script.host.close()"><strong>Union Green</strong><br>Go green</div></div><button onclick="google.script.host.close()">Close</button></body></html>'
  ).setWidth(400).setHeight(350);
  SpreadsheetApp.getUi().showModalDialog(html, 'Theme Manager');
}

/**
 * Toggle dark mode
 */
function quickToggleDarkMode() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  var darkTheme = {
    headerBackground: '#35363a',
    headerText: '#e8eaed',
    evenRow: '#292a2d',
    oddRow: '#202124',
    text: '#e8eaed'
  };

  sheets.forEach(function(sheet) {
    var lastRow = Math.max(sheet.getLastRow(), 1);
    var lastCol = Math.max(sheet.getLastColumn(), 1);
    if (lastCol > 0) {
      sheet.getRange(1, 1, 1, lastCol).setBackground(darkTheme.headerBackground).setFontColor(darkTheme.headerText);
    }
    for (var row = 2; row <= lastRow; row++) {
      var bgColor = (row % 2 === 0) ? darkTheme.evenRow : darkTheme.oddRow;
      sheet.getRange(row, 1, 1, lastCol).setBackground(bgColor).setFontColor(darkTheme.text);
    }
  });
  ss.toast('Dark mode applied!', 'Theme', 3);
}

/**
 * Apply purple theme
 */
function applyPurpleTheme() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  sheets.forEach(function(sheet) {
    var lastRow = Math.max(sheet.getLastRow(), 1);
    var lastCol = Math.max(sheet.getLastColumn(), 1);
    if (lastCol > 0) {
      sheet.getRange(1, 1, 1, lastCol).setBackground('#5B4B9E').setFontColor('#ffffff');
    }
    for (var row = 2; row <= lastRow; row++) {
      var bgColor = (row % 2 === 0) ? '#E8E3F3' : '#ffffff';
      sheet.getRange(row, 1, 1, lastCol).setBackground(bgColor).setFontColor('#1F2937');
    }
  });
  ss.toast('Purple theme applied!', 'Theme', 3);
}

/**
 * Apply green theme
 */
function applyGreenTheme() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheets = ss.getSheets();
  sheets.forEach(function(sheet) {
    var lastRow = Math.max(sheet.getLastRow(), 1);
    var lastCol = Math.max(sheet.getLastColumn(), 1);
    if (lastCol > 0) {
      sheet.getRange(1, 1, 1, lastCol).setBackground('#059669').setFontColor('#ffffff');
    }
    for (var row = 2; row <= lastRow; row++) {
      var bgColor = (row % 2 === 0) ? '#D1FAE5' : '#ffffff';
      sheet.getRange(row, 1, 1, lastCol).setBackground(bgColor).setFontColor('#1F2937');
    }
  });
  ss.toast('Green theme applied!', 'Theme', 3);
}

// ==================== UNDO/REDO & CACHE ====================

/**
 * Undo last action (placeholder)
 */
function undoLastAction() {
  SpreadsheetApp.getUi().alert('Undo', 'Use Ctrl+Z (Cmd+Z on Mac) to undo actions in Google Sheets.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Redo last action (placeholder)
 */
function redoLastAction() {
  SpreadsheetApp.getUi().alert('Redo', 'Use Ctrl+Y (Cmd+Shift+Z on Mac) to redo actions in Google Sheets.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Show undo/redo panel
 */
function showUndoRedoPanel() {
  SpreadsheetApp.getUi().alert('Undo/Redo', 'Google Sheets has built-in undo/redo:\n\nâ€¢ Undo: Ctrl+Z (Cmd+Z)\nâ€¢ Redo: Ctrl+Y (Cmd+Shift+Z)\n\nUse Edit menu to see full history.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Clear undo history (placeholder)
 */
function clearUndoHistory() {
  SpreadsheetApp.getActiveSpreadsheet().toast('Undo history is managed by Google Sheets.', 'Info', 3);
}

/**
 * Warm up caches
 * Note: CacheService has a 100KB limit per item, so we cache metadata only
 */
function warmUpCaches() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var cache = CacheService.getScriptCache();
  var cached = 0;

  try {
    // Cache member count and column info (small data)
    var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
    if (memberSheet && memberSheet.getLastRow() > 1) {
      var memberMeta = {
        lastRow: memberSheet.getLastRow(),
        lastCol: memberSheet.getLastColumn(),
        updated: new Date().toISOString()
      };
      cache.put('memberMeta', JSON.stringify(memberMeta), 21600);
      cached++;
    }

    // Cache grievance count and column info (small data)
    var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
    if (grievanceSheet && grievanceSheet.getLastRow() > 1) {
      var grievanceMeta = {
        lastRow: grievanceSheet.getLastRow(),
        lastCol: grievanceSheet.getLastColumn(),
        updated: new Date().toISOString()
      };
      cache.put('grievanceMeta', JSON.stringify(grievanceMeta), 21600);
      cached++;
    }

    // Cache config data (usually small enough)
    var configSheet = ss.getSheetByName(SHEETS.CONFIG);
    if (configSheet) {
      var configData = configSheet.getDataRange().getValues();
      var configStr = JSON.stringify(configData);
      if (configStr.length < 100000) {  // Only cache if under 100KB
        cache.put('configData', configStr, 21600);
        cached++;
      }
    }

    ss.toast('Cached ' + cached + ' items successfully!', 'Cache Warmup', 3);
  } catch (e) {
    ss.toast('Cache warmup partial: ' + e.message, 'Cache', 3);
  }
}

/**
 * Invalidate all caches
 */
function invalidateAllCaches() {
  var cache = CacheService.getScriptCache();
  cache.removeAll(['memberMeta', 'grievanceMeta', 'configData']);
  SpreadsheetApp.getActiveSpreadsheet().toast('All caches invalidated!', 'Cache', 3);
}

// ==================== VALIDATION ====================

/**
 * Run bulk validation on all data
 */
function runBulkValidation() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var issues = [];

  // Check Member Directory
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (memberSheet) {
    var memberData = memberSheet.getDataRange().getValues();
    for (var i = 1; i < memberData.length; i++) {
      var memberId = memberData[i][MEMBER_COLS.MEMBER_ID - 1];
      var email = memberData[i][MEMBER_COLS.EMAIL - 1];
      if (memberId && email && !email.toString().includes('@')) {
        issues.push('Row ' + (i + 1) + ': Invalid email format');
      }
    }
  }

  if (issues.length === 0) {
    ss.toast('All data passed validation!', 'Validation', 3);
  } else {
    SpreadsheetApp.getUi().alert('Validation Issues', issues.slice(0, 10).join('\n') + (issues.length > 10 ? '\n...and ' + (issues.length - 10) + ' more' : ''), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Show validation settings
 */
function showValidationSettings() {
  SpreadsheetApp.getUi().alert('Validation Settings', 'Validation checks:\n\nâ€¢ Email format\nâ€¢ Required fields\nâ€¢ Data consistency\n\nRun "Run Bulk Validation" to check all data.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Clear validation indicators
 */
function clearValidationIndicators() {
  SpreadsheetApp.getActiveSpreadsheet().toast('Validation indicators cleared.', 'Validation', 3);
}

/**
 * Install validation trigger
 */
function installValidationTrigger() {
  SpreadsheetApp.getActiveSpreadsheet().toast('Validation runs automatically on edit via onEdit trigger.', 'Validation', 3);
}

/**
 * Setup Member ID dropdown in Grievance Log from Member Directory
 * This allows users to select a member when creating a grievance
 */
function setupGrievanceMemberDropdown() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    SpreadsheetApp.getUi().alert('Error: Required sheets not found.');
    return;
  }

  ss.toast('Setting up Member ID dropdown...', 'ğŸ”„ Setup', 3);

  // Get column letter for Member ID in Member Directory
  var mMemberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);

  // Create data validation rule that references Member Directory Member IDs
  var memberIdRange = '\'' + SHEETS.MEMBER_DIR + '\'!' + mMemberIdCol + '2:' + mMemberIdCol;
  var rule = SpreadsheetApp.newDataValidation()
    .requireValueInRange(memberSheet.getRange(mMemberIdCol + '2:' + mMemberIdCol), true)
    .setAllowInvalid(true)  // Allow manual entry too
    .build();

  // Apply to Member ID column in Grievance Log (column B, rows 2-1000)
  grievanceSheet.getRange(2, GRIEVANCE_COLS.MEMBER_ID, 998, 1).setDataValidation(rule);

  ss.toast('Member ID dropdown set up!', 'âœ… Success', 3);
}

/**
 * Fix existing "Overdue" text in Days to Deadline column
 * Converts text back to negative numbers for proper counting
 */
function fixOverdueTextToNumbers() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Grievance Log not found.');
    return;
  }

  ss.toast('Fixing overdue data...', 'ğŸ”§ Fix', 3);

  var lastRow = sheet.getLastRow();
  if (lastRow < 2) return;

  var daysCol = GRIEVANCE_COLS.DAYS_TO_DEADLINE;
  var nextActionCol = GRIEVANCE_COLS.NEXT_ACTION_DUE;

  var daysData = sheet.getRange(2, daysCol, lastRow - 1, 1).getValues();
  var nextActionData = sheet.getRange(2, nextActionCol, lastRow - 1, 1).getValues();

  var today = new Date();
  today.setHours(0, 0, 0, 0);

  var updates = [];
  var fixCount = 0;

  for (var i = 0; i < daysData.length; i++) {
    var currentValue = daysData[i][0];
    var nextAction = nextActionData[i][0];

    if (currentValue === 'Overdue' && nextAction instanceof Date) {
      var days = Math.floor((nextAction - today) / (1000 * 60 * 60 * 24));
      updates.push([days]);
      fixCount++;
    } else {
      updates.push([currentValue]);
    }
  }

  if (fixCount > 0) {
    sheet.getRange(2, daysCol, updates.length, 1).setValues(updates);
    ss.toast('Fixed ' + fixCount + ' overdue entries!', 'âœ… Success', 3);
  } else {
    ss.toast('No "Overdue" text found to fix.', 'âœ… All Good', 3);
  }
}

function rebuildDashboard() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Rebuilding dashboard sheets...', 'ğŸ”„ Rebuild', 3);

  // Recreate dashboard sheets with latest layout
  createDashboard(ss);
  createInteractiveDashboard(ss);

  // Refresh hidden sheet formulas and sync data
  refreshAllHiddenFormulas();

  // Reapply data validations
  setupDataValidations();

  ss.toast('Dashboard rebuilt with all 9 sections!', 'âœ… Success', 3);
}

/**
 * Refresh all formulas and sync all data
 */
function refreshAllFormulas() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Refreshing all formulas and syncing data...', 'ğŸ”„ Refresh', 3);

  // Use the full refresh from HiddenSheets.gs
  refreshAllHiddenFormulas();
}

/**
 * Run all tests (stub - TestingValidation.gs not included)
 */
function runAllTests() {
  SpreadsheetApp.getUi().alert('ğŸ§ª Run All Tests',
    'Test framework not yet implemented.\n\n' +
    'To add tests, create TestingValidation.gs with test functions.',
    SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Run quick tests (stub - TestingValidation.gs not included)
 */
function runQuickTests() {
  SpreadsheetApp.getUi().alert('âš¡ Run Quick Tests',
    'Test framework not yet implemented.\n\n' +
    'To add tests, create TestingValidation.gs with test functions.',
    SpreadsheetApp.getUi().ButtonSet.OK);
}

function viewTestResults() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.TEST_RESULTS);
  if (sheet) {
    ss.setActiveSheet(sheet);
  } else {
    SpreadsheetApp.getUi().alert('No test results yet. Run tests first using ğŸ§ª Testing menu.');
  }
}



// ================================================================================
// MODULE: HiddenSheets.gs
// Source: HiddenSheets.gs
// ================================================================================

/**
 * 509 Dashboard - Hidden Sheet Architecture
 *
 * Self-healing hidden calculation sheets with auto-sync triggers.
 * Provides automatic cross-sheet data population.
 *
 * @version 1.0.0
 * @license Free for use by non-profit collective bargaining groups and unions
 */

// ============================================================================
// HIDDEN SHEET 1: _Grievance_Calc
// Source: Grievance Log â†’ Destination: Member Directory (AB-AD)
// ============================================================================

/**
 * Setup the _Grievance_Calc hidden sheet with self-healing formulas
 * Calculates: Has Open Grievance, Grievance Status, Next Deadline per member
 */
function setupGrievanceCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.GRIEVANCE_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Member ID', 'Has Open Grievance', 'Grievance Status', 'Days to Deadline', 'Total Count', 'Win Rate %', 'Last Grievance Date'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Get column letters for dynamic formulas
  var memberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var gMemberIdCol = getColumnLetter(GRIEVANCE_COLS.MEMBER_ID);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gNextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);

  // Formula for Member IDs (Column A) - pulls unique member IDs from Member Directory
  var memberIdFormula = '=IFERROR(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + memberIdCol + ':' + memberIdCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + memberIdCol + ':' + memberIdCol + '<>"Member ID"),"")';
  sheet.getRange('A2').setFormula(memberIdFormula);

  // Formulas for calculations (using ARRAYFORMULA for efficiency)
  // Column B: Has Open Grievance
  var hasOpenFormula = '=ARRAYFORMULA(IF(A2:A="","",IF(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")+COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")>0,"Yes","No")))';
  sheet.getRange('B2').setFormula(hasOpenFormula);

  // Column C: Grievance Status (most urgent: Open > Pending Info)
  var statusFormula = '=ARRAYFORMULA(IF(A2:A="","",IF(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")>0,"Open",IF(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")>0,"Pending Info",""))))';
  sheet.getRange('C2').setFormula(statusFormula);

  // Column D: Days to Deadline (minimum/most urgent deadline for open grievances only)
  // Excludes all closed statuses: Closed, Settled, Withdrawn, Denied, Won
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  var deadlineFormula = '=ARRAYFORMULA(IF(A2:A="","",IFERROR(MINIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Closed",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Settled",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Withdrawn",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Denied",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"<>Won"),"")))';
  sheet.getRange('D2').setFormula(deadlineFormula);

  // Column E: Total Grievance Count
  var countFormula = '=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A)))';
  sheet.getRange('E2').setFormula(countFormula);

  // Column F: Win Rate %
  var winRateFormula = '=ARRAYFORMULA(IF(A2:A="","",IFERROR(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A)*100,0)))';
  sheet.getRange('F2').setFormula(winRateFormula);

  // Column G: Last Grievance Date
  var lastDateFormula = '=ARRAYFORMULA(IF(A2:A="","",IFERROR(MAXIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A),"")))';
  sheet.getRange('G2').setFormula(lastDateFormula);

  // Hide the sheet
  sheet.hideSheet();

  Logger.log('_Grievance_Calc sheet setup complete');
}

/**
 * Sync grievance data from hidden sheet to Member Directory
 */
function syncGrievanceToMemberDirectory() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.GRIEVANCE_CALC);
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!calcSheet || !memberSheet) {
    Logger.log('Required sheets not found for grievance sync');
    return;
  }

  // Get data from hidden sheet
  var calcData = calcSheet.getDataRange().getValues();
  if (calcData.length < 2) return;

  // Create lookup map: memberId -> {hasOpen, status, deadline}
  var lookup = {};
  for (var i = 1; i < calcData.length; i++) {
    var memberId = calcData[i][0];
    if (memberId) {
      lookup[memberId] = {
        hasOpen: calcData[i][1],
        status: calcData[i][2],
        deadline: calcData[i][3]
      };
    }
  }

  // Get member data
  var memberData = memberSheet.getDataRange().getValues();
  if (memberData.length < 2) return;

  // Update columns AB-AD
  var updates = [];
  for (var j = 1; j < memberData.length; j++) {
    var memberId = memberData[j][MEMBER_COLS.MEMBER_ID - 1];
    var data = lookup[memberId] || {hasOpen: 'No', status: '', deadline: ''};
    updates.push([data.hasOpen, data.status, data.deadline]);
  }

  if (updates.length > 0) {
    memberSheet.getRange(2, MEMBER_COLS.HAS_OPEN_GRIEVANCE, updates.length, 3).setValues(updates);
  }

  Logger.log('Synced grievance data to ' + updates.length + ' members');
}

// ============================================================================
// HIDDEN SHEET 2: _Grievance_Formulas (SELF-HEALING)
// Source: Grievance Log â†’ Destination: Grievance Log (calculated columns)
// This sheet contains all auto-calculated formulas and syncs them back
// ============================================================================

/**
 * Setup the _Grievance_Formulas hidden sheet with self-healing formulas
 * Calculates: First Name, Last Name, Email, Unit, Location, Steward (from Member Dir)
 *            Filing Deadline, Step I-III dates, Days Open, Next Action Due, Days to Deadline
 */
function setupGrievanceFormulasSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_FORMULAS);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.GRIEVANCE_FORMULAS);
  }

  sheet.clear();

  // Headers matching Grievance Log columns that need formulas
  var headers = [
    'Row Index',           // A - For tracking which row in Grievance Log
    'Member ID',           // B - From Grievance Log
    'First Name',          // C - Lookup from Member Directory
    'Last Name',           // D - Lookup from Member Directory
    'Incident Date',       // E - From Grievance Log
    'Date Filed',          // F - From Grievance Log
    'Step I Rcvd',         // G - From Grievance Log
    'Step II Appeal Filed',// H - From Grievance Log
    'Step II Rcvd',        // I - From Grievance Log
    'Status',              // J - From Grievance Log
    'Current Step',        // K - From Grievance Log
    'Date Closed',         // L - From Grievance Log
    'Filing Deadline',     // M - CALCULATED
    'Step I Due',          // N - CALCULATED
    'Step II Appeal Due',  // O - CALCULATED
    'Step II Due',         // P - CALCULATED
    'Step III Appeal Due', // Q - CALCULATED
    'Days Open',           // R - CALCULATED
    'Next Action Due',     // S - CALCULATED
    'Days to Deadline',    // T - CALCULATED
    'Member Email',        // U - Lookup from Member Directory
    'Unit',                // V - Lookup from Member Directory
    'Location',            // W - Lookup from Member Directory
    'Steward'              // X - Lookup from Member Directory
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Get column letters for Grievance Log source data
  var gGrievanceIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);     // A
  var gMemberIdCol = getColumnLetter(GRIEVANCE_COLS.MEMBER_ID);           // B
  var gIncidentDateCol = getColumnLetter(GRIEVANCE_COLS.INCIDENT_DATE);   // G
  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);         // I
  var gStep1RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP1_RCVD);         // K
  var gStep2AppealFiledCol = getColumnLetter(GRIEVANCE_COLS.STEP2_APPEAL_FILED); // M
  var gStep2RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP2_RCVD);         // O
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);                // E
  var gCurrentStepCol = getColumnLetter(GRIEVANCE_COLS.CURRENT_STEP);     // F
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);       // R

  // Member Directory columns for lookups
  var mMemberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.ASSIGNED_STEWARD);
  var memberRange = "'" + SHEETS.MEMBER_DIR + "'!" + mMemberIdCol + ":" + mStewardCol;

  // Column A: Row Index (ROW()-1 to match Grievance Log rows)
  // Pull unique grievance IDs to create row mapping
  sheet.getRange('A2').setFormula(
    '=IFERROR(FILTER(ROW(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gGrievanceIdCol + '2:' + gGrievanceIdCol + ')-1,' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gGrievanceIdCol + '2:' + gGrievanceIdCol + '<>""),"")'
  );

  // Column B: Member ID (from Grievance Log)
  sheet.getRange('B2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',A2:A+1)))'
  );

  // Column C: First Name (VLOOKUP from Member Directory)
  sheet.getRange('C2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.FIRST_NAME + ',FALSE),"")))'
  );

  // Column D: Last Name (VLOOKUP from Member Directory)
  sheet.getRange('D2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.LAST_NAME + ',FALSE),"")))'
  );

  // Column E: Incident Date (from Grievance Log)
  sheet.getRange('E2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIncidentDateCol + ':' + gIncidentDateCol + ',A2:A+1)))'
  );

  // Column F: Date Filed (from Grievance Log)
  sheet.getRange('F2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',A2:A+1)))'
  );

  // Column G: Step I Rcvd (from Grievance Log)
  sheet.getRange('G2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStep1RcvdCol + ':' + gStep1RcvdCol + ',A2:A+1)))'
  );

  // Column H: Step II Appeal Filed (from Grievance Log)
  sheet.getRange('H2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStep2AppealFiledCol + ':' + gStep2AppealFiledCol + ',A2:A+1)))'
  );

  // Column I: Step II Rcvd (from Grievance Log)
  sheet.getRange('I2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStep2RcvdCol + ':' + gStep2RcvdCol + ',A2:A+1)))'
  );

  // Column J: Status (from Grievance Log)
  sheet.getRange('J2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',A2:A+1)))'
  );

  // Column K: Current Step (from Grievance Log)
  sheet.getRange('K2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCurrentStepCol + ':' + gCurrentStepCol + ',A2:A+1)))'
  );

  // Column L: Date Closed (from Grievance Log)
  sheet.getRange('L2').setFormula(
    '=ARRAYFORMULA(IF(A2:A="","",INDEX(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',A2:A+1)))'
  );

  // =========== CALCULATED COLUMNS ===========

  // Column M: Filing Deadline = Incident Date + 21 days
  sheet.getRange('M2').setFormula(
    '=ARRAYFORMULA(IF(E2:E="","",E2:E+21))'
  );

  // Column N: Step I Due = Date Filed + 30 days
  sheet.getRange('N2').setFormula(
    '=ARRAYFORMULA(IF(F2:F="","",F2:F+30))'
  );

  // Column O: Step II Appeal Due = Step I Rcvd + 10 days
  sheet.getRange('O2').setFormula(
    '=ARRAYFORMULA(IF(G2:G="","",G2:G+10))'
  );

  // Column P: Step II Due = Step II Appeal Filed + 30 days
  sheet.getRange('P2').setFormula(
    '=ARRAYFORMULA(IF(H2:H="","",H2:H+30))'
  );

  // Column Q: Step III Appeal Due = Step II Rcvd + 30 days
  sheet.getRange('Q2').setFormula(
    '=ARRAYFORMULA(IF(I2:I="","",I2:I+30))'
  );

  // Column R: Days Open = IF closed: Date Closed - Date Filed, ELSE: Today - Date Filed
  sheet.getRange('R2').setFormula(
    '=ARRAYFORMULA(IF(F2:F="","",IF(L2:L<>"",L2:L-F2:F,TODAY()-F2:F)))'
  );

  // Column S: Next Action Due = Based on current step and status
  // If closed status, leave blank; otherwise return appropriate deadline
  sheet.getRange('S2').setFormula(
    '=ARRAYFORMULA(IF(J2:J="","",' +
    'IF(OR(J2:J="Settled",J2:J="Withdrawn",J2:J="Denied",J2:J="Won",J2:J="Closed"),"",' +
    'IF(K2:K="Informal",M2:M,' +
    'IF(K2:K="Step I",N2:N,' +
    'IF(K2:K="Step II",P2:P,' +
    'Q2:Q))))))'
  );

  // Column T: Days to Deadline = Next Action Due - Today
  sheet.getRange('T2').setFormula(
    '=ARRAYFORMULA(IF(S2:S="","",S2:S-TODAY()))'
  );

  // =========== MEMBER LOOKUP COLUMNS ===========

  // Column U: Member Email (VLOOKUP from Member Directory)
  sheet.getRange('U2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.EMAIL + ',FALSE),"")))'
  );

  // Column V: Unit (VLOOKUP from Member Directory)
  sheet.getRange('V2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.UNIT + ',FALSE),"")))'
  );

  // Column W: Location (VLOOKUP from Member Directory)
  sheet.getRange('W2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.WORK_LOCATION + ',FALSE),"")))'
  );

  // Column X: Steward (VLOOKUP from Member Directory)
  sheet.getRange('X2').setFormula(
    '=ARRAYFORMULA(IF(B2:B="","",IFERROR(VLOOKUP(B2:B,' + memberRange + ',' + MEMBER_COLS.ASSIGNED_STEWARD + ',FALSE),"")))'
  );

  // Format date columns (MM/dd/yyyy)
  sheet.getRange('E:E').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('F:F').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('G:G').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('H:H').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('I:I').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('L:L').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('M:M').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('N:N').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('O:O').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('P:P').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('Q:Q').setNumberFormat('MM/dd/yyyy');
  sheet.getRange('S:S').setNumberFormat('MM/dd/yyyy');

  // Hide the sheet
  sheet.hideSheet();

  Logger.log('_Grievance_Formulas sheet setup complete');
}

/**
 * Sync calculated formulas from hidden sheet to Grievance Log
 * This is the self-healing function - it copies calculated values to the Grievance Log
 * Member data (Name, Email, Unit, Location, Steward) is looked up directly from Member Directory
 */
function syncGrievanceFormulasToLog() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!grievanceSheet || !memberSheet) {
    Logger.log('Required sheets not found for grievance formula sync');
    return;
  }

  // Get Member Directory data and create lookup by Member ID
  var memberData = memberSheet.getDataRange().getValues();
  var memberLookup = {};
  for (var i = 1; i < memberData.length; i++) {
    var memberId = memberData[i][MEMBER_COLS.MEMBER_ID - 1];
    if (memberId) {
      memberLookup[memberId] = {
        firstName: memberData[i][MEMBER_COLS.FIRST_NAME - 1] || '',
        lastName: memberData[i][MEMBER_COLS.LAST_NAME - 1] || '',
        email: memberData[i][MEMBER_COLS.EMAIL - 1] || '',
        unit: memberData[i][MEMBER_COLS.UNIT - 1] || '',
        location: memberData[i][MEMBER_COLS.WORK_LOCATION - 1] || '',
        steward: memberData[i][MEMBER_COLS.ASSIGNED_STEWARD - 1] || ''
      };
    }
  }

  // Get grievance data
  var grievanceData = grievanceSheet.getDataRange().getValues();
  if (grievanceData.length < 2) return;

  var today = new Date();
  today.setHours(0, 0, 0, 0); // Normalize to start of day

  // Closed statuses that should not have Next Action Due
  var closedStatuses = ['Settled', 'Withdrawn', 'Denied', 'Won', 'Closed'];

  // Prepare updates
  var nameUpdates = [];           // Columns C-D
  var deadlineUpdates = [];       // Columns H, J, L, N, P (Filing Deadline, Step I Due, Step II Appeal Due, Step II Due, Step III Appeal Due)
  var metricsUpdates = [];        // Columns S, T, U (Days Open, Next Action Due, Days to Deadline)
  var contactUpdates = [];        // Columns X, Y, Z, AA (Email, Unit, Location, Steward)

  for (var j = 1; j < grievanceData.length; j++) {
    var row = grievanceData[j];
    var memberId = row[GRIEVANCE_COLS.MEMBER_ID - 1];
    var memberInfo = memberLookup[memberId] || {};

    // Names (C-D) - from Member Directory
    nameUpdates.push([
      memberInfo.firstName || '',
      memberInfo.lastName || ''
    ]);

    // Get date values from grievance row for deadline calculations
    var incidentDate = row[GRIEVANCE_COLS.INCIDENT_DATE - 1];
    var dateFiled = row[GRIEVANCE_COLS.DATE_FILED - 1];
    var step1Rcvd = row[GRIEVANCE_COLS.STEP1_RCVD - 1];
    var step2AppealFiled = row[GRIEVANCE_COLS.STEP2_APPEAL_FILED - 1];
    var step2Rcvd = row[GRIEVANCE_COLS.STEP2_RCVD - 1];
    var dateClosed = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
    var status = row[GRIEVANCE_COLS.STATUS - 1];
    var currentStep = row[GRIEVANCE_COLS.CURRENT_STEP - 1];

    // Calculate deadline dates
    var filingDeadline = '';
    var step1Due = '';
    var step2AppealDue = '';
    var step2Due = '';
    var step3AppealDue = '';

    if (incidentDate instanceof Date) {
      filingDeadline = new Date(incidentDate.getTime() + 21 * 24 * 60 * 60 * 1000);
    }
    if (dateFiled instanceof Date) {
      step1Due = new Date(dateFiled.getTime() + 30 * 24 * 60 * 60 * 1000);
    }
    if (step1Rcvd instanceof Date) {
      step2AppealDue = new Date(step1Rcvd.getTime() + 10 * 24 * 60 * 60 * 1000);
    }
    if (step2AppealFiled instanceof Date) {
      step2Due = new Date(step2AppealFiled.getTime() + 30 * 24 * 60 * 60 * 1000);
    }
    if (step2Rcvd instanceof Date) {
      step3AppealDue = new Date(step2Rcvd.getTime() + 30 * 24 * 60 * 60 * 1000);
    }

    // Deadlines (H, J, L, N, P)
    deadlineUpdates.push([
      filingDeadline,
      step1Due,
      step2AppealDue,
      step2Due,
      step3AppealDue
    ]);

    // Calculate Days Open directly
    var daysOpen = '';
    if (dateFiled instanceof Date) {
      if (dateClosed instanceof Date) {
        daysOpen = Math.floor((dateClosed - dateFiled) / (1000 * 60 * 60 * 24));
      } else {
        daysOpen = Math.floor((today - dateFiled) / (1000 * 60 * 60 * 24));
      }
    }

    // Calculate Next Action Due based on current step and status
    var nextActionDue = '';
    var isClosed = closedStatuses.indexOf(status) !== -1;

    if (!isClosed && currentStep) {
      if (currentStep === 'Informal' && filingDeadline) {
        nextActionDue = filingDeadline;
      } else if (currentStep === 'Step I' && step1Due) {
        nextActionDue = step1Due;
      } else if (currentStep === 'Step II' && step2Due) {
        nextActionDue = step2Due;
      } else if (currentStep === 'Step III' && step3AppealDue) {
        nextActionDue = step3AppealDue;
      }
    }

    // Calculate Days to Deadline directly (keep negative numbers for overdue)
    var daysToDeadline = '';
    if (nextActionDue instanceof Date) {
      var days = Math.floor((nextActionDue - today) / (1000 * 60 * 60 * 24));
      daysToDeadline = days;  // Keep as number (negative = overdue)
    }

    // Metrics (S, T, U)
    metricsUpdates.push([
      daysOpen,
      nextActionDue,
      daysToDeadline
    ]);

    // Contact info (X, Y, Z, AA)
    contactUpdates.push([
      memberInfo.email || '',
      memberInfo.unit || '',
      memberInfo.location || '',
      memberInfo.steward || ''
    ]);
  }

  // Apply updates to Grievance Log
  if (nameUpdates.length > 0) {
    // C-D: First Name, Last Name
    grievanceSheet.getRange(2, GRIEVANCE_COLS.FIRST_NAME, nameUpdates.length, 2).setValues(nameUpdates);

    // H: Filing Deadline (column 8)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.FILING_DEADLINE, deadlineUpdates.length, 1)
      .setValues(deadlineUpdates.map(function(r) { return [r[0]]; }));

    // J: Step I Due (column 10)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP1_DUE, deadlineUpdates.length, 1)
      .setValues(deadlineUpdates.map(function(r) { return [r[1]]; }));

    // L: Step II Appeal Due (column 12)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP2_APPEAL_DUE, deadlineUpdates.length, 1)
      .setValues(deadlineUpdates.map(function(r) { return [r[2]]; }));

    // N: Step II Due (column 14)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP2_DUE, deadlineUpdates.length, 1)
      .setValues(deadlineUpdates.map(function(r) { return [r[3]]; }));

    // P: Step III Appeal Due (column 16)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP3_APPEAL_DUE, deadlineUpdates.length, 1)
      .setValues(deadlineUpdates.map(function(r) { return [r[4]]; }));

    // Format deadline columns as dates (MM/dd/yyyy)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.FILING_DEADLINE, deadlineUpdates.length, 1).setNumberFormat('MM/dd/yyyy');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP1_DUE, deadlineUpdates.length, 1).setNumberFormat('MM/dd/yyyy');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP2_APPEAL_DUE, deadlineUpdates.length, 1).setNumberFormat('MM/dd/yyyy');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP2_DUE, deadlineUpdates.length, 1).setNumberFormat('MM/dd/yyyy');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.STEP3_APPEAL_DUE, deadlineUpdates.length, 1).setNumberFormat('MM/dd/yyyy');

    // S, T, U: Days Open, Next Action Due, Days to Deadline
    grievanceSheet.getRange(2, GRIEVANCE_COLS.DAYS_OPEN, metricsUpdates.length, 3).setValues(metricsUpdates);

    // Format Days Open (S) and Days to Deadline (U) as whole numbers
    grievanceSheet.getRange(2, GRIEVANCE_COLS.DAYS_OPEN, metricsUpdates.length, 1).setNumberFormat('0');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.NEXT_ACTION_DUE, metricsUpdates.length, 1).setNumberFormat('MM/dd/yyyy');
    grievanceSheet.getRange(2, GRIEVANCE_COLS.DAYS_TO_DEADLINE, metricsUpdates.length, 1).setNumberFormat('0');

    // X, Y, Z, AA: Email, Unit, Location, Steward
    grievanceSheet.getRange(2, GRIEVANCE_COLS.MEMBER_EMAIL, contactUpdates.length, 4).setValues(contactUpdates);
  }

  Logger.log('Synced grievance formulas to ' + nameUpdates.length + ' grievances');
}

/**
 * Auto-sort the Grievance Log
 *
 * Sort order:
 *   1. STATUS (workflow state): Open â†’ Pending Info â†’ In Arbitration â†’ Appealed â†’ Closed
 *   2. For active cases: Days to Deadline (most urgent first)
 *   3. For closed cases: RESOLUTION (outcome): Won â†’ Settled â†’ Denied â†’ Withdrawn
 */
function sortGrievanceLogByStatus() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) return;

  var lastRow = sheet.getLastRow();
  if (lastRow < 3) return; // Need at least 2 data rows to sort

  // Get all data (excluding header row)
  var dataRange = sheet.getRange(2, 1, lastRow - 1, 34);
  var data = dataRange.getValues();

  data.sort(function(a, b) {
    var statusA = a[GRIEVANCE_COLS.STATUS - 1] || '';
    var statusB = b[GRIEVANCE_COLS.STATUS - 1] || '';

    // Get status priority (default to 99 for unknown)
    var statusPriorityA = GRIEVANCE_STATUS_PRIORITY[statusA] || 99;
    var statusPriorityB = GRIEVANCE_STATUS_PRIORITY[statusB] || 99;

    // 1. Primary sort: by STATUS (workflow state)
    if (statusPriorityA !== statusPriorityB) {
      return statusPriorityA - statusPriorityB;
    }

    // 2. For ACTIVE cases (not Closed): sort by Days to Deadline
    if (statusA !== 'Closed') {
      var daysA = a[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];
      var daysB = b[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];

      if (daysA === '' || daysA === null || isNaN(daysA)) daysA = 9999;
      if (daysB === '' || daysB === null || isNaN(daysB)) daysB = 9999;

      return daysA - daysB;
    }

    // 3. For CLOSED cases: sort by RESOLUTION (outcome)
    var resolutionA = a[GRIEVANCE_COLS.RESOLUTION - 1] || '';
    var resolutionB = b[GRIEVANCE_COLS.RESOLUTION - 1] || '';

    var resPriorityA = GRIEVANCE_RESOLUTION_PRIORITY[resolutionA];
    var resPriorityB = GRIEVANCE_RESOLUTION_PRIORITY[resolutionB];

    // Partial match fallback
    if (resPriorityA === undefined) {
      if (resolutionA.indexOf('Won') >= 0) resPriorityA = 3;
      else if (resolutionA.indexOf('Settled') >= 0) resPriorityA = 6;
      else if (resolutionA.indexOf('Denied') >= 0) resPriorityA = 9;
      else resPriorityA = 50;
    }
    if (resPriorityB === undefined) {
      if (resolutionB.indexOf('Won') >= 0) resPriorityB = 3;
      else if (resolutionB.indexOf('Settled') >= 0) resPriorityB = 6;
      else if (resolutionB.indexOf('Denied') >= 0) resPriorityB = 9;
      else resPriorityB = 50;
    }

    return resPriorityA - resPriorityB;
  });

  // Write sorted data back
  dataRange.setValues(data);

  // Re-apply checkboxes to Message Alert column (AC) - setValues overwrites them
  if (lastRow >= 2) {
    sheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ALERT, lastRow - 1, 1).insertCheckboxes();
  }

  Logger.log('Grievance Log sorted by status and resolution');
}

// ============================================================================
// HIDDEN SHEET 3: _Member_Lookup
// Source: Member Directory â†’ Destination: Grievance Log (C,D,X-AA)
// ============================================================================

/**
 * Setup the _Member_Lookup hidden sheet with self-healing formulas
 * Looks up: First Name, Last Name, Email, Unit, Location, Steward from Member Directory
 */
function setupMemberLookupSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_LOOKUP);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.MEMBER_LOOKUP);
  }

  sheet.clear();

  // Headers
  var headers = ['Member ID', 'First Name', 'Last Name', 'Email', 'Unit', 'Location', 'Assigned Steward'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Get column letters
  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mFirstCol = getColumnLetter(MEMBER_COLS.FIRST_NAME);
  var mLastCol = getColumnLetter(MEMBER_COLS.LAST_NAME);
  var mEmailCol = getColumnLetter(MEMBER_COLS.EMAIL);
  var mUnitCol = getColumnLetter(MEMBER_COLS.UNIT);
  var mLocCol = getColumnLetter(MEMBER_COLS.WORK_LOCATION);
  var mStewardCol = getColumnLetter(MEMBER_COLS.ASSIGNED_STEWARD);

  // Formula to get unique member IDs from Grievance Log
  var gMemberIdCol = getColumnLetter(GRIEVANCE_COLS.MEMBER_ID);
  var memberIdFormula = '=IFERROR(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + '<>"Member ID",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gMemberIdCol + ':' + gMemberIdCol + '<>"")),"")';
  sheet.getRange('A2').setFormula(memberIdFormula);

  // VLOOKUP formulas for member data
  var vlookupBase = 'VLOOKUP(A2:A,\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mStewardCol + ',';

  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '2,FALSE),"")))'); // First Name
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '3,FALSE),"")))'); // Last Name
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '8,FALSE),"")))'); // Email
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '6,FALSE),"")))'); // Unit
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '5,FALSE),"")))'); // Location
  sheet.getRange('G2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(' + vlookupBase + '16,FALSE),"")))'); // Steward

  // Hide the sheet
  sheet.hideSheet();

  Logger.log('_Member_Lookup sheet setup complete');
}

/**
 * Sync member data from hidden sheet to Grievance Log
 */
function syncMemberToGrievanceLog() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var lookupSheet = ss.getSheetByName(SHEETS.MEMBER_LOOKUP);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!lookupSheet || !grievanceSheet) {
    Logger.log('Required sheets not found for member sync');
    return;
  }

  // Get lookup data
  var lookupData = lookupSheet.getDataRange().getValues();
  if (lookupData.length < 2) return;

  // Create lookup map
  var lookup = {};
  for (var i = 1; i < lookupData.length; i++) {
    var memberId = lookupData[i][0];
    if (memberId) {
      lookup[memberId] = {
        firstName: lookupData[i][1],
        lastName: lookupData[i][2],
        email: lookupData[i][3],
        unit: lookupData[i][4],
        location: lookupData[i][5],
        steward: lookupData[i][6]
      };
    }
  }

  // Get grievance data
  var grievanceData = grievanceSheet.getDataRange().getValues();
  if (grievanceData.length < 2) return;

  // Update grievance rows
  var nameUpdates = [];
  var infoUpdates = [];

  for (var j = 1; j < grievanceData.length; j++) {
    var memberId = grievanceData[j][GRIEVANCE_COLS.MEMBER_ID - 1];
    var data = lookup[memberId] || {firstName: '', lastName: '', email: '', unit: '', location: '', steward: ''};
    nameUpdates.push([data.firstName, data.lastName]);
    infoUpdates.push([data.email, data.unit, data.location, data.steward]);
  }

  if (nameUpdates.length > 0) {
    // Update C-D (First Name, Last Name)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.FIRST_NAME, nameUpdates.length, 2).setValues(nameUpdates);
    // Update X-AA (Email, Unit, Location, Steward)
    grievanceSheet.getRange(2, GRIEVANCE_COLS.MEMBER_EMAIL, infoUpdates.length, 4).setValues(infoUpdates);
  }

  Logger.log('Synced member data to ' + nameUpdates.length + ' grievances');
}

// ============================================================================
// HIDDEN SHEET 3: _Steward_Workload_Calc
// Source: Grievance Log + Member Directory â†’ Destination: Steward Workload
// ============================================================================

/**
 * Setup the _Steward_Workload_Calc hidden sheet
 */
function setupStewardWorkloadCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.STEWARD_WORKLOAD_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Steward Name', 'Total Cases', 'Active Cases', 'Resolved', 'Win Rate %', 'Avg Days', 'Overdue', 'Due This Week'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gStewardCol = getColumnLetter(GRIEVANCE_COLS.STEWARD);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);

  // Get unique stewards
  var stewardFormula = '=IFERROR(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + '<>"Assigned Steward",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + '<>"")),"")';
  sheet.getRange('A2').setFormula(stewardFormula);

  // Total Cases
  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A)))');

  // Active Cases (Open + Pending Info)
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")+COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")))');

  // Resolved
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")+COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Won")))');

  // Win Rate
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/B2:B*100,1),0)))');

  // Avg Days (placeholder - needs AVERAGEIF which is complex in ARRAYFORMULA)
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)))');

  // Overdue (Days to Deadline < 0 or blank with active status)
  sheet.getRange('G2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<0")))');

  // Due This Week (0-7 days)
  sheet.getRange('H2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',">=0",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<=7")))');

  sheet.hideSheet();
  Logger.log('_Steward_Workload_Calc sheet setup complete');
}

/**
 * Sync steward workload data to visible sheet
 */
function syncStewardWorkload() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD_CALC);
  var destSheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD);

  if (!calcSheet || !destSheet) return;

  var data = calcSheet.getDataRange().getValues();
  if (data.length < 2) return;

  // Clear existing data (keep headers)
  var lastRow = destSheet.getLastRow();
  if (lastRow > 3) {
    destSheet.getRange(4, 1, lastRow - 3, 9).clear();
  }

  // Copy data (skip header row from calc sheet)
  var outputData = [];
  for (var i = 1; i < data.length; i++) {
    if (data[i][0]) {
      // Add Capacity Status based on active cases
      var activeCases = data[i][2];
      var capacity = activeCases > 10 ? 'Overloaded' : (activeCases > 5 ? 'High' : 'Normal');
      outputData.push([data[i][0], data[i][1], data[i][2], data[i][3], data[i][4], data[i][5], data[i][6], data[i][7], capacity]);
    }
  }

  if (outputData.length > 0) {
    destSheet.getRange(4, 1, outputData.length, 9).setValues(outputData);
  }

  Logger.log('Synced steward workload: ' + outputData.length + ' stewards');
}

// ============================================================================
// HIDDEN SHEET 4: _Interactive_Dashboard_Calc
// Source: Member Directory + Grievance Log â†’ Destination: Interactive Dashboard
// ============================================================================

/**
 * Setup the _Interactive_Dashboard_Calc hidden sheet
 */
function setupInteractiveDashboardCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.INTERACTIVE_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.INTERACTIVE_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Metric', 'Value'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var gIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);

  // Metrics
  var metrics = [
    ['Total Members', '=COUNTA(\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mIdCol + ')-1'],
    ['Active Stewards', '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")'],
    ['Total Grievances', '=COUNTA(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ')-1'],
    ['Open Grievances', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")'],
    ['Pending Info', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")'],
    ['Settled', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")'],
    ['Won', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")'],
    ['Win Rate %', '=IFERROR(ROUND(COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/(COUNTA(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ')-1)*100,1),0)']
  ];

  for (var i = 0; i < metrics.length; i++) {
    sheet.getRange(i + 2, 1).setValue(metrics[i][0]);
    sheet.getRange(i + 2, 2).setFormula(metrics[i][1]);
  }

  sheet.hideSheet();
  Logger.log('_Interactive_Dashboard_Calc sheet setup complete');
}

// ============================================================================
// HIDDEN SHEET 5: _Engagement_Calc (placeholder)
// ============================================================================

function setupEngagementCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.ENGAGEMENT_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.ENGAGEMENT_CALC);
  }

  sheet.clear();
  sheet.getRange('A1').setValue('Engagement Calc - Ready for future implementation');
  sheet.hideSheet();
  Logger.log('_Engagement_Calc sheet setup complete');
}

// ============================================================================
// HIDDEN SHEET 6: _Steward_Contact_Calc
// Source: Member Directory (Y-AA) â†’ Aggregates steward contact tracking metrics
// ============================================================================

/**
 * Setup the _Steward_Contact_Calc hidden sheet with self-healing formulas
 * Tracks and aggregates steward contact data from Member Directory
 */
function setupStewardContactCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.STEWARD_CONTACT_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.STEWARD_CONTACT_CALC);
  }

  sheet.clear();

  // Headers for steward contact summary
  var headers = ['Steward Name', 'Total Contacts', 'Contacts This Month', 'Contacts Last 7 Days', 'Last Contact Date', 'Avg Days Between Contacts'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Get column letters for formulas
  var mContactStewardCol = getColumnLetter(MEMBER_COLS.CONTACT_STEWARD);
  var mContactDateCol = getColumnLetter(MEMBER_COLS.RECENT_CONTACT_DATE);

  // Column A: Unique steward names who have made contacts
  sheet.getRange('A2').setFormula('=IFERROR(SORT(UNIQUE(FILTER(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + '<>""))),)');

  // Column B: Total contacts per steward
  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + ',A2:A)))');

  // Column C: Contacts this month
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + ',A2:A,\'' + SHEETS.MEMBER_DIR + '\'!' + mContactDateCol + ':' + mContactDateCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1))))');

  // Column D: Contacts last 7 days
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + ',A2:A,\'' + SHEETS.MEMBER_DIR + '\'!' + mContactDateCol + ':' + mContactDateCol + ',">="&(TODAY()-7))))');

  // Column E: Most recent contact date for this steward
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(TEXT(MAXIFS(\'' + SHEETS.MEMBER_DIR + '\'!' + mContactDateCol + ':' + mContactDateCol + ',\'' + SHEETS.MEMBER_DIR + '\'!' + mContactStewardCol + ':' + mContactStewardCol + ',A2:A),"MM/dd/yyyy"),"-")))');

  // Column F: Placeholder for avg days between contacts (complex calculation)
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","","-"))');

  // Auto-resize columns
  sheet.autoResizeColumns(1, headers.length);

  sheet.hideSheet();
  Logger.log('_Steward_Contact_Calc sheet setup complete with live formulas');
}

// ============================================================================
// HIDDEN SHEET 7: _Dashboard_Summary_Calc
// Source: Member Directory + Grievance Log â†’ Dashboard Summary Statistics
// ============================================================================

/**
 * Setup the _Dashboard_Summary_Calc hidden sheet with self-healing formulas
 * Calculates key dashboard metrics that auto-update
 */
function setupDashboardSummaryCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.DASHBOARD_SUMMARY_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.DASHBOARD_SUMMARY_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Metric', 'Value', 'Description'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Column references
  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var gIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);

  // Metrics with formulas
  var metrics = [
    ['Total Members', '=COUNTA(\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mIdCol + ')-1', 'Total union members in directory'],
    ['Active Stewards', '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")', 'Members marked as stewards'],
    ['Total Grievances', '=COUNTA(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ')-1', 'All grievances filed'],
    ['Open Grievances', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")', 'Currently open cases'],
    ['Pending Info', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")', 'Cases awaiting information'],
    ['Settled', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")', 'Cases settled'],
    ['Won', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")', 'Cases won (full or partial)'],
    ['Denied', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Denied")', 'Cases denied'],
    ['Withdrawn', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Withdrawn")', 'Cases withdrawn'],
    ['Win Rate %', '=IFERROR(ROUND(COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/(COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Denied")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*"))*100,1),0)', 'Wins / (Wins + Settled + Denied)'],
    ['Avg Days to Resolution', '=IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<>",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)', 'Average days for closed cases'],
    ['Overdue Cases', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<0")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"Overdue")', 'Cases past deadline'],
    ['Due This Week', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',">=0",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<=7")', 'Cases due in next 7 days'],
    ['Filed This Month', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<="&TODAY())', 'Grievances filed this month'],
    ['Closed This Month', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&TODAY())', 'Grievances closed this month']
  ];

  for (var i = 0; i < metrics.length; i++) {
    sheet.getRange(i + 2, 1).setValue(metrics[i][0]);
    sheet.getRange(i + 2, 2).setFormula(metrics[i][1]);
    sheet.getRange(i + 2, 3).setValue(metrics[i][2]);
  }

  sheet.setColumnWidth(1, 180);
  sheet.setColumnWidth(2, 100);
  sheet.setColumnWidth(3, 300);

  sheet.hideSheet();
  Logger.log('_Dashboard_Summary_Calc sheet setup complete');
}

/**
 * Sync dashboard summary to visible Dashboard sheet
 */
function syncDashboardSummary() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.DASHBOARD_SUMMARY_CALC);
  var dashboardSheet = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!calcSheet || !dashboardSheet) return;

  var data = calcSheet.getDataRange().getValues();
  // Dashboard sync can be customized based on dashboard layout
  Logger.log('Dashboard summary data available: ' + (data.length - 1) + ' metrics');
}

// ============================================================================
// HIDDEN SHEET 8: _Trends_Calc
// Source: Grievance Log â†’ Time-Series Analytics
// ============================================================================

/**
 * Setup the _Trends_Calc hidden sheet with self-healing formulas
 * Calculates monthly trends and rolling averages
 */
function setupTrendsCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.TRENDS_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.TRENDS_CALC);
  }

  sheet.clear();

  // Headers for monthly data
  var headers = ['Month', 'Year', 'Filed', 'Closed', 'Won', 'Lost', 'Win Rate %', 'Avg Days Open', 'Net Change'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);

  // Generate last 12 months of data
  for (var i = 0; i < 12; i++) {
    var row = i + 2;
    // Month (current month - i)
    sheet.getRange(row, 1).setFormula('=TEXT(EOMONTH(TODAY(),-' + i + '),"MMMM")');
    // Year
    sheet.getRange(row, 2).setFormula('=YEAR(EOMONTH(TODAY(),-' + i + '))');
    // Filed that month
    sheet.getRange(row, 3).setFormula('=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(EOMONTH(TODAY(),-' + i + ')),MONTH(EOMONTH(TODAY(),-' + i + ')),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<="&EOMONTH(TODAY(),-' + i + '))');
    // Closed that month
    sheet.getRange(row, 4).setFormula('=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(EOMONTH(TODAY(),-' + i + ')),MONTH(EOMONTH(TODAY(),-' + i + ')),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&EOMONTH(TODAY(),-' + i + '))');
    // Won that month
    sheet.getRange(row, 5).setFormula('=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(EOMONTH(TODAY(),-' + i + ')),MONTH(EOMONTH(TODAY(),-' + i + ')),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&EOMONTH(TODAY(),-' + i + '),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")');
    // Lost/Denied that month
    sheet.getRange(row, 6).setFormula('=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(EOMONTH(TODAY(),-' + i + ')),MONTH(EOMONTH(TODAY(),-' + i + ')),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&EOMONTH(TODAY(),-' + i + '),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Denied")');
    // Win Rate %
    sheet.getRange(row, 7).setFormula('=IFERROR(ROUND(E' + row + '/(E' + row + '+F' + row + ')*100,1),0)');
    // Avg Days Open for closed cases that month
    sheet.getRange(row, 8).setFormula('=IFERROR(ROUND(AVERAGEIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + ',\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(EOMONTH(TODAY(),-' + i + ')),MONTH(EOMONTH(TODAY(),-' + i + ')),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&EOMONTH(TODAY(),-' + i + ')),1),0)');
    // Net Change (Filed - Closed)
    sheet.getRange(row, 9).setFormula('=C' + row + '-D' + row);
  }

  // Add summary row
  sheet.getRange(15, 1).setValue('TOTALS (12 mo)');
  sheet.getRange(15, 3).setFormula('=SUM(C2:C13)');
  sheet.getRange(15, 4).setFormula('=SUM(D2:D13)');
  sheet.getRange(15, 5).setFormula('=SUM(E2:E13)');
  sheet.getRange(15, 6).setFormula('=SUM(F2:F13)');
  sheet.getRange(15, 7).setFormula('=IFERROR(ROUND(E15/(E15+F15)*100,1),0)');
  sheet.getRange(15, 8).setFormula('=IFERROR(ROUND(AVERAGE(H2:H13),1),0)');
  sheet.getRange(15, 9).setFormula('=SUM(I2:I13)');
  sheet.getRange(15, 1, 1, 9).setFontWeight('bold').setBackground(COLORS.LIGHT_GRAY);

  sheet.hideSheet();
  Logger.log('_Trends_Calc sheet setup complete');
}

/**
 * Sync trends to visible Trends sheet
 */
function syncTrends() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.TRENDS_CALC);
  var trendsSheet = ss.getSheetByName(SHEETS.TRENDS);

  if (!calcSheet || !trendsSheet) return;

  var data = calcSheet.getDataRange().getValues();
  Logger.log('Trends data available: ' + (data.length - 1) + ' months');
}

// ============================================================================
// HIDDEN SHEET 9: _Location_Analytics_Calc
// Source: Grievance Log â†’ Location Breakdown
// ============================================================================

/**
 * Setup the _Location_Analytics_Calc hidden sheet
 * Calculates grievance metrics by location
 */
function setupLocationAnalyticsCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.LOCATION_ANALYTICS_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.LOCATION_ANALYTICS_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Location', 'Total Cases', 'Open', 'Closed', 'Won', 'Win Rate %', 'Avg Days', 'Overdue'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gLocationCol = getColumnLetter(GRIEVANCE_COLS.LOCATION);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);

  // Get unique locations
  sheet.getRange('A2').setFormula(
    '=IFERROR(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + '<>"Location",' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + '<>"")),"")'
  );

  // Total Cases per location
  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A)))');

  // Open cases per location
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")))');

  // Closed cases per location
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A)-C2:C))');

  // Won cases per location
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")))');

  // Win Rate per location
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(E2:E/D2:D*100,1),0)))');

  // Avg Days per location
  sheet.getRange('G2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)))');

  // Overdue per location
  sheet.getRange('H2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gLocationCol + ':' + gLocationCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<0")))');

  sheet.hideSheet();
  Logger.log('_Location_Analytics_Calc sheet setup complete');
}

/**
 * Sync location analytics to visible sheet
 */
function syncLocationAnalytics() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.LOCATION_ANALYTICS_CALC);
  var destSheet = ss.getSheetByName(SHEETS.LOCATION_ANALYTICS);

  if (!calcSheet || !destSheet) return;

  var data = calcSheet.getDataRange().getValues();
  Logger.log('Location analytics data available: ' + (data.length - 1) + ' locations');
}

// ============================================================================
// HIDDEN SHEET 10: _Type_Analysis_Calc
// Source: Grievance Log â†’ Issue Category/Type Breakdown
// ============================================================================

/**
 * Setup the _Type_Analysis_Calc hidden sheet
 * Calculates grievance metrics by issue category
 */
function setupTypeAnalysisCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.TYPE_ANALYSIS_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.TYPE_ANALYSIS_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Issue Category', 'Total Cases', 'Open', 'Closed', 'Won', 'Win Rate %', 'Avg Days', 'Most Common Article'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gCategoryCol = getColumnLetter(GRIEVANCE_COLS.ISSUE_CATEGORY);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gArticlesCol = getColumnLetter(GRIEVANCE_COLS.ARTICLES_VIOLATED);

  // Get unique categories
  sheet.getRange('A2').setFormula(
    '=IFERROR(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"Issue Category",' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + '<>"")),"")'
  );

  // Total Cases per category
  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',A2:A)))');

  // Open cases per category
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")))');

  // Closed cases per category
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",B2:B-C2:C))');

  // Won cases per category
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")))');

  // Win Rate per category
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(E2:E/D2:D*100,1),0)))');

  // Avg Days per category
  sheet.getRange('G2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gCategoryCol + ':' + gCategoryCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)))');

  // Most Common Article (placeholder - complex to calculate dynamically)
  sheet.getRange('H2').setValue('See Articles Analysis');

  sheet.hideSheet();
  Logger.log('_Type_Analysis_Calc sheet setup complete');
}

/**
 * Sync type analysis to visible sheet
 */
function syncTypeAnalysis() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.TYPE_ANALYSIS_CALC);
  var destSheet = ss.getSheetByName(SHEETS.TYPE_ANALYSIS);

  if (!calcSheet || !destSheet) return;

  var data = calcSheet.getDataRange().getValues();
  Logger.log('Type analysis data available: ' + (data.length - 1) + ' categories');
}

// ============================================================================
// HIDDEN SHEET 11: _Steward_Performance_Calc
// Source: Grievance Log â†’ Steward Performance Metrics
// ============================================================================

/**
 * Setup the _Steward_Performance_Calc hidden sheet
 * Calculates detailed steward performance metrics
 */
function setupStewardPerformanceCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.STEWARD_PERFORMANCE_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.STEWARD_PERFORMANCE_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Steward', 'Total Cases', 'Active', 'Closed', 'Won', 'Win Rate %', 'Avg Days', 'Overdue', 'Due This Week', 'Performance Score'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gStewardCol = getColumnLetter(GRIEVANCE_COLS.STEWARD);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);

  // Get unique stewards
  sheet.getRange('A2').setFormula(
    '=IFERROR(UNIQUE(FILTER(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + '<>"Assigned Steward",' +
    '\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + '<>"")),"")'
  );

  // Total Cases
  sheet.getRange('B2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A)))');

  // Active Cases (Open + Pending Info)
  sheet.getRange('C2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")+COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")))');

  // Closed Cases
  sheet.getRange('D2').setFormula('=ARRAYFORMULA(IF(A2:A="","",B2:B-C2:C))');

  // Won Cases
  sheet.getRange('E2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")))');

  // Win Rate
  sheet.getRange('F2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(E2:E/D2:D*100,1),0)))');

  // Avg Days
  sheet.getRange('G2').setFormula('=ARRAYFORMULA(IF(A2:A="","",IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)))');

  // Overdue
  sheet.getRange('H2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<0")))');

  // Due This Week
  sheet.getRange('I2').setFormula('=ARRAYFORMULA(IF(A2:A="","",COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStewardCol + ':' + gStewardCol + ',A2:A,\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',">=0",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<=7")))');

  // Performance Score (weighted: Win Rate * 0.4 + (100 - Overdue%) * 0.3 + (100 - AvgDays/60*100) * 0.3)
  sheet.getRange('J2').setFormula('=ARRAYFORMULA(IF(A2:A="","",ROUND(F2:F*0.4 + (100-IFERROR(H2:H/C2:C*100,0))*0.3 + MAX(0,100-G2:G/60*100)*0.3,1)))');

  sheet.hideSheet();
  Logger.log('_Steward_Performance_Calc sheet setup complete');
}

/**
 * Sync steward performance to visible sheet
 */
function syncStewardPerformance() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.STEWARD_PERFORMANCE_CALC);

  if (!calcSheet) return;

  var data = calcSheet.getDataRange().getValues();
  Logger.log('Steward performance data available: ' + (data.length - 1) + ' stewards');
}

// ============================================================================
// HIDDEN SHEET 12: _Cost_Impact_Calc
// Source: Grievance Log â†’ Financial Impact Estimates
// ============================================================================

/**
 * Setup the _Cost_Impact_Calc hidden sheet
 * Calculates estimated financial impact of grievances
 */
function setupCostImpactCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.COST_IMPACT_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.COST_IMPACT_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Metric', 'Value', 'Description'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);

  // Estimated values (configurable assumptions)
  var avgWonValue = 2500;  // Average value of a won grievance
  var avgSettledValue = 1500;  // Average value of a settled grievance
  var costPerDay = 50;  // Estimated cost per day of unresolved grievance

  var metrics = [
    ['Won Cases (Full)', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"Won - Full remedy")', 'Grievances won with full remedy'],
    ['Won Cases (Partial)', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"Won - Partial remedy")', 'Grievances won with partial remedy'],
    ['Settled Cases', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")', 'Grievances settled through negotiation'],
    ['Est. Value of Wins', '=B2*' + avgWonValue + '+B3*' + (avgWonValue * 0.6), 'Estimated dollar value of won cases'],
    ['Est. Value of Settlements', '=B4*' + avgSettledValue, 'Estimated dollar value of settlements'],
    ['Total Recovered Value', '=B5+B6', 'Total estimated value recovered for members'],
    ['Open Cases Count', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")', 'Currently open grievances'],
    ['Total Days Open (Active)', '=SUMIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + ')+SUMIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + ')', 'Sum of days open for active cases'],
    ['Est. Ongoing Cost', '=B9*' + costPerDay, 'Estimated cost of unresolved grievances'],
    ['Avg Value Per Case', '=IFERROR(ROUND(B7/(B2+B3+B4),2),0)', 'Average value recovered per resolved case'],
    ['ROI Estimate', '=IFERROR(ROUND(B7/B10*100,1),0)', 'Return on investment estimate (%)']
  ];

  for (var i = 0; i < metrics.length; i++) {
    sheet.getRange(i + 2, 1).setValue(metrics[i][0]);
    sheet.getRange(i + 2, 2).setFormula(metrics[i][1]);
    sheet.getRange(i + 2, 3).setValue(metrics[i][2]);
  }

  // Format currency columns
  sheet.getRange('B5:B7').setNumberFormat('$#,##0');
  sheet.getRange('B10:B11').setNumberFormat('$#,##0');

  sheet.setColumnWidth(1, 200);
  sheet.setColumnWidth(2, 120);
  sheet.setColumnWidth(3, 350);

  sheet.hideSheet();
  Logger.log('_Cost_Impact_Calc sheet setup complete');
}

/**
 * Sync cost impact to visible sheet
 */
function syncCostImpact() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var calcSheet = ss.getSheetByName(SHEETS.COST_IMPACT_CALC);
  var destSheet = ss.getSheetByName(SHEETS.COST_IMPACT);

  if (!calcSheet || !destSheet) return;

  var data = calcSheet.getDataRange().getValues();
  Logger.log('Cost impact data available: ' + (data.length - 1) + ' metrics');
}

// ============================================================================
// AUTO-SYNC TRIGGERS
// ============================================================================

/**
 * Master onEdit trigger - routes to appropriate sync function
 * Install this as an installable trigger
 */
function onEditAutoSync(e) {
  if (!e || !e.range) return;

  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();

  // Debounce - use cache to prevent rapid re-syncs
  var cache = CacheService.getScriptCache();
  var cacheKey = 'lastSync_' + sheetName;
  var lastSync = cache.get(cacheKey);

  if (lastSync) {
    return; // Skip if synced within last 2 seconds
  }

  cache.put(cacheKey, 'true', 2); // 2 second debounce

  try {
    if (sheetName === SHEETS.GRIEVANCE_LOG) {
      // Grievance Log changed - sync formulas and update Member Directory
      syncGrievanceFormulasToLog();
      syncGrievanceToMemberDirectory();
      // Auto-sort by status priority (active cases first, then by deadline urgency)
      sortGrievanceLogByStatus();
    } else if (sheetName === SHEETS.MEMBER_DIR) {
      // Member Directory changed - sync to Grievance Log
      syncGrievanceFormulasToLog();
      syncMemberToGrievanceLog();
    }
  } catch (error) {
    Logger.log('Auto-sync error: ' + error.message);
  }
}

/**
 * Install the auto-sync trigger
 */
function installAutoSyncTrigger() {
  // Remove existing triggers first
  var triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'onEditAutoSync') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Install new trigger
  ScriptApp.newTrigger('onEditAutoSync')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit()
    .create();

  Logger.log('Auto-sync trigger installed');
  SpreadsheetApp.getActiveSpreadsheet().toast('Auto-sync trigger installed!', 'âœ… Success', 3);
}

/**
 * Remove the auto-sync trigger
 */
function removeAutoSyncTrigger() {
  var triggers = ScriptApp.getProjectTriggers();
  var removed = 0;

  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'onEditAutoSync') {
      ScriptApp.deleteTrigger(trigger);
      removed++;
    }
  });

  Logger.log('Removed ' + removed + ' auto-sync triggers');
  SpreadsheetApp.getActiveSpreadsheet().toast('Auto-sync trigger removed', 'Info', 3);
}

// ============================================================================
// HIDDEN SHEET 5: _Dashboard_Calc
// Source: Member Directory + Grievance Log â†’ Dashboard Summary Statistics
// ============================================================================

/**
 * Setup the _Dashboard_Calc hidden sheet with self-healing formulas
 * Calculates key dashboard metrics that auto-update
 */
function setupDashboardCalcSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.DASHBOARD_CALC);

  if (!sheet) {
    sheet = ss.insertSheet(SHEETS.DASHBOARD_CALC);
  }

  sheet.clear();

  // Headers
  var headers = ['Metric', 'Value', 'Description'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers])
    .setFontWeight('bold')
    .setBackground(COLORS.LIGHT_GRAY);

  // Column references
  var mIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  var mStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  var gIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  var gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  var gResolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  var gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  var gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  var gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  var gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);

  // Metrics with formulas (15 key metrics)
  var metrics = [
    ['Total Members', '=COUNTA(\'' + SHEETS.MEMBER_DIR + '\'!' + mIdCol + ':' + mIdCol + ')-1', 'Total union members in directory'],
    ['Active Stewards', '=COUNTIF(\'' + SHEETS.MEMBER_DIR + '\'!' + mStewardCol + ':' + mStewardCol + ',"Yes")', 'Members marked as stewards'],
    ['Total Grievances', '=COUNTA(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gIdCol + ':' + gIdCol + ')-1', 'All grievances filed'],
    ['Open Grievances', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Open")', 'Currently open cases'],
    ['Pending Info', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Pending Info")', 'Cases awaiting information'],
    ['Settled', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")', 'Cases settled'],
    ['Won', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")', 'Cases won (full or partial)'],
    ['Denied', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Denied")', 'Cases denied'],
    ['Withdrawn', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Withdrawn")', 'Cases withdrawn'],
    ['Win Rate %', '=IFERROR(ROUND(COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*")/(COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Settled")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gStatusCol + ':' + gStatusCol + ',"Denied")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gResolutionCol + ':' + gResolutionCol + ',"*Won*"))*100,1),0)', 'Wins / (Wins + Settled + Denied)'],
    ['Avg Days to Resolution', '=IFERROR(ROUND(AVERAGEIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<>",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysOpenCol + ':' + gDaysOpenCol + '),1),0)', 'Average days for closed cases'],
    ['Overdue Cases', '=COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<0")+COUNTIF(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"Overdue")', 'Cases past deadline'],
    ['Due This Week', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',">=0",\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDaysToDeadlineCol + ':' + gDaysToDeadlineCol + ',"<=7")', 'Cases due in next 7 days'],
    ['Filed This Month', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateFiledCol + ':' + gDateFiledCol + ',"<="&TODAY())', 'Grievances filed this month'],
    ['Closed This Month', '=COUNTIFS(\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1),\'' + SHEETS.GRIEVANCE_LOG + '\'!' + gDateClosedCol + ':' + gDateClosedCol + ',"<="&TODAY())', 'Grievances closed this month']
  ];

  for (var i = 0; i < metrics.length; i++) {
    sheet.getRange(i + 2, 1).setValue(metrics[i][0]);
    sheet.getRange(i + 2, 2).setFormula(metrics[i][1]);
    sheet.getRange(i + 2, 3).setValue(metrics[i][2]);
  }

  sheet.setColumnWidth(1, 180);
  sheet.setColumnWidth(2, 100);
  sheet.setColumnWidth(3, 300);

  sheet.hideSheet();
  Logger.log('_Dashboard_Calc sheet setup complete');
}

// ============================================================================
// MASTER SETUP & REPAIR FUNCTIONS
// ============================================================================

/**
 * Setup all hidden calculation sheets
 */
function setupAllHiddenSheets() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Setting up hidden calculation sheets...', 'ğŸ”§ Setup', 3);

  // Core grievance/member calculation sheets (5 total)
  setupGrievanceCalcSheet();
  setupGrievanceFormulasSheet();
  setupMemberLookupSheet();
  setupStewardContactCalcSheet();
  setupDashboardCalcSheet();

  ss.toast('All 5 hidden sheets created!', 'âœ… Success', 3);
}

/**
 * Repair all hidden sheets - recreates formulas and syncs data
 */
function repairAllHiddenSheets() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();

  ss.toast('Repairing hidden sheets...', 'ğŸ”§ Repair', 3);

  // Recreate all hidden sheets with formulas
  setupAllHiddenSheets();

  // Install trigger
  installAutoSyncTrigger();

  // Run initial sync
  ss.toast('Running initial data sync...', 'ğŸ”§ Sync', 3);
  syncGrievanceFormulasToLog();
  syncGrievanceToMemberDirectory();
  syncMemberToGrievanceLog();

  // Repair checkboxes
  repairGrievanceCheckboxes();
  repairMemberCheckboxes();

  ss.toast('Hidden sheets repaired and synced!', 'âœ… Success', 5);
  ui.alert('âœ… Repair Complete',
    'Hidden calculation sheets have been repaired:\n\n' +
    'â€¢ 5 hidden sheets recreated with self-healing formulas\n' +
    'â€¢ Auto-sync trigger installed\n' +
    'â€¢ All data synced (grievances, members, dashboard)\n' +
    'â€¢ Checkboxes repaired in Grievance Log and Member Directory\n\n' +
    'Data will now auto-sync when you edit Member Directory or Grievance Log.\n' +
    'Formulas cannot be accidentally erased - they are stored in hidden sheets.',
    ui.ButtonSet.OK);
}

/**
 * Verify all hidden sheets and triggers
 */
function verifyHiddenSheets() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();
  var report = [];

  report.push('ğŸ” HIDDEN SHEET VERIFICATION');
  report.push('============================');
  report.push('');

  // Check each hidden sheet (5 hidden sheets)
  var hiddenSheets = [
    {name: SHEETS.GRIEVANCE_CALC, purpose: 'Grievance â†’ Member Directory'},
    {name: SHEETS.GRIEVANCE_FORMULAS, purpose: 'Self-healing Grievance formulas'},
    {name: SHEETS.MEMBER_LOOKUP, purpose: 'Member â†’ Grievance Log'},
    {name: SHEETS.STEWARD_CONTACT_CALC, purpose: 'Steward contact tracking'},
    {name: SHEETS.DASHBOARD_CALC, purpose: 'Dashboard summary metrics'}
  ];

  report.push('ğŸ“‹ HIDDEN SHEETS:');
  hiddenSheets.forEach(function(hs) {
    var sheet = ss.getSheetByName(hs.name);
    if (sheet) {
      var isHidden = sheet.isSheetHidden();
      var hasData = sheet.getLastRow() > 1;
      var status = isHidden && hasData ? 'âœ…' : (sheet ? 'âš ï¸' : 'âŒ');
      report.push('  ' + status + ' ' + hs.name);
      report.push('      Hidden: ' + (isHidden ? 'Yes' : 'NO - Should be hidden'));
      report.push('      Has formulas: ' + (hasData ? 'Yes' : 'No'));
    } else {
      report.push('  âŒ ' + hs.name + ' - NOT FOUND');
    }
  });

  report.push('');

  // Check triggers
  report.push('âš¡ AUTO-SYNC TRIGGER:');
  var triggers = ScriptApp.getProjectTriggers();
  var hasAutoSync = false;
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'onEditAutoSync') {
      hasAutoSync = true;
      report.push('  âœ… onEditAutoSync trigger installed');
    }
  });
  if (!hasAutoSync) {
    report.push('  âŒ onEditAutoSync trigger NOT installed');
    report.push('     Run: installAutoSyncTrigger()');
  }

  report.push('');
  report.push('============================');

  ui.alert('Hidden Sheet Verification', report.join('\n'), ui.ButtonSet.OK);
  Logger.log(report.join('\n'));
}

/**
 * Manual sync all data
 */
function syncAllData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Syncing all data...', 'ğŸ”„ Sync', 3);

  syncGrievanceFormulasToLog();
  syncGrievanceToMemberDirectory();
  syncMemberToGrievanceLog();

  // Repair checkboxes after sync
  repairGrievanceCheckboxes();
  repairMemberCheckboxes();

  ss.toast('All data synced!', 'âœ… Success', 3);
}

/**
 * Refresh all formulas (force recalculation)
 */
function refreshAllHiddenFormulas() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // Touch each hidden sheet to force recalc
  var hiddenSheetNames = [
    SHEETS.GRIEVANCE_CALC,
    SHEETS.GRIEVANCE_FORMULAS,
    SHEETS.MEMBER_LOOKUP,
    SHEETS.STEWARD_WORKLOAD_CALC,
    SHEETS.INTERACTIVE_CALC
  ];

  hiddenSheetNames.forEach(function(name) {
    var sheet = ss.getSheetByName(name);
    if (sheet) {
      // Force recalc by getting values
      sheet.getDataRange().getValues();
    }
  });

  // Then sync
  syncAllData();

  // Repair checkboxes
  repairGrievanceCheckboxes();

  ss.toast('Formulas refreshed and data synced!', 'âœ… Success', 3);
}

/**
 * Repair checkboxes in Grievance Log (Message Alert column AC)
 * Call this after any bulk data operations that might overwrite checkboxes
 */
function repairGrievanceCheckboxes() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return;

  var lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) return;

  // Re-apply checkboxes to Message Alert column (AC = column 29)
  grievanceSheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ALERT, lastRow - 1, 1).insertCheckboxes();

  Logger.log('Repaired checkboxes for ' + (lastRow - 1) + ' grievance rows');
}

/**
 * Repair checkboxes in Member Directory (Start Grievance column AE)
 */
function repairMemberCheckboxes() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) return;

  var lastRow = memberSheet.getLastRow();
  if (lastRow < 2) return;

  // Re-apply checkboxes to Start Grievance column (AE = column 31)
  memberSheet.getRange(2, MEMBER_COLS.START_GRIEVANCE, lastRow - 1, 1).insertCheckboxes();

  Logger.log('Repaired checkboxes for ' + (lastRow - 1) + ' member rows');
}

/**
 * Repair all checkboxes in both sheets
 */
function repairAllCheckboxes() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Repairing checkboxes...', 'ğŸ”§ Repair', 2);

  repairGrievanceCheckboxes();
  repairMemberCheckboxes();

  ss.toast('All checkboxes repaired!', 'âœ… Success', 3);
}



// ================================================================================
// MODULE: SeedNuke.gs
// Source: SeedNuke.gs
// ================================================================================

/**
 * 509 Dashboard - Seed and Nuke Functions
 *
 * Functions for seeding sample data and clearing data.
 * Seeded data is tracked separately from manually entered data.
 * NUKE only removes seeded data, preserving manual entries.
 *
 * @version 1.0.0
 * @license Free for use by non-profit collective bargaining groups and unions
 */

// ============================================================================
// DEMO MODE TRACKING
// ============================================================================

/**
 * Check if demo mode has been disabled (after nuke)
 * @returns {boolean} True if demo mode is disabled
 */
function isDemoModeDisabled() {
  var props = PropertiesService.getScriptProperties();
  return props.getProperty('DEMO_MODE_DISABLED') === 'true';
}

/**
 * Disable demo mode permanently (called after nuke)
 */
function disableDemoMode() {
  var props = PropertiesService.getScriptProperties();
  props.setProperty('DEMO_MODE_DISABLED', 'true');
  // Clear tracked IDs since they're no longer needed
  props.deleteProperty('SEEDED_MEMBER_IDS');
  props.deleteProperty('SEEDED_GRIEVANCE_IDS');
}

/**
 * Track a seeded member ID
 * @param {string} memberId - The member ID to track
 */
function trackSeededMemberId(memberId) {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_MEMBER_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  if (ids.indexOf(memberId) === -1) {
    ids.push(memberId);
    props.setProperty('SEEDED_MEMBER_IDS', ids.join(','));
  }
}

/**
 * Track a seeded grievance ID
 * @param {string} grievanceId - The grievance ID to track
 */
function trackSeededGrievanceId(grievanceId) {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_GRIEVANCE_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  if (ids.indexOf(grievanceId) === -1) {
    ids.push(grievanceId);
    props.setProperty('SEEDED_GRIEVANCE_IDS', ids.join(','));
  }
}

/**
 * Get all tracked seeded member IDs
 * @returns {Object} Object with member IDs as keys for quick lookup
 */
function getSeededMemberIds() {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_MEMBER_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  var lookup = {};
  ids.forEach(function(id) { if (id) lookup[id] = true; });
  return lookup;
}

/**
 * Get all tracked seeded grievance IDs
 * @returns {Object} Object with grievance IDs as keys for quick lookup
 */
function getSeededGrievanceIds() {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_GRIEVANCE_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  var lookup = {};
  ids.forEach(function(id) { if (id) lookup[id] = true; });
  return lookup;
}

/**
 * Batch track multiple seeded member IDs (more efficient than individual calls)
 * @param {Array<string>} memberIds - Array of member IDs to track
 */
function trackSeededMemberIdsBatch(memberIds) {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_MEMBER_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  memberIds.forEach(function(id) {
    if (id && ids.indexOf(id) === -1) ids.push(id);
  });
  props.setProperty('SEEDED_MEMBER_IDS', ids.join(','));
}

/**
 * Batch track multiple seeded grievance IDs (more efficient than individual calls)
 * @param {Array<string>} grievanceIds - Array of grievance IDs to track
 */
function trackSeededGrievanceIdsBatch(grievanceIds) {
  var props = PropertiesService.getScriptProperties();
  var existing = props.getProperty('SEEDED_GRIEVANCE_IDS') || '';
  var ids = existing ? existing.split(',') : [];
  grievanceIds.forEach(function(id) {
    if (id && ids.indexOf(id) === -1) ids.push(id);
  });
  props.setProperty('SEEDED_GRIEVANCE_IDS', ids.join(','));
}

// ============================================================================
// SEED FUNCTIONS
// ============================================================================

/**
 * Seed all sample data: Config + 50 members + 25 grievances
 */
function SEED_SAMPLE_DATA() {
  var ui = SpreadsheetApp.getUi();
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  var response = ui.alert(
    'ğŸš€ Seed Sample Data',
    'This will seed:\n' +
    'â€¢ Config dropdowns (Job Titles, Locations, etc.)\n' +
    'â€¢ 50 sample members\n' +
    'â€¢ 25 sample grievances\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  ss.toast('Seeding config data...', 'ğŸŒ± Seeding', 3);
  seedConfigData();

  ss.toast('Seeding members...', 'ğŸŒ± Seeding', 3);
  SEED_MEMBERS(50);

  ss.toast('Seeding grievances...', 'ğŸŒ± Seeding', 3);
  SEED_GRIEVANCES(25);

  ss.toast('Sample data seeded successfully!', 'âœ… Success', 5);
  ui.alert('âœ… Success', 'Sample data has been seeded!\n\n' +
    'â€¢ Config dropdowns populated\n' +
    'â€¢ 50 members added\n' +
    'â€¢ 25 grievances added', ui.ButtonSet.OK);
}

/**
 * Seed Config sheet with dropdown values
 * Note: Data starts at row 3 (row 1 = section headers, row 2 = column headers)
 */
function seedConfigData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Error: Config sheet not found. Please run CREATE_509_DASHBOARD first.');
    return;
  }

  // Data row start (after section headers row 1 and column headers row 2)
  var dataStartRow = 3;

  // Helper: only seed column if it's empty (preserves user data)
  function seedIfEmpty(column, values) {
    var existing = getConfigValues(sheet, column);
    if (existing.length === 0) {
      sheet.getRange(dataStartRow, column, values.length, 1)
        .setValues(values.map(function(v) { return [v]; }));
      return true;
    }
    return false;
  }

  var seededAny = false;

  // Job Titles (Column A)
  if (seedIfEmpty(CONFIG_COLS.JOB_TITLES, [
    'Social Worker', 'Case Manager', 'Program Coordinator', 'Administrative Assistant',
    'Supervisor', 'Director', 'Clinician', 'Counselor', 'Specialist', 'Analyst',
    'Manager', 'Senior Social Worker', 'Lead Case Manager', 'Program Manager',
    'Executive Assistant', 'HR Coordinator', 'Finance Associate', 'IT Support',
    'Communications Specialist', 'Outreach Worker'
  ])) seededAny = true;

  // Office Locations (Column B)
  if (seedIfEmpty(CONFIG_COLS.OFFICE_LOCATIONS, [
    'Boston Main Office', 'Worcester Regional', 'Springfield Center', 'Cambridge Branch',
    'Lowell Office', 'Brockton Center', 'Quincy Regional', 'New Bedford Office',
    'Fall River Branch', 'Lawrence Center', 'Framingham Office', 'Somerville Branch',
    'Lynn Regional', 'Haverhill Center', 'Malden Office', 'Medford Branch',
    'Waltham Regional', 'Newton Center', 'Brookline Office', 'Salem Branch'
  ])) seededAny = true;

  // Units (Column C)
  if (seedIfEmpty(CONFIG_COLS.UNITS, [
    'Child Welfare', 'Adult Services', 'Mental Health', 'Disability Services',
    'Elder Affairs', 'Housing Assistance', 'Employment Services', 'Youth Services',
    'Family Support', 'Administration'
  ])) seededAny = true;

  // Supervisors (Column F)
  if (seedIfEmpty(CONFIG_COLS.SUPERVISORS, [
    'Maria Rodriguez', 'James Wilson', 'Sarah Chen', 'Michael Brown',
    'Jennifer Davis', 'Robert Taylor', 'Lisa Anderson', 'David Martinez',
    'Emily Johnson', 'Christopher Lee', 'Amanda White', 'Daniel Garcia'
  ])) seededAny = true;

  // Managers (Column G)
  if (seedIfEmpty(CONFIG_COLS.MANAGERS, [
    'Patricia Thompson', 'William Jackson', 'Elizabeth Moore', 'Richard Harris',
    'Susan Clark', 'Joseph Lewis', 'Margaret Robinson', 'Charles Walker'
  ])) seededAny = true;

  // Stewards (Column H)
  if (seedIfEmpty(CONFIG_COLS.STEWARDS, [
    'John Smith', 'Mary Johnson', 'Robert Williams', 'Patricia Jones',
    'Michael Davis', 'Linda Miller', 'William Brown', 'Barbara Wilson',
    'David Moore', 'Susan Taylor', 'James Anderson', 'Karen Thomas'
  ])) seededAny = true;

  // Steward Committees (Column I)
  if (seedIfEmpty(CONFIG_COLS.STEWARD_COMMITTEES, [
    'Grievance Committee', 'Bargaining Committee', 'Health & Safety Committee',
    'Political Action Committee', 'Membership Committee', 'Executive Board'
  ])) seededAny = true;

  // Home Towns (Column AF)
  if (seedIfEmpty(CONFIG_COLS.HOME_TOWNS, [
    'Boston', 'Worcester', 'Springfield', 'Cambridge', 'Lowell', 'Brockton',
    'Quincy', 'New Bedford', 'Fall River', 'Lawrence', 'Framingham', 'Somerville',
    'Lynn', 'Haverhill', 'Malden', 'Medford', 'Waltham', 'Newton', 'Brookline'
  ])) seededAny = true;

  if (seededAny) {
    SpreadsheetApp.getActiveSpreadsheet().toast('Config data seeded!', 'âœ… Success', 3);
  }
}

/**
 * Restore Config dropdowns AND re-apply dropdown validations to Member Directory and Grievance Log
 * This is the full restore function for use after nuking or when dropdowns are missing
 */
function restoreConfigAndDropdowns() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  ss.toast('Restoring Config values...', 'ğŸ”„ Restoring', 2);

  // First, seed the Config values
  seedConfigData();

  ss.toast('Applying dropdown validations...', 'ğŸ”„ Restoring', 2);

  // Then, re-apply dropdown validations to Member Directory and Grievance Log
  setupDataValidations();

  ss.toast('Config and dropdowns restored!', 'âœ… Success', 3);
}

/**
 * Seed N members and optionally seed grievances for some of them
 * @param {number} count - Number of members to seed (max 2000)
 * @param {number} grievancePercent - Percentage of members to give grievances (0-100, default 30)
 */
function SEED_MEMBERS(count, grievancePercent) {
  count = Math.min(count || 50, 2000);
  grievancePercent = (grievancePercent !== undefined) ? grievancePercent : 30; // Default 30% get grievances

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  var configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!memberSheet || !grievanceSheet || !configSheet) {
    SpreadsheetApp.getUi().alert('Error: Required sheets not found.');
    return;
  }

  // Always ensure Config has data for all required columns
  ss.toast('Ensuring Config data exists...', 'ğŸŒ± Seeding', 2);
  seedConfigData();  // seedConfigData now only populates EMPTY columns

  // Now get all config values (will have data from seedConfigData or user's existing data)
  var jobTitles = getConfigValues(configSheet, CONFIG_COLS.JOB_TITLES);
  var locations = getConfigValues(configSheet, CONFIG_COLS.OFFICE_LOCATIONS);
  var units = getConfigValues(configSheet, CONFIG_COLS.UNITS);
  var supervisors = getConfigValues(configSheet, CONFIG_COLS.SUPERVISORS);
  var managers = getConfigValues(configSheet, CONFIG_COLS.MANAGERS);
  var stewards = getConfigValues(configSheet, CONFIG_COLS.STEWARDS);
  var homeTowns = getConfigValues(configSheet, CONFIG_COLS.HOME_TOWNS);
  var committees = getConfigValues(configSheet, CONFIG_COLS.STEWARD_COMMITTEES);

  // Grievance config
  var statuses = DEFAULT_CONFIG.GRIEVANCE_STATUS;
  var resolutions = DEFAULT_CONFIG.GRIEVANCE_RESOLUTION;
  var steps = DEFAULT_CONFIG.GRIEVANCE_STEP;
  var categories = DEFAULT_CONFIG.ISSUE_CATEGORY;
  var articles = DEFAULT_CONFIG.ARTICLES;

  // Expanded name pools for better variety
  var firstNames = [
    'James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda', 'William', 'Elizabeth',
    'David', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica', 'Thomas', 'Sarah', 'Charles', 'Karen',
    'Christopher', 'Nancy', 'Daniel', 'Lisa', 'Matthew', 'Betty', 'Anthony', 'Margaret', 'Mark', 'Sandra',
    'Donald', 'Ashley', 'Steven', 'Kimberly', 'Paul', 'Emily', 'Andrew', 'Donna', 'Joshua', 'Michelle',
    'Kenneth', 'Dorothy', 'Kevin', 'Carol', 'Brian', 'Amanda', 'George', 'Melissa', 'Timothy', 'Deborah',
    'Ronald', 'Stephanie', 'Edward', 'Rebecca', 'Jason', 'Sharon', 'Jeffrey', 'Laura', 'Ryan', 'Cynthia',
    'Jacob', 'Kathleen', 'Gary', 'Amy', 'Nicholas', 'Angela', 'Eric', 'Shirley', 'Jonathan', 'Anna',
    'Stephen', 'Brenda', 'Larry', 'Pamela', 'Justin', 'Emma', 'Scott', 'Nicole', 'Brandon', 'Helen',
    'Benjamin', 'Samantha', 'Samuel', 'Katherine', 'Raymond', 'Christine', 'Gregory', 'Debra', 'Frank', 'Rachel',
    'Alexander', 'Carolyn', 'Patrick', 'Janet', 'Jack', 'Catherine', 'Dennis', 'Maria', 'Jerry', 'Heather',
    'Tyler', 'Diane', 'Aaron', 'Ruth', 'Jose', 'Julie', 'Adam', 'Olivia', 'Nathan', 'Joyce',
    'Henry', 'Virginia', 'Douglas', 'Victoria', 'Zachary', 'Kelly', 'Peter', 'Lauren', 'Kyle', 'Christina'
  ];
  var lastNames = [
    'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez',
    'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin',
    'Lee', 'Perez', 'Thompson', 'White', 'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson',
    'Walker', 'Young', 'Allen', 'King', 'Wright', 'Scott', 'Torres', 'Nguyen', 'Hill', 'Flores',
    'Green', 'Adams', 'Nelson', 'Baker', 'Hall', 'Rivera', 'Campbell', 'Mitchell', 'Carter', 'Roberts',
    'Gomez', 'Phillips', 'Evans', 'Turner', 'Diaz', 'Parker', 'Cruz', 'Edwards', 'Collins', 'Reyes',
    'Stewart', 'Morris', 'Morales', 'Murphy', 'Cook', 'Rogers', 'Gutierrez', 'Ortiz', 'Morgan', 'Cooper',
    'Peterson', 'Bailey', 'Reed', 'Kelly', 'Howard', 'Ramos', 'Kim', 'Cox', 'Ward', 'Richardson',
    'Watson', 'Brooks', 'Chavez', 'Wood', 'James', 'Bennett', 'Gray', 'Mendoza', 'Ruiz', 'Hughes',
    'Price', 'Alvarez', 'Castillo', 'Sanders', 'Patel', 'Myers', 'Long', 'Ross', 'Foster', 'Jimenez',
    'Powell', 'Jenkins', 'Perry', 'Russell', 'Sullivan', 'Bell', 'Coleman', 'Butler', 'Henderson', 'Barnes',
    'Gonzales', 'Fisher', 'Vasquez', 'Simmons', 'Stokes', 'Burns', 'Fox', 'Alexander', 'Rice', 'Stone'
  ];
  var officeDays = DEFAULT_CONFIG.OFFICE_DAYS;
  var commMethods = DEFAULT_CONFIG.COMM_METHODS;

  var memberStartRow = Math.max(memberSheet.getLastRow() + 1, 2);
  var grievanceStartRow = Math.max(grievanceSheet.getLastRow() + 1, 2);

  // Build set of existing IDs to prevent duplicates
  var existingMemberIds = {};
  var existingGrievanceIds = {};
  if (memberStartRow > 2) {
    var existingMemberData = memberSheet.getRange(2, MEMBER_COLS.MEMBER_ID, memberStartRow - 2, 1).getValues();
    for (var e = 0; e < existingMemberData.length; e++) {
      if (existingMemberData[e][0]) existingMemberIds[existingMemberData[e][0]] = true;
    }
  }
  if (grievanceStartRow > 2) {
    var existingGrievanceData = grievanceSheet.getRange(2, GRIEVANCE_COLS.GRIEVANCE_ID, grievanceStartRow - 2, 1).getValues();
    for (var g = 0; g < existingGrievanceData.length; g++) {
      if (existingGrievanceData[g][0]) existingGrievanceIds[existingGrievanceData[g][0]] = true;
    }
  }

  var memberRows = [];
  var grievanceRows = [];
  var seededMemberIds = [];
  var seededGrievanceIds = [];
  var batchSize = 50;
  var today = new Date();
  var grievanceCount = 0;

  for (var i = 0; i < count; i++) {
    var firstName = randomChoice(firstNames);
    var lastName = randomChoice(lastNames);
    var memberId = generateNameBasedId('M', firstName, lastName, existingMemberIds);
    existingMemberIds[memberId] = true;
    seededMemberIds.push(memberId);

    var memberLocation = randomChoice(locations);
    var memberUnit = randomChoice(units);
    var assignedSteward = randomChoice(stewards);
    var email = firstName.toLowerCase() + '.' + lastName.toLowerCase() + '.' + memberId.toLowerCase() + '@example.org';
    var phone = '617-555-' + String(Math.floor(Math.random() * 9000) + 1000);
    var isSteward = Math.random() < 0.1 ? 'Yes' : 'No';

    // Generate recent contact data (50% chance)
    var hasRecentContact = Math.random() < 0.5;
    var recentContactDate = hasRecentContact ? randomDate(new Date(today.getTime() - 60 * 24 * 60 * 60 * 1000), today) : '';
    var contactSteward = hasRecentContact ? assignedSteward : '';

    // Sample contact notes for members who have been contacted
    var sampleContactNotes = [
      'Discussed workload concerns',
      'Follow up on scheduling issue',
      'Interested in becoming steward',
      'Addressed safety complaint',
      'Positive feedback received',
      'Needs info on benefits',
      'Question about contract language',
      'Planning to attend next meeting',
      'Grievance update provided',
      'Initial outreach - new member',
      'Discussed upcoming negotiations',
      'Shared resources on workplace rights',
      'Scheduling meeting for next week'
    ];
    var contactNotes = hasRecentContact ? randomChoice(sampleContactNotes) : '';

    var memberRow = generateSingleMemberRow(
      memberId, firstName, lastName,
      randomChoice(jobTitles),
      memberLocation,
      memberUnit,
      randomChoice(officeDays),
      email, phone,
      randomChoice(commMethods),
      'Morning',
      randomChoice(supervisors),
      randomChoice(managers),
      isSteward,
      isSteward === 'Yes' ? randomChoice(committees) : '',
      assignedSteward,
      randomChoice(homeTowns),
      recentContactDate,
      contactSteward,
      contactNotes
    );
    memberRows.push(memberRow);

    // Create grievance for this member based on percentage
    if (Math.random() * 100 < grievancePercent) {
      var grievanceId = generateNameBasedId('G', firstName, lastName, existingGrievanceIds);
      existingGrievanceIds[grievanceId] = true;
      seededGrievanceIds.push(grievanceId);

      var incidentDate = randomDate(new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000), today);
      var status = randomChoice(statuses);
      var step = randomChoice(steps);
      var resolution = (status === 'Closed') ? randomChoice(resolutions) : '';

      var grievanceRow = generateSingleGrievanceRow(
        grievanceId,
        memberId,
        firstName,
        lastName,
        status,
        step,
        incidentDate,
        randomChoice(articles),
        randomChoice(categories),
        email,
        memberUnit,
        memberLocation,
        assignedSteward,
        resolution
      );
      grievanceRows.push(grievanceRow);
      grievanceCount++;
    }

    // Write members in batches
    if (memberRows.length >= batchSize || i === count - 1) {
      memberSheet.getRange(memberStartRow, 1, memberRows.length, 31).setValues(memberRows);
      memberStartRow += memberRows.length;
      memberRows = [];
      Utilities.sleep(50);
    }

    // Write grievances in batches
    if (grievanceRows.length >= batchSize || i === count - 1) {
      if (grievanceRows.length > 0) {
        grievanceSheet.getRange(grievanceStartRow, 1, grievanceRows.length, 34).setValues(grievanceRows);
        grievanceStartRow += grievanceRows.length;
        grievanceRows = [];
        Utilities.sleep(50);
      }
    }
  }

  // Re-apply checkboxes
  var memberLastRow = memberSheet.getLastRow();
  if (memberLastRow >= 2) {
    memberSheet.getRange(2, MEMBER_COLS.START_GRIEVANCE, memberLastRow - 1, 1).insertCheckboxes();
  }
  var grievanceLastRow = grievanceSheet.getLastRow();
  if (grievanceLastRow >= 2) {
    grievanceSheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ALERT, grievanceLastRow - 1, 1).insertCheckboxes();
  }

  // Sync data (FormulasToLog must run FIRST to populate calculated columns)
  syncGrievanceFormulasToLog();
  syncGrievanceToMemberDirectory();

  // Sort grievances by status and resolution
  sortGrievanceLogByStatus();

  // Track seeded IDs for cleanup
  trackSeededMemberIdsBatch(seededMemberIds);
  trackSeededGrievanceIdsBatch(seededGrievanceIds);

  SpreadsheetApp.getActiveSpreadsheet().toast(count + ' members + ' + grievanceCount + ' grievances seeded!', 'âœ… Success', 3);
}

/**
 * Generate a single member row with all 31 columns
 * @param {string} memberId - Member ID
 * @param {string} firstName - First name
 * @param {string} lastName - Last name
 * @param {string} jobTitle - Job title
 * @param {string} location - Work location
 * @param {string} unit - Unit
 * @param {string} officeDays - Office days
 * @param {string} email - Email
 * @param {string} phone - Phone
 * @param {string} prefComm - Preferred communication
 * @param {string} bestTime - Best time to contact
 * @param {string} supervisor - Supervisor
 * @param {string} manager - Manager
 * @param {string} isSteward - Is steward (Yes/No)
 * @param {string} committees - Committees
 * @param {string} assignedSteward - Assigned steward
 * @param {string} homeTown - Home town
 * @param {Date|string} recentContactDate - Recent contact date
 * @param {string} contactSteward - Steward who made contact
 */
function generateSingleMemberRow(memberId, firstName, lastName, jobTitle, location, unit, officeDays, email, phone, prefComm, bestTime, supervisor, manager, isSteward, committees, assignedSteward, homeTown, recentContactDate, contactSteward, contactNotes) {
  var today = new Date();
  var lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

  return [
    memberId,                                    // 1: Member ID (A)
    firstName,                                   // 2: First Name (B)
    lastName,                                    // 3: Last Name (C)
    jobTitle,                                    // 4: Job Title (D)
    location,                                    // 5: Work Location (E)
    unit,                                        // 6: Unit (F)
    officeDays,                                  // 7: Office Days (G)
    email,                                       // 8: Email (H)
    phone,                                       // 9: Phone (I)
    prefComm,                                    // 10: Preferred Communication (J)
    bestTime,                                    // 11: Best Time (K)
    supervisor,                                  // 12: Supervisor (L)
    manager,                                     // 13: Manager (M)
    isSteward,                                   // 14: Is Steward (N)
    committees,                                  // 15: Committees (O)
    assignedSteward,                             // 16: Assigned Steward (P)
    randomDate(lastMonth, today),                // 17: Last Virtual Mtg (Q)
    randomDate(lastMonth, today),                // 18: Last In-Person Mtg (R)
    Math.floor(Math.random() * 100),             // 19: Open Rate % (S)
    Math.floor(Math.random() * 20),              // 20: Volunteer Hours (T)
    Math.random() < 0.3 ? 'Yes' : 'No',          // 21: Interest Local (U)
    Math.random() < 0.2 ? 'Yes' : 'No',          // 22: Interest Chapter (V)
    Math.random() < 0.1 ? 'Yes' : 'No',          // 23: Interest Allied (W)
    homeTown || '',                              // 24: Home Town (X)
    recentContactDate || '',                     // 25: Recent Contact Date (Y)
    contactSteward || '',                        // 26: Contact Steward (Z)
    contactNotes || '',                          // 27: Contact Notes (AA) - seeded if contacted
    '',                                          // 28: Has Open Grievance (AB) - auto-calculated from Grievance Log
    '',                                          // 29: Grievance Status (AC) - auto-calculated from Grievance Log
    '',                                          // 30: Next Deadline (AD) - auto-calculated from Grievance Log
    false                                        // 31: Start Grievance (AE) - checkbox (re-applied after setValues)
  ];
}

// SEED_GRIEVANCES removed - grievances are now seeded as part of SEED_MEMBERS

/**
 * Generate a single grievance row with all 34 columns
 * Properly calculates all timeline fields based on grievance step progression
 * @param {string} resolution - Resolution (only for Closed status)
 */
function generateSingleGrievanceRow(grievanceId, memberId, firstName, lastName, status, step, incidentDate, articles, category, email, unit, location, steward, resolution) {
  var today = new Date();
  var filingDeadline = addDays(incidentDate, 21);

  // Date Filed - always set if status is not brand new
  var dateFiled = addDays(incidentDate, Math.floor(Math.random() * 14) + 1);

  // Step I Due (30 days after filing)
  var step1Due = dateFiled ? addDays(dateFiled, 30) : '';

  // Initialize timeline variables
  var step1Rcvd = '';
  var step2AppealDue = '';
  var step2AppealFiled = '';
  var step2Due = '';
  var step2Rcvd = '';
  var step3AppealDue = '';
  var step3AppealFiled = '';
  var dateClosed = '';

  // Determine if case is closed (includes Settled, Withdrawn, Denied, Won, Closed)
  var closedStatuses = ['Settled', 'Withdrawn', 'Denied', 'Won', 'Closed'];
  var isClosed = closedStatuses.indexOf(status) !== -1;

  // Populate timeline based on current step
  var stepIndex = ['Informal', 'Step I', 'Step II', 'Step III', 'Mediation', 'Arbitration'].indexOf(step);

  // If Step I or beyond, Step I has been completed
  if (stepIndex >= 1 || isClosed) {
    // Step I Decision Received (sometime after Step I Due or earlier)
    step1Rcvd = addDays(step1Due, Math.floor(Math.random() * 10) - 5);
    if (step1Rcvd < dateFiled) step1Rcvd = addDays(dateFiled, 15);

    // Step II Appeal Due (10 days after Step I Decision Received)
    step2AppealDue = addDays(step1Rcvd, 10);
  }

  // If Step II or beyond
  if (stepIndex >= 2 || (isClosed && stepIndex >= 1)) {
    // Step II Appeal Filed (within appeal window)
    step2AppealFiled = addDays(step1Rcvd, Math.floor(Math.random() * 8) + 1);

    // Step II Decision Due (30 days after appeal filed)
    step2Due = addDays(step2AppealFiled, 30);

    // Step II Decision Received
    step2Rcvd = addDays(step2Due, Math.floor(Math.random() * 10) - 5);
    if (step2Rcvd < step2AppealFiled) step2Rcvd = addDays(step2AppealFiled, 15);

    // Step III Appeal Due (30 days after Step II Decision Received)
    step3AppealDue = addDays(step2Rcvd, 30);
  }

  // If Step III or beyond
  if (stepIndex >= 3 || (isClosed && stepIndex >= 2)) {
    // Step III Appeal Filed
    step3AppealFiled = addDays(step2Rcvd, Math.floor(Math.random() * 20) + 1);
  }

  // Set date closed for resolved cases
  if (isClosed) {
    var lastDate = step3AppealFiled || step2Rcvd || step1Rcvd || dateFiled;
    dateClosed = addDays(lastDate, Math.floor(Math.random() * 30) + 5);
  }

  // Calculate Days Open
  var daysOpen = '';
  if (dateFiled) {
    var endDate = dateClosed || today;
    daysOpen = Math.floor((endDate - dateFiled) / (1000 * 60 * 60 * 24));
  }

  // Calculate Next Action Due based on current step
  var nextActionDue = '';
  if (!isClosed) {
    switch (step) {
      case 'Informal':
        nextActionDue = filingDeadline;
        break;
      case 'Step I':
        nextActionDue = step1Due || filingDeadline;
        break;
      case 'Step II':
        nextActionDue = step2Due || step2AppealDue || step1Due;
        break;
      case 'Step III':
      case 'Mediation':
      case 'Arbitration':
        nextActionDue = step3AppealDue || step2Due;
        break;
    }
  }

  // Calculate Days to Deadline
  var daysToDeadline = '';
  if (nextActionDue && !isClosed) {
    daysToDeadline = Math.floor((nextActionDue - today) / (1000 * 60 * 60 * 24));
  }

  // Use passed resolution parameter (only set for Closed status)
  resolution = resolution || '';

  return [
    grievanceId,              // 1: Grievance ID (A)
    memberId,                 // 2: Member ID (B)
    firstName,                // 3: First Name (C)
    lastName,                 // 4: Last Name (D)
    status,                   // 5: Status (E)
    step,                     // 6: Current Step (F)
    incidentDate,             // 7: Incident Date (G)
    filingDeadline,           // 8: Filing Deadline (H)
    dateFiled,                // 9: Date Filed (I)
    step1Due,                 // 10: Step I Due (J)
    step1Rcvd,                // 11: Step I Rcvd (K)
    step2AppealDue,           // 12: Step II Appeal Due (L)
    step2AppealFiled,         // 13: Step II Appeal Filed (M)
    step2Due,                 // 14: Step II Due (N)
    step2Rcvd,                // 15: Step II Rcvd (O)
    step3AppealDue,           // 16: Step III Appeal Due (P)
    step3AppealFiled,         // 17: Step III Appeal Filed (Q)
    dateClosed,               // 18: Date Closed (R)
    daysOpen,                 // 19: Days Open (S)
    nextActionDue,            // 20: Next Action Due (T)
    daysToDeadline,           // 21: Days to Deadline (U)
    articles,                 // 22: Articles Violated (V)
    category,                 // 23: Issue Category (W)
    email,                    // 24: Member Email (X)
    unit,                     // 25: Unit (Y)
    location,                 // 26: Location (Z)
    steward,                  // 27: Steward (AA)
    resolution,               // 28: Resolution (AB)
    false,                    // 29: Message Alert (AC) - checkbox
    '',                       // 30: Coordinator Message (AD)
    '',                       // 31: Acknowledged By (AE)
    '',                       // 32: Acknowledged Date (AF)
    '',                       // 33: Drive Folder ID (AG)
    ''                        // 34: Drive Folder URL (AH)
  ];
}

// ============================================================================
// DIALOG FUNCTIONS
// ============================================================================

/**
 * Show dialog to seed custom number of members (with grievances)
 */
function SEED_MEMBERS_DIALOG() {
  var ui = SpreadsheetApp.getUi();
  var response = ui.prompt(
    'ğŸ‘¥ Seed Members & Grievances',
    'How many members to seed? (30% will get grievances)\nMax 2000:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var count = parseInt(response.getResponseText(), 10);
    if (isNaN(count) || count < 1) {
      ui.alert('Please enter a valid number.');
      return;
    }
    SEED_MEMBERS(count);
  }
}

/**
 * Show dialog to seed with custom grievance percentage
 */
function SEED_MEMBERS_ADVANCED_DIALOG() {
  var ui = SpreadsheetApp.getUi();

  var countResponse = ui.prompt(
    'ğŸ‘¥ Seed Members (Step 1/2)',
    'How many members to seed? (max 2000):',
    ui.ButtonSet.OK_CANCEL
  );

  if (countResponse.getSelectedButton() !== ui.Button.OK) return;

  var count = parseInt(countResponse.getResponseText(), 10);
  if (isNaN(count) || count < 1) {
    ui.alert('Please enter a valid number.');
    return;
  }

  var percentResponse = ui.prompt(
    'ğŸ“‹ Grievance Percentage (Step 2/2)',
    'What percentage of members should have grievances? (0-100, default 30):',
    ui.ButtonSet.OK_CANCEL
  );

  if (percentResponse.getSelectedButton() !== ui.Button.OK) return;

  var percent = parseInt(percentResponse.getResponseText(), 10);
  if (isNaN(percent)) percent = 30;
  percent = Math.max(0, Math.min(100, percent));

  SEED_MEMBERS(count, percent);
}

/**
 * Seed 50 members shortcut (no auto-grievances, matching Code.gs/SeedNuke.gs)
 */
function seed50Members() {
  SEED_MEMBERS(50, 0);
}

/**
 * Seed 25 grievances shortcut
 */
function seed25Grievances() {
  SEED_GRIEVANCES(25);
}

/**
 * Prompt for grievance count to seed
 */
function SEED_GRIEVANCES_DIALOG() {
  var ui = SpreadsheetApp.getUi();
  var response = ui.prompt(
    'Seed Grievances',
    'How many grievances to seed? (max 300)',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    var count = parseInt(response.getResponseText(), 10);
    if (isNaN(count) || count < 1) {
      ui.alert('Please enter a valid number.');
      return;
    }
    SEED_GRIEVANCES(count);
  }
}

/**
 * Seed grievances for existing members
 * Creates grievances linked to random existing members
 */
function SEED_GRIEVANCES(count) {
  count = Math.min(count || 25, 300);

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!grievanceSheet || !memberSheet || !configSheet) {
    SpreadsheetApp.getUi().alert('Error: Required sheets not found.');
    return;
  }

  // Get members
  var memberData = memberSheet.getDataRange().getValues();
  if (memberData.length < 2) {
    SpreadsheetApp.getUi().alert('Error: No members found. Please seed members first.');
    return;
  }

  ss.toast('Seeding ' + count + ' grievances...', 'Seeding', 3);

  var statuses = DEFAULT_CONFIG.GRIEVANCE_STATUS;
  var steps = DEFAULT_CONFIG.GRIEVANCE_STEP;
  var categories = DEFAULT_CONFIG.ISSUE_CATEGORY;
  var articles = DEFAULT_CONFIG.ARTICLES;
  var resolutions = ['Won - Full remedy', 'Won - Partial remedy', 'Settled', 'Denied', 'Withdrawn'];

  // Get config values for stewards
  var stewards = getConfigValues(configSheet, CONFIG_COLS.STEWARDS);
  if (stewards.length === 0) stewards = ['Steward'];

  var startRow = Math.max(grievanceSheet.getLastRow() + 1, 2);

  // Build set of existing grievance IDs
  var existingGrievanceIds = {};
  if (startRow > 2) {
    var existingData = grievanceSheet.getRange(2, GRIEVANCE_COLS.GRIEVANCE_ID, startRow - 2, 1).getValues();
    for (var e = 0; e < existingData.length; e++) {
      if (existingData[e][0]) {
        existingGrievanceIds[existingData[e][0]] = true;
      }
    }
  }

  var rows = [];
  var seededIds = [];
  var batchSize = 25;
  var today = new Date();

  // Create shuffled list of member indices (excluding header row)
  var memberIndices = [];
  for (var m = 1; m < memberData.length; m++) {
    if (memberData[m][MEMBER_COLS.MEMBER_ID - 1]) {
      memberIndices.push(m);
    }
  }

  // Check if we found any valid members
  if (memberIndices.length === 0) {
    SpreadsheetApp.getUi().alert('Error: No members with valid Member IDs found. Please seed members first.');
    return;
  }

  var shuffledMembers = shuffleArray(memberIndices);
  var memberIndex = 0;

  for (var i = 0; i < count; i++) {
    // Use shuffled members - cycle through if more grievances than members
    if (memberIndex >= shuffledMembers.length) {
      shuffledMembers = shuffleArray(memberIndices);
      memberIndex = 0;
    }
    var memberRow = memberData[shuffledMembers[memberIndex]];
    memberIndex++;

    var memberId = memberRow[MEMBER_COLS.MEMBER_ID - 1];
    if (!memberId) continue;

    var firstName = memberRow[MEMBER_COLS.FIRST_NAME - 1] || '';
    var lastName = memberRow[MEMBER_COLS.LAST_NAME - 1] || '';
    var memberEmail = memberRow[MEMBER_COLS.EMAIL - 1] || '';
    var memberUnit = memberRow[MEMBER_COLS.UNIT - 1] || '';
    var memberLocation = memberRow[MEMBER_COLS.WORK_LOCATION - 1] || '';
    var memberSteward = memberRow[MEMBER_COLS.ASSIGNED_STEWARD - 1] || randomChoice(stewards);

    var grievanceId = generateNameBasedId('G', firstName, lastName, existingGrievanceIds);
    existingGrievanceIds[grievanceId] = true;
    seededIds.push(grievanceId);

    var incidentDate = randomDate(new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000), today);
    var status = randomChoice(statuses);
    var step = randomChoice(steps);
    var resolution = (status === 'Closed' || status === 'Settled' || status === 'Denied' || status === 'Won')
      ? randomChoice(resolutions) : '';

    var row = generateSingleGrievanceRow(
      grievanceId,
      memberId,
      firstName,
      lastName,
      status,
      step,
      incidentDate,
      randomChoice(articles),
      randomChoice(categories),
      memberEmail,
      memberUnit,
      memberLocation,
      memberSteward,
      resolution
    );

    rows.push(row);

    // Write in batches
    if (rows.length >= batchSize || i === count - 1) {
      grievanceSheet.getRange(startRow, 1, rows.length, 34).setValues(rows);
      startRow += rows.length;
      rows = [];
      Utilities.sleep(100);
    }
  }

  // Re-apply checkboxes to Message Alert column
  var lastRow = grievanceSheet.getLastRow();
  if (lastRow >= 2) {
    grievanceSheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ALERT, lastRow - 1, 1).insertCheckboxes();
  }

  // Sync data from hidden formulas sheet
  syncGrievanceFormulasToLog();

  // Track seeded IDs
  trackSeededGrievanceIdsBatch(seededIds);

  ss.toast(count + ' grievances seeded!', 'Success', 3);
}

// ============================================================================
// NUKE FUNCTIONS
// ============================================================================

/**
 * Delete all seeded data from Member Directory and Grievance Log
 * Uses pattern matching (M/G + 4 letters + 3 digits) to identify seeded IDs
 * This is more reliable than Script Properties tracking which has size limits
 */
function NUKE_SEEDED_DATA() {
  var ui = SpreadsheetApp.getUi();
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // Check if already disabled
  if (isDemoModeDisabled()) {
    ui.alert('Demo Mode Disabled', 'Demo mode has already been disabled. The Demo menu will be removed on next refresh.', ui.ButtonSet.OK);
    return;
  }

  // Pattern for seeded IDs: M/G + 4 uppercase letters + 3 digits (e.g., MJOSM123, GJOSM456)
  var seededIdPattern = /^[MG][A-Z]{4}\d{3}$/;

  // Count seeded data by pattern
  var memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  var grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  var memberCount = 0;
  var grievanceCount = 0;

  if (memberSheet && memberSheet.getLastRow() > 1) {
    var memberIds = memberSheet.getRange(2, 1, memberSheet.getLastRow() - 1, 1).getValues();
    memberIds.forEach(function(row) {
      if (row[0] && seededIdPattern.test(String(row[0]))) memberCount++;
    });
  }

  if (grievanceSheet && grievanceSheet.getLastRow() > 1) {
    var grievanceIds = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 1).getValues();
    grievanceIds.forEach(function(row) {
      if (row[0] && seededIdPattern.test(String(row[0]))) grievanceCount++;
    });
  }

  var response = ui.alert(
    'â˜¢ï¸ NUKE SEEDED DATA',
    'âš ï¸ This will permanently delete seeded/demo data:\n\n' +
    'â€¢ ' + memberCount + ' seeded members (ID pattern: M****###)\n' +
    'â€¢ ' + grievanceCount + ' seeded grievances (ID pattern: G****###)\n' +
    'â€¢ Config dropdown values\n\n' +
    'âœ… Manually entered data with different ID formats will be PRESERVED.\n\n' +
    'âš ï¸ After nuke, the Demo menu will be permanently disabled.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  // Double confirm
  var response2 = ui.alert(
    'â˜¢ï¸ FINAL CONFIRMATION',
    'This will:\n' +
    '1. Delete ' + memberCount + ' seeded members\n' +
    '2. Delete ' + grievanceCount + ' seeded grievances\n' +
    '3. Permanently disable the Demo menu\n\n' +
    'Are you sure?',
    ui.ButtonSet.YES_NO
  );

  if (response2 !== ui.Button.YES) {
    return;
  }

  ss.toast('Nuking seeded data...', 'â˜¢ï¸ NUKE', 3);

  try {
    var deletedMembers = 0;
    var deletedGrievances = 0;

    // Delete seeded grievances first (they reference members)
    if (grievanceSheet && grievanceSheet.getLastRow() > 1) {
      var grievanceData = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 1).getValues();
      // Delete from bottom up to preserve row indices
      for (var g = grievanceData.length - 1; g >= 0; g--) {
        var gId = String(grievanceData[g][0] || '');
        if (seededIdPattern.test(gId)) {
          grievanceSheet.deleteRow(g + 2);
          deletedGrievances++;
        }
      }
    }

    // Delete seeded members
    if (memberSheet && memberSheet.getLastRow() > 1) {
      var memberData = memberSheet.getRange(2, 1, memberSheet.getLastRow() - 1, 1).getValues();
      // Delete from bottom up to preserve row indices
      for (var m = memberData.length - 1; m >= 0; m--) {
        var mId = String(memberData[m][0] || '');
        if (seededIdPattern.test(mId)) {
          memberSheet.deleteRow(m + 2);
          deletedMembers++;
        }
      }
    }

    // Clear Config dropdowns (keep headers and default values)
    NUKE_CONFIG_DROPDOWNS();

    // Clear tracked IDs from Script Properties
    var props = PropertiesService.getScriptProperties();
    props.deleteProperty('SEEDED_MEMBER_IDS');
    props.deleteProperty('SEEDED_GRIEVANCE_IDS');

    // Disable demo mode permanently
    disableDemoMode();

    ss.toast('Seeded data nuked! Demo mode disabled.', 'â˜¢ï¸ Complete', 5);
    ui.alert('â˜¢ï¸ Complete',
      'Seeded data has been deleted:\n' +
      'â€¢ ' + deletedMembers + ' members removed\n' +
      'â€¢ ' + deletedGrievances + ' grievances removed\n\n' +
      'Demo mode has been permanently disabled.\n' +
      'Refresh the page to remove the Demo menu.',
      ui.ButtonSet.OK);

  } catch (error) {
    Logger.log('Error in NUKE_SEEDED_DATA: ' + error.message);
    ui.alert('âŒ Error', 'Nuke failed: ' + error.message, ui.ButtonSet.OK);
  }
}

/**
 * Clear only Config dropdown values (user-populated columns)
 */
function NUKE_CONFIG_DROPDOWNS() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!sheet) {
    return;
  }

  // Clear user-populated columns only (keep system defaults)
  var userColumns = [
    CONFIG_COLS.JOB_TITLES,
    CONFIG_COLS.OFFICE_LOCATIONS,
    CONFIG_COLS.UNITS,
    CONFIG_COLS.SUPERVISORS,
    CONFIG_COLS.MANAGERS,
    CONFIG_COLS.STEWARDS,
    CONFIG_COLS.STEWARD_COMMITTEES,
    CONFIG_COLS.GRIEVANCE_COORDINATORS,
    CONFIG_COLS.HOME_TOWNS
  ];

  userColumns.forEach(function(col) {
    var lastRow = sheet.getLastRow();
    if (lastRow > 2) {
      sheet.getRange(3, col, lastRow - 2, 1).clear();
    }
  });

  SpreadsheetApp.getActiveSpreadsheet().toast('Config dropdowns cleared!', 'ğŸ§¹ Cleared', 3);
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
// Note: getConfigValues is defined earlier in this file (line ~2090)

/**
 * Get random element from array
 */
function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/**
 * Shuffle array using Fisher-Yates algorithm
 * Returns a new shuffled array (does not modify original)
 */
function shuffleArray(arr) {
  var shuffled = arr.slice(); // Create a copy
  for (var i = shuffled.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var temp = shuffled[i];
    shuffled[i] = shuffled[j];
    shuffled[j] = temp;
  }
  return shuffled;
}

/**
 * Get random date between two dates
 */
function randomDate(start, end) {
  var startTime = start.getTime();
  var endTime = end.getTime();
  var randomTime = startTime + Math.random() * (endTime - startTime);
  return new Date(randomTime);
}

/**
 * Add days to a date
 */
function addDays(date, days) {
  if (!date) return '';
  var result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}



// ============================================================================
// TESTING FRAMEWORK & VALIDATION
// ============================================================================

var TEST_RESULTS = { passed: [], failed: [], skipped: [] };
var TEST_MAX_EXECUTION_MS = 5 * 60 * 1000;
var TEST_LARGE_DATASET_THRESHOLD = 5000;

var Assert = {
  assertEquals: function(expected, actual, message) {
    if (expected !== actual) throw new Error((message || 'Assertion failed') + '\nExpected: ' + JSON.stringify(expected) + '\nActual: ' + JSON.stringify(actual));
  },
  assertTrue: function(value, message) {
    if (value !== true) throw new Error((message || 'Expected true') + '\nActual: ' + value);
  },
  assertFalse: function(value, message) {
    if (value !== false) throw new Error((message || 'Expected false') + '\nActual: ' + value);
  },
  assertNotNull: function(value, message) {
    if (value === null || value === undefined) throw new Error(message || 'Value should not be null/undefined');
  },
  assertNull: function(value, message) {
    if (value !== null) throw new Error((message || 'Expected null') + '\nActual: ' + value);
  },
  assertContains: function(array, value, message) {
    if (!Array.isArray(array) || array.indexOf(value) === -1) throw new Error((message || 'Array does not contain value') + '\nValue: ' + value);
  },
  assertArrayLength: function(array, expectedLength, message) {
    if (!Array.isArray(array) || array.length !== expectedLength) throw new Error((message || 'Array length mismatch') + '\nExpected: ' + expectedLength + '\nActual: ' + (array ? array.length : 'N/A'));
  },
  assertThrows: function(fn, message) {
    var threw = false;
    try { fn(); } catch (e) { threw = true; }
    if (!threw) throw new Error(message || 'Expected function to throw');
  },
  assertApproximately: function(expected, actual, tolerance, message) {
    tolerance = tolerance || 0.001;
    if (Math.abs(expected - actual) > tolerance) throw new Error((message || 'Values not approximately equal') + '\nExpected: ' + expected + '\nActual: ' + actual);
  },
  fail: function(message) { throw new Error(message || 'Test failed'); }
};

function isLargeDataset() {
  try {
    var ss = SpreadsheetApp.getActive();
    var memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
    return memberDir ? memberDir.getLastRow() > TEST_LARGE_DATASET_THRESHOLD : false;
  } catch (e) { return false; }
}

function testMemberColsConstants() {
  Assert.assertNotNull(MEMBER_COLS, 'MEMBER_COLS should exist');
  Assert.assertEquals(1, MEMBER_COLS.MEMBER_ID, 'MEMBER_ID should be column 1');
  Assert.assertEquals(2, MEMBER_COLS.FIRST_NAME, 'FIRST_NAME should be column 2');
  Assert.assertEquals(3, MEMBER_COLS.LAST_NAME, 'LAST_NAME should be column 3');
  Assert.assertEquals(8, MEMBER_COLS.EMAIL, 'EMAIL should be column 8');
  Assert.assertEquals(31, MEMBER_COLS.START_GRIEVANCE, 'START_GRIEVANCE should be column 31');
}

function testGrievanceColsConstants() {
  Assert.assertNotNull(GRIEVANCE_COLS, 'GRIEVANCE_COLS should exist');
  Assert.assertEquals(1, GRIEVANCE_COLS.GRIEVANCE_ID, 'GRIEVANCE_ID should be column 1');
  Assert.assertEquals(2, GRIEVANCE_COLS.MEMBER_ID, 'MEMBER_ID should be column 2');
  Assert.assertEquals(5, GRIEVANCE_COLS.STATUS, 'STATUS should be column 5');
  Assert.assertEquals(28, GRIEVANCE_COLS.RESOLUTION, 'RESOLUTION should be column 28');
}

function testColumnLetterConversion() {
  Assert.assertEquals('A', getColumnLetter(1), 'Column 1 should be A');
  Assert.assertEquals('Z', getColumnLetter(26), 'Column 26 should be Z');
  Assert.assertEquals('AA', getColumnLetter(27), 'Column 27 should be AA');
  Assert.assertEquals('AE', getColumnLetter(31), 'Column 31 should be AE');
}

function testSheetsConstants() {
  Assert.assertNotNull(SHEETS, 'SHEETS should exist');
  Assert.assertNotNull(SHEETS.MEMBER_DIR, 'MEMBER_DIR should exist');
  Assert.assertNotNull(SHEETS.GRIEVANCE_LOG, 'GRIEVANCE_LOG should exist');
  Assert.assertNotNull(SHEETS.CONFIG, 'CONFIG should exist');
}

function testValidateRequired() {
  Assert.assertThrows(function() { validateRequired(null, 'field'); }, 'null should throw');
  Assert.assertThrows(function() { validateRequired('', 'field'); }, 'empty should throw');
  Assert.assertThrows(function() { validateRequired(undefined, 'field'); }, 'undefined should throw');
}

function testValidateEmail() {
  var result1 = validateEmailAddress('test@example.com');
  Assert.assertTrue(result1.valid, 'Valid email should pass');
  var result2 = validateEmailAddress('invalid');
  Assert.assertFalse(result2.valid, 'Invalid email should fail');
  var result3 = validateEmailAddress('');
  Assert.assertFalse(result3.valid, 'Empty email should fail');
}

function testValidatePhoneNumber() {
  var result1 = validatePhoneNumber('(555) 123-4567');
  Assert.assertTrue(result1.valid, 'Valid phone should pass');
  var result2 = validatePhoneNumber('5551234567');
  Assert.assertTrue(result2.valid, 'Digits-only phone should pass');
  var result3 = validatePhoneNumber('123');
  Assert.assertFalse(result3.valid, 'Short phone should fail');
}

function testOpenRateRange() {
  Assert.assertTrue(85 >= 0 && 85 <= 100, 'Open rate 85 should be in range');
  Assert.assertTrue(0 >= 0 && 0 <= 100, 'Open rate 0 should be in range');
  Assert.assertTrue(100 >= 0 && 100 <= 100, 'Open rate 100 should be in range');
}

function getTestFunctionRegistry() {
  return {
    testMemberColsConstants: testMemberColsConstants,
    testGrievanceColsConstants: testGrievanceColsConstants,
    testColumnLetterConversion: testColumnLetterConversion,
    testSheetsConstants: testSheetsConstants,
    testValidateRequired: testValidateRequired,
    testValidateEmail: testValidateEmail,
    testValidatePhoneNumber: testValidatePhoneNumber,
    testOpenRateRange: testOpenRateRange
  };
}

function runAllTests() {
  var ui = SpreadsheetApp.getUi();
  SpreadsheetApp.getActive().toast('ğŸ§ª Running tests...', 'Testing', -1);
  TEST_RESULTS = { passed: [], failed: [], skipped: [] };
  var startTime = new Date();
  var registry = getTestFunctionRegistry();
  var testNames = Object.keys(registry);
  testNames.forEach(function(name) {
    if (new Date() - startTime > TEST_MAX_EXECUTION_MS) {
      TEST_RESULTS.skipped.push({ name: name, reason: 'Timeout protection' });
      return;
    }
    try {
      registry[name]();
      TEST_RESULTS.passed.push({ name: name, time: new Date() - startTime });
    } catch (e) {
      TEST_RESULTS.failed.push({ name: name, error: e.message });
    }
  });
  var duration = (new Date() - startTime) / 1000;
  generateTestReport(duration);
  var total = TEST_RESULTS.passed.length + TEST_RESULTS.failed.length + TEST_RESULTS.skipped.length;
  var rate = ((TEST_RESULTS.passed.length / total) * 100).toFixed(1);
  SpreadsheetApp.getActive().toast('âœ… ' + TEST_RESULTS.passed.length + ' | âŒ ' + TEST_RESULTS.failed.length + ' | â­ï¸ ' + TEST_RESULTS.skipped.length, 'Tests (' + rate + '%)', 10);
  ui.alert('ğŸ§ª Tests Complete', 'Passed: ' + TEST_RESULTS.passed.length + '\nFailed: ' + TEST_RESULTS.failed.length + '\nSkipped: ' + TEST_RESULTS.skipped.length + '\n\nDuration: ' + duration.toFixed(2) + 's', ui.ButtonSet.OK);
}

function runQuickTests() {
  var ui = SpreadsheetApp.getUi();
  SpreadsheetApp.getActive().toast('âš¡ Quick tests...', 'Testing', -1);
  TEST_RESULTS = { passed: [], failed: [], skipped: [] };
  var startTime = new Date();
  var quickTests = ['testMemberColsConstants', 'testGrievanceColsConstants', 'testColumnLetterConversion', 'testSheetsConstants', 'testOpenRateRange'];
  var registry = getTestFunctionRegistry();
  quickTests.forEach(function(name) {
    try {
      if (registry[name]) { registry[name](); TEST_RESULTS.passed.push({ name: name }); }
      else TEST_RESULTS.skipped.push({ name: name, reason: 'Not found' });
    } catch (e) { TEST_RESULTS.failed.push({ name: name, error: e.message }); }
  });
  var duration = (new Date() - startTime) / 1000;
  ui.alert('âš¡ Quick Tests', 'Passed: ' + TEST_RESULTS.passed.length + '\nFailed: ' + TEST_RESULTS.failed.length + '\nDuration: ' + duration.toFixed(2) + 's' + (TEST_RESULTS.failed.length > 0 ? '\n\nFailed:\n' + TEST_RESULTS.failed.map(function(t) { return 'â€¢ ' + t.name + ': ' + t.error; }).join('\n') : ''), ui.ButtonSet.OK);
}

function generateTestReport(duration) {
  var ss = SpreadsheetApp.getActive();
  var report = ss.getSheetByName(SHEETS.TEST_RESULTS);
  if (!report) report = ss.insertSheet(SHEETS.TEST_RESULTS);
  report.clear();
  report.getRange('A1:F1').merge().setValue('ğŸ§ª TEST RESULTS').setFontSize(18).setFontWeight('bold').setBackground('#4A5568').setFontColor('#FFFFFF');
  var total = TEST_RESULTS.passed.length + TEST_RESULTS.failed.length + TEST_RESULTS.skipped.length;
  var rate = ((TEST_RESULTS.passed.length / total) * 100).toFixed(1);
  var summary = [['Total Tests', total], ['âœ… Passed', TEST_RESULTS.passed.length], ['âŒ Failed', TEST_RESULTS.failed.length], ['â­ï¸ Skipped', TEST_RESULTS.skipped.length], ['Pass Rate', rate + '%'], ['Duration', duration.toFixed(2) + 's'], ['Timestamp', new Date().toLocaleString()]];
  report.getRange(3, 1, summary.length, 2).setValues(summary);
  report.getRange(3, 1, summary.length, 1).setFontWeight('bold');
  var row = 3 + summary.length + 2;
  if (TEST_RESULTS.failed.length > 0) {
    report.getRange(row, 1, 1, 3).merge().setValue('âŒ FAILED TESTS').setFontWeight('bold').setBackground('#FEE2E2');
    row++;
    report.getRange(row, 1, 1, 2).setValues([['Test Name', 'Error']]).setFontWeight('bold').setBackground('#F3F4F6');
    row++;
    TEST_RESULTS.failed.forEach(function(test) { report.getRange(row, 1, 1, 2).setValues([[test.name, test.error]]); row++; });
    row += 2;
  }
  if (TEST_RESULTS.passed.length > 0) {
    report.getRange(row, 1, 1, 2).merge().setValue('âœ… PASSED TESTS').setFontWeight('bold').setBackground('#D1FAE5');
    row++;
    TEST_RESULTS.passed.forEach(function(test) { report.getRange(row, 1).setValue(test.name + ' âœ“'); row++; });
  }
  report.autoResizeColumns(1, 3);
  report.setTabColor('#7C3AED');
}

// ==================== VALIDATION FRAMEWORK ====================

var VALIDATION_PATTERNS = {
  EMAIL: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
  PHONE_US: /^[\+]?1?[-.\s]?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}$/,
  MEMBER_ID: /^M[A-Z]{4}\d{3}$/,
  GRIEVANCE_ID: /^G[A-Z]{4}\d{3}$/
};

var VALIDATION_MESSAGES = {
  EMAIL_INVALID: 'Invalid email format. Use: name@domain.com',
  EMAIL_EMPTY: 'Email address is required',
  PHONE_INVALID: 'Invalid phone format. Use: (555) 555-1234',
  MEMBER_ID_INVALID: 'Invalid Member ID format',
  GRIEVANCE_ID_INVALID: 'Invalid Grievance ID format'
};

function validateEmailAddress(email) {
  if (!email || email.toString().trim() === '') return { valid: false, message: VALIDATION_MESSAGES.EMAIL_EMPTY };
  var clean = email.toString().trim().toLowerCase();
  if (!VALIDATION_PATTERNS.EMAIL.test(clean)) return { valid: false, message: VALIDATION_MESSAGES.EMAIL_INVALID };
  return { valid: true, message: 'Valid email' };
}

function validatePhoneNumber(phone) {
  if (!phone || phone.toString().trim() === '') return { valid: false, message: 'Phone required' };
  var digits = phone.toString().replace(/\D/g, '');
  if (digits.length < 10) return { valid: false, message: 'At least 10 digits required' };
  if (digits.length > 15) return { valid: false, message: 'Phone too long' };
  var formatted = formatUSPhone(digits);
  return { valid: true, message: 'Valid phone', formatted: formatted };
}

function formatUSPhone(digits) {
  if (digits.length === 11 && digits[0] === '1') digits = digits.substring(1);
  if (digits.length === 10) return '(' + digits.substring(0, 3) + ') ' + digits.substring(3, 6) + '-' + digits.substring(6);
  return digits;
}

function validateRequired(value, fieldName) {
  if (value === null || value === undefined || value === '') throw new Error(fieldName + ' is required');
  return value;
}

function runBulkValidation() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (!sheet) { SpreadsheetApp.getUi().alert('Member Directory not found!'); return; }
  ss.toast('Running validation...', 'Please wait', -1);
  var lastRow = sheet.getLastRow();
  if (lastRow < 2) { ss.toast('No data', 'Info', 3); return; }
  var emailData = sheet.getRange(2, MEMBER_COLS.EMAIL, lastRow - 1, 1).getValues();
  var phoneData = sheet.getRange(2, MEMBER_COLS.PHONE, lastRow - 1, 1).getValues();
  var memberIdData = sheet.getRange(2, MEMBER_COLS.MEMBER_ID, lastRow - 1, 1).getValues();
  var issues = [], seenIds = {};
  for (var i = 0; i < lastRow - 1; i++) {
    var row = i + 2;
    if (emailData[i][0]) { var er = validateEmailAddress(emailData[i][0]); if (!er.valid) issues.push({ row: row, field: 'Email', value: emailData[i][0], message: er.message }); }
    if (phoneData[i][0]) { var pr = validatePhoneNumber(phoneData[i][0]); if (!pr.valid) issues.push({ row: row, field: 'Phone', value: phoneData[i][0], message: pr.message }); }
    if (memberIdData[i][0]) {
      if (seenIds[memberIdData[i][0]]) issues.push({ row: row, field: 'Member ID', value: memberIdData[i][0], message: 'Duplicate of row ' + seenIds[memberIdData[i][0]] });
      else seenIds[memberIdData[i][0]] = row;
    }
  }
  showValidationReport(issues, lastRow - 1);
}

function showValidationReport(issues, total) {
  var rate = total > 0 ? (((total - issues.length) / total) * 100).toFixed(1) : 100;
  var rows = issues.slice(0, 50).map(function(i) { return '<tr><td>' + i.row + '</td><td>' + i.field + '</td><td>' + i.value + '</td><td>' + i.message + '</td></tr>'; }).join('');
  if (issues.length > 50) rows += '<tr><td colspan="4">...and ' + (issues.length - 50) + ' more</td></tr>';
  var html = HtmlService.createHtmlOutput(
    '<!DOCTYPE html><html><head><base target="_top"><style>body{font-family:Arial;padding:20px}h2{color:#1a73e8}.summary{display:flex;gap:20px;margin:20px 0}.stat{flex:1;padding:20px;border-radius:8px;text-align:center}.stat.good{background:#e8f5e9}.stat.warning{background:#fff3e0}.stat.bad{background:#ffebee}.num{font-size:32px;font-weight:bold}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:10px;text-align:left;border:1px solid #ddd}th{background:#f5f5f5}</style></head><body><h2>ğŸ“Š Validation Report</h2><div class="summary"><div class="stat ' + (issues.length === 0 ? 'good' : issues.length < 10 ? 'warning' : 'bad') + '"><div class="num">' + rate + '%</div><div>Pass Rate</div></div><div class="stat good"><div class="num">' + total + '</div><div>Records</div></div><div class="stat ' + (issues.length === 0 ? 'good' : 'bad') + '"><div class="num">' + issues.length + '</div><div>Issues</div></div></div>' + (issues.length > 0 ? '<table><tr><th>Row</th><th>Field</th><th>Value</th><th>Issue</th></tr>' + rows + '</table>' : '<div style="text-align:center;padding:40px;color:#4caf50">âœ… No issues found!</div>') + '</body></html>'
  ).setWidth(700).setHeight(500);
  SpreadsheetApp.getUi().showModalDialog(html, 'Validation Report');
}

// ============================================================================
// NAVIGATION FUNCTIONS (Menu Items)
// ============================================================================

/**
 * Navigate to the Interactive Dashboard sheet
 */
function showInteractiveDashboardTab() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.INTERACTIVE);
  if (sheet) {
    ss.setActiveSheet(sheet);
    ss.toast('Viewing Interactive Dashboard', 'ğŸ¯ Interactive', 2);
  } else {
    SpreadsheetApp.getUi().alert('Interactive Dashboard not found. Run REPAIR DASHBOARD to create it.');
  }
}

/**
 * Refresh Interactive Dashboard charts and data
 */
function refreshInteractiveCharts() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Refreshing Interactive Dashboard...', 'ğŸ“ˆ Refresh', 2);

  var sheet = ss.getSheetByName(SHEETS.INTERACTIVE);
  if (!sheet) {
    SpreadsheetApp.getUi().alert('Interactive Dashboard not found. Run REPAIR DASHBOARD to create it.');
    return;
  }

  SpreadsheetApp.flush();
  ss.setActiveSheet(sheet);
  ss.toast('Interactive Dashboard refreshed!', 'âœ… Done', 2);
}

/**
 * Show the Web App URL for mobile access
 */
function showWebAppUrl() {
  var ui = SpreadsheetApp.getUi();
  var scriptId = ScriptApp.getScriptId();

  ui.alert('ğŸ“± Mobile App URL',
    'To get your mobile dashboard URL:\n\n' +
    '1. Go to Extensions â†’ Apps Script\n' +
    '2. Click "Deploy" â†’ "Manage deployments"\n' +
    '3. Create a new deployment as "Web app"\n' +
    '4. Set access to your organization\n' +
    '5. Copy the Web app URL\n\n' +
    'Script ID: ' + scriptId + '\n\n' +
    'Bookmark the URL on your mobile device for quick access!',
    ui.ButtonSet.OK);
}

// ============================================================================
// GOOGLE DRIVE INTEGRATION
// ============================================================================

function getOrCreateDashboardFolder_() {
  var folderName = '509 Dashboard - Grievance Files';
  var folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder(folderName);
}

function setupDriveFolderForGrievance() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var ui = SpreadsheetApp.getUi();

  if (sheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert('ğŸ“ Setup Folder', 'Please select a row in the Grievance Log first.', ui.ButtonSet.OK);
    return;
  }

  var row = sheet.getActiveRange().getRow();
  if (row < 2) {
    ui.alert('ğŸ“ Setup Folder', 'Please select a grievance row (not the header).', ui.ButtonSet.OK);
    return;
  }

  var grievanceId = sheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  var memberId = sheet.getRange(row, GRIEVANCE_COLS.MEMBER_ID).getValue();

  if (!grievanceId) {
    ui.alert('ğŸ“ Setup Folder', 'This row has no Grievance ID.', ui.ButtonSet.OK);
    return;
  }

  ss.toast('Creating Drive folder for ' + grievanceId + '...', 'ğŸ“ Drive', 3);

  try {
    var rootFolder = getOrCreateDashboardFolder_();
    var folderName = grievanceId + ' - ' + (memberId || 'Unknown');
    var folders = rootFolder.getFoldersByName(folderName);
    var folder;

    if (folders.hasNext()) {
      folder = folders.next();
      ss.toast('Folder already exists!', 'ğŸ“ Drive', 2);
    } else {
      folder = rootFolder.createFolder(folderName);
      ss.toast('Folder created!', 'âœ… Success', 2);
    }

    sheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_ID).setValue(folder.getId());
    sheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_URL).setValue(folder.getUrl());

    var html = HtmlService.createHtmlOutput('<script>window.open("' + folder.getUrl() + '", "_blank");google.script.host.close();</script>').setWidth(1).setHeight(1);
    ui.showModalDialog(html, 'Opening folder...');
  } catch (e) {
    ui.alert('âŒ Error', 'Failed to create folder: ' + e.message, ui.ButtonSet.OK);
  }
}

function showGrievanceFiles() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getActiveSheet();
  var ui = SpreadsheetApp.getUi();

  if (sheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert('ğŸ“ View Files', 'Please select a row in the Grievance Log first.', ui.ButtonSet.OK);
    return;
  }

  var row = sheet.getActiveRange().getRow();
  if (row < 2) {
    ui.alert('ğŸ“ View Files', 'Please select a grievance row (not the header).', ui.ButtonSet.OK);
    return;
  }

  var folderId = sheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_ID).getValue();
  var folderUrl = sheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_URL).getValue();
  var grievanceId = sheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();

  if (!folderId) {
    var response = ui.alert('ğŸ“ No Folder', 'No folder exists for ' + grievanceId + '.\n\nWould you like to create one?', ui.ButtonSet.YES_NO);
    if (response === ui.Button.YES) setupDriveFolderForGrievance();
    return;
  }

  try {
    var folder = DriveApp.getFolderById(folderId);
    var files = folder.getFiles();
    var fileList = [];
    while (files.hasNext()) fileList.push('â€¢ ' + files.next().getName());

    if (fileList.length === 0) {
      var response = ui.alert('ğŸ“ ' + grievanceId + ' Files', 'Folder is empty.\n\nWould you like to open the folder to add files?', ui.ButtonSet.YES_NO);
      if (response === ui.Button.YES) {
        var html = HtmlService.createHtmlOutput('<script>window.open("' + folderUrl + '", "_blank");google.script.host.close();</script>').setWidth(1).setHeight(1);
        ui.showModalDialog(html, 'Opening folder...');
      }
    } else {
      var response = ui.alert('ğŸ“ ' + grievanceId + ' Files (' + fileList.length + ')', fileList.join('\n') + '\n\nOpen folder in Drive?', ui.ButtonSet.YES_NO);
      if (response === ui.Button.YES) {
        var html = HtmlService.createHtmlOutput('<script>window.open("' + folderUrl + '", "_blank");google.script.host.close();</script>').setWidth(1).setHeight(1);
        ui.showModalDialog(html, 'Opening folder...');
      }
    }
  } catch (e) {
    ui.alert('âŒ Error', 'Could not access folder: ' + e.message, ui.ButtonSet.OK);
  }
}

function batchCreateGrievanceFolders() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) { ui.alert('âŒ Error', 'Grievance Log not found.', ui.ButtonSet.OK); return; }

  var response = ui.alert('ğŸ“ Batch Create Folders', 'This will create Google Drive folders for all grievances that don\'t have one.\n\nContinue?', ui.ButtonSet.YES_NO);
  if (response !== ui.Button.YES) return;

  var data = sheet.getDataRange().getValues();
  var rootFolder = getOrCreateDashboardFolder_();
  var created = 0, skipped = 0;

  ss.toast('Creating folders...', 'ğŸ“ Batch', -1);

  for (var i = 1; i < data.length; i++) {
    var grievanceId = data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1];
    var memberId = data[i][GRIEVANCE_COLS.MEMBER_ID - 1];
    var existingFolderId = data[i][GRIEVANCE_COLS.DRIVE_FOLDER_ID - 1];

    if (!grievanceId) continue;
    if (existingFolderId) { skipped++; continue; }

    var folderName = grievanceId + ' - ' + (memberId || 'Unknown');
    var folder = rootFolder.createFolder(folderName);
    sheet.getRange(i + 1, GRIEVANCE_COLS.DRIVE_FOLDER_ID).setValue(folder.getId());
    sheet.getRange(i + 1, GRIEVANCE_COLS.DRIVE_FOLDER_URL).setValue(folder.getUrl());
    created++;
  }

  ss.toast('Done! Created ' + created + ', skipped ' + skipped, 'âœ… Complete', 5);
  ui.alert('ğŸ“ Batch Complete', 'Created: ' + created + ' new folders\nSkipped: ' + skipped + ' (already had folders)', ui.ButtonSet.OK);
}

// ============================================================================
// GOOGLE CALENDAR INTEGRATION
// ============================================================================

function syncDeadlinesToCalendar() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ui = SpreadsheetApp.getUi();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) { ui.alert('âŒ Error', 'Grievance Log not found.', ui.ButtonSet.OK); return; }

  var response = ui.alert('ğŸ“… Sync to Calendar', 'This will create calendar events for upcoming grievance deadlines.\n\nContinue?', ui.ButtonSet.YES_NO);
  if (response !== ui.Button.YES) return;

  ss.toast('Syncing deadlines to calendar...', 'ğŸ“… Calendar', -1);

  var data = sheet.getDataRange().getValues();
  var calendar = CalendarApp.getDefaultCalendar();
  var created = 0, skipped = 0;
  var today = new Date(); today.setHours(0, 0, 0, 0);
  var closedStatuses = ['Closed', 'Settled', 'Won', 'Denied', 'Withdrawn'];

  for (var i = 1; i < data.length; i++) {
    var grievanceId = data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1];
    var status = data[i][GRIEVANCE_COLS.STATUS - 1];
    var nextActionDue = data[i][GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    var currentStep = data[i][GRIEVANCE_COLS.CURRENT_STEP - 1];

    if (!grievanceId || !nextActionDue) { skipped++; continue; }
    if (closedStatuses.indexOf(status) !== -1) { skipped++; continue; }

    var dueDate = new Date(nextActionDue);
    if (isNaN(dueDate.getTime()) || dueDate < today) { skipped++; continue; }

    var existingEvents = calendar.getEventsForDay(dueDate, {search: grievanceId});
    if (existingEvents.length > 0) { skipped++; continue; }

    calendar.createAllDayEvent('âš ï¸ ' + grievanceId + ' - ' + currentStep + ' Due', dueDate, {
      description: 'Grievance: ' + grievanceId + '\nStatus: ' + status + '\nStep: ' + currentStep + '\n\nCreated by 509 Dashboard'
    });
    created++;
  }

  ss.toast('Done! Created ' + created + ' events', 'âœ… Complete', 5);
  ui.alert('ğŸ“… Sync Complete', 'Created: ' + created + ' calendar events\nSkipped: ' + skipped + ' (closed, past, or already exists)', ui.ButtonSet.OK);
}

function showUpcomingDeadlinesFromCalendar() {
  var ui = SpreadsheetApp.getUi();
  var calendar = CalendarApp.getDefaultCalendar();
  var today = new Date();
  var nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
  var events = calendar.getEvents(today, nextWeek, {search: 'Grievance'});

  if (events.length === 0) {
    ui.alert('ğŸ“… Upcoming Deadlines', 'No grievance deadlines in the next 7 days!\n\nUse "Sync Deadlines to Calendar" to add deadline events.', ui.ButtonSet.OK);
    return;
  }

  var eventList = events.map(function(e) {
    return 'â€¢ ' + Utilities.formatDate(e.getStartTime(), Session.getScriptTimeZone(), 'MM/dd') + ': ' + e.getTitle();
  });
  ui.alert('ğŸ“… Upcoming Deadlines (Next 7 Days)', eventList.join('\n'), ui.ButtonSet.OK);
}

function clearAllCalendarEvents() {
  var ui = SpreadsheetApp.getUi();
  var response = ui.alert('ğŸ—‘ï¸ Clear Calendar Events', 'This will delete ALL calendar events containing "Grievance".\n\nThis cannot be undone. Continue?', ui.ButtonSet.YES_NO);
  if (response !== ui.Button.YES) return;

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  ss.toast('Removing calendar events...', 'ğŸ—‘ï¸ Calendar', -1);

  var calendar = CalendarApp.getDefaultCalendar();
  var events = calendar.getEvents(new Date(Date.now() - 180 * 24 * 60 * 60 * 1000), new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), {search: 'Grievance'});
  var deleted = 0;

  for (var i = 0; i < events.length; i++) { events[i].deleteEvent(); deleted++; }

  ss.toast('Deleted ' + deleted + ' events', 'âœ… Complete', 3);
  ui.alert('ğŸ—‘ï¸ Events Cleared', 'Deleted ' + deleted + ' grievance calendar events.', ui.ButtonSet.OK);
}

// ============================================================================
// EMAIL NOTIFICATIONS
// ============================================================================

function showNotificationSettings() {
  var ui = SpreadsheetApp.getUi();
  var props = PropertiesService.getScriptProperties();
  var enabled = props.getProperty('notifications_enabled') === 'true';
  var email = props.getProperty('notification_email') || Session.getEffectiveUser().getEmail();

  var response = ui.alert('ğŸ“¬ Notification Settings',
    'Daily deadline notifications: ' + (enabled ? 'ENABLED âœ…' : 'DISABLED âŒ') + '\n' +
    'Email: ' + email + '\n\nNotifications are sent daily at 8 AM for grievances due within 3 days.\n\n' +
    'Would you like to ' + (enabled ? 'DISABLE' : 'ENABLE') + ' notifications?',
    ui.ButtonSet.YES_NO);

  if (response === ui.Button.YES) {
    if (enabled) {
      props.setProperty('notifications_enabled', 'false');
      removeDailyTrigger_();
      ui.alert('ğŸ“¬ Notifications Disabled', 'Daily deadline notifications have been turned off.', ui.ButtonSet.OK);
    } else {
      props.setProperty('notifications_enabled', 'true');
      props.setProperty('notification_email', email);
      installDailyTrigger_();
      ui.alert('ğŸ“¬ Notifications Enabled', 'Daily notifications enabled!\n\nEmail: ' + email, ui.ButtonSet.OK);
    }
  }
}

function installDailyTrigger_() {
  removeDailyTrigger_();
  ScriptApp.newTrigger('checkDeadlinesAndNotify_').timeBased().atHour(8).everyDays(1).create();
}

function removeDailyTrigger_() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'checkDeadlinesAndNotify_') ScriptApp.deleteTrigger(triggers[i]);
  }
}

function checkDeadlinesAndNotify_() {
  var props = PropertiesService.getScriptProperties();
  if (props.getProperty('notifications_enabled') !== 'true') return;

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!sheet) return;

  var email = props.getProperty('notification_email');
  if (!email) return;

  var data = sheet.getDataRange().getValues();
  var closedStatuses = ['Closed', 'Settled', 'Won', 'Denied', 'Withdrawn'];
  var urgent = [];

  for (var i = 1; i < data.length; i++) {
    var grievanceId = data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1];
    var status = data[i][GRIEVANCE_COLS.STATUS - 1];
    var daysToDeadline = data[i][GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];
    var currentStep = data[i][GRIEVANCE_COLS.CURRENT_STEP - 1];

    if (closedStatuses.indexOf(status) !== -1) continue;
    if (daysToDeadline !== '' && daysToDeadline <= 3) urgent.push({ id: grievanceId, step: currentStep, days: daysToDeadline });
  }

  if (urgent.length === 0) return;

  var body = 'The following grievances have deadlines within 3 days:\n\n';
  for (var j = 0; j < urgent.length; j++) {
    body += 'â€¢ ' + urgent[j].id + ' (' + urgent[j].step + ') - ' + (urgent[j].days <= 0 ? 'OVERDUE!' : urgent[j].days + ' day(s) remaining') + '\n';
  }
  body += '\n\nView your dashboard: ' + ss.getUrl();

  MailApp.sendEmail(email, 'âš ï¸ 509 Dashboard: ' + urgent.length + ' Grievance Deadline(s) Approaching', body);
}

function testDeadlineNotifications() {
  var ui = SpreadsheetApp.getUi();
  var email = Session.getEffectiveUser().getEmail();

  var response = ui.alert('ğŸ§ª Test Notifications', 'This will send a test notification email to:\n' + email + '\n\nSend test email?', ui.ButtonSet.YES_NO);
  if (response !== ui.Button.YES) return;

  try {
    MailApp.sendEmail(email, 'ğŸ§ª 509 Dashboard Test Notification', 'This is a test notification from your 509 Dashboard.\n\nIf you received this email, notifications are working correctly!\n\nDashboard: ' + SpreadsheetApp.getActiveSpreadsheet().getUrl());
    ui.alert('âœ… Test Sent', 'Test email sent to ' + email + '\n\nCheck your inbox!', ui.ButtonSet.OK);
  } catch (e) {
    ui.alert('âŒ Error', 'Failed to send test email: ' + e.message, ui.ButtonSet.OK);
  }
}
